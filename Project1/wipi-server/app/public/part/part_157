yaWdpbmFsIGltYWdlIFVSTCBmb3Igdmlld2luZy5cbiAgICAgKiBAdHlwZSB7c3RyaW5nIHwgRnVuY3Rpb259XG4gICAgICovXG4gICAgdXJsOiAnc3JjJyxcblxuICAgIC8qKlxuICAgICAqIEV2ZW50IHNob3J0Y3V0cy5cbiAgICAgKiBAdHlwZSB7RnVuY3Rpb259XG4gICAgICovXG4gICAgcmVhZHk6IG51bGwsXG4gICAgc2hvdzogbnVsbCxcbiAgICBzaG93bjogbnVsbCxcbiAgICBoaWRlOiBudWxsLFxuICAgIGhpZGRlbjogbnVsbCxcbiAgICB2aWV3OiBudWxsLFxuICAgIHZpZXdlZDogbnVsbCxcbiAgICBtb3ZlOiBudWxsLFxuICAgIG1vdmVkOiBudWxsLFxuICAgIHJvdGF0ZTogbnVsbCxcbiAgICByb3RhdGVkOiBudWxsLFxuICAgIHNjYWxlOiBudWxsLFxuICAgIHNjYWxlZDogbnVsbCxcbiAgICB6b29tOiBudWxsLFxuICAgIHpvb21lZDogbnVsbCxcbiAgICBwbGF5OiBudWxsLFxuICAgIHN0b3A6IG51bGxcbiAgfTtcblxuICB2YXIgVEVNUExBVEUgPSAnPGRpdiBjbGFzcz1cInZpZXdlci1jb250YWluZXJcIiB0YWJpbmRleD1cIi0xXCIgdG91Y2gtYWN0aW9uPVwibm9uZVwiPicgKyAnPGRpdiBjbGFzcz1cInZpZXdlci1jYW52YXNcIj48L2Rpdj4nICsgJzxkaXYgY2xhc3M9XCJ2aWV3ZXItZm9vdGVyXCI+JyArICc8ZGl2IGNsYXNzPVwidmlld2VyLXRpdGxlXCI+PC9kaXY+JyArICc8ZGl2IGNsYXNzPVwidmlld2VyLXRvb2xiYXJcIj48L2Rpdj4nICsgJzxkaXYgY2xhc3M9XCJ2aWV3ZXItbmF2YmFyXCI+JyArICc8dWwgY2xhc3M9XCJ2aWV3ZXItbGlzdFwiIHJvbGU9XCJuYXZpZ2F0aW9uXCI+PC91bD4nICsgJzwvZGl2PicgKyAnPC9kaXY+JyArICc8ZGl2IGNsYXNzPVwidmlld2VyLXRvb2x0aXBcIiByb2xlPVwiYWxlcnRcIiBhcmlhLWhpZGRlbj1cInRydWVcIj48L2Rpdj4nICsgJzxkaXYgY2xhc3M9XCJ2aWV3ZXItYnV0dG9uXCIgZGF0YS12aWV3ZXItYWN0aW9uPVwibWl4XCIgcm9sZT1cImJ1dHRvblwiPjwvZGl2PicgKyAnPGRpdiBjbGFzcz1cInZpZXdlci1wbGF5ZXJcIj48L2Rpdj4nICsgJzwvZGl2Pic7XG5cbiAgdmFyIElTX0JST1dTRVIgPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygd2luZG93LmRvY3VtZW50ICE9PSAndW5kZWZpbmVkJztcbiAgdmFyIFdJTkRPVyA9IElTX0JST1dTRVIgPyB3aW5kb3cgOiB7fTtcbiAgdmFyIElTX1RPVUNIX0RFVklDRSA9IElTX0JST1dTRVIgJiYgV0lORE9XLmRvY3VtZW50LmRvY3VtZW50RWxlbWVudCA/ICdvbnRvdWNoc3RhcnQnIGluIFdJTkRPVy5kb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgOiBmYWxzZTtcbiAgdmFyIEhBU19QT0lOVEVSX0VWRU5UID0gSVNfQlJPV1NFUiA/ICdQb2ludGVyRXZlbnQnIGluIFdJTkRPVyA6IGZhbHNlO1xuICB2YXIgTkFNRVNQQUNFID0gJ3ZpZXdlcic7IC8vIEFjdGlvbnNcblxuICB2YXIgQUNUSU9OX01PVkUgPSAnbW92ZSc7XG4gIHZhciBBQ1RJT05fU1dJVENIID0gJ3N3aXRjaCc7XG4gIHZhciBBQ1RJT05fWk9PTSA9ICd6b29tJzsgLy8gQ2xhc3Nlc1xuXG4gIHZhciBDTEFTU19BQ1RJVkUgPSBcIlwiLmNvbmNhdChOQU1FU1BBQ0UsIFwiLWFjdGl2ZVwiKTtcbiAgdmFyIENMQVNTX0NMT1NFID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1jbG9zZVwiKTtcbiAgdmFyIENMQVNTX0ZBREUgPSBcIlwiLmNvbmNhdChOQU1FU1BBQ0UsIFwiLWZhZGVcIik7XG4gIHZhciBDTEFTU19GSVhFRCA9IFwiXCIuY29uY2F0KE5BTUVTUEFDRSwgXCItZml4ZWRcIik7XG4gIHZhciBDTEFTU19GVUxMU0NSRUVOID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1mdWxsc2NyZWVuXCIpO1xuICB2YXIgQ0xBU1NfRlVMTFNDUkVFTl9FWElUID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1mdWxsc2NyZWVuLWV4aXRcIik7XG4gIHZhciBDTEFTU19ISURFID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1oaWRlXCIpO1xuICB2YXIgQ0xBU1NfSElERV9NRF9ET1dOID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1oaWRlLW1kLWRvd25cIik7XG4gIHZhciBDTEFTU19ISURFX1NNX0RPV04gPSBcIlwiLmNvbmNhdChOQU1FU1BBQ0UsIFwiLWhpZGUtc20tZG93blwiKTtcbiAgdmFyIENMQVNTX0hJREVfWFNfRE9XTiA9IFwiXCIuY29uY2F0KE5BTUVTUEFDRSwgXCItaGlkZS14cy1kb3duXCIpO1xuICB2YXIgQ0xBU1NfSU4gPSBcIlwiLmNvbmNhdChOQU1FU1BBQ0UsIFwiLWluXCIpO1xuICB2YXIgQ0xBU1NfSU5WSVNJQkxFID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1pbnZpc2libGVcIik7XG4gIHZhciBDTEFTU19MT0FESU5HID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1sb2FkaW5nXCIpO1xuICB2YXIgQ0xBU1NfTU9WRSA9IFwiXCIuY29uY2F0KE5BTUVTUEFDRSwgXCItbW92ZVwiKTtcbiAgdmFyIENMQVNTX09QRU4gPSBcIlwiLmNvbmNhdChOQU1FU1BBQ0UsIFwiLW9wZW5cIik7XG4gIHZhciBDTEFTU19TSE9XID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIi1zaG93XCIpO1xuICB2YXIgQ0xBU1NfVFJBTlNJVElPTiA9IFwiXCIuY29uY2F0KE5BTUVTUEFDRSwgXCItdHJhbnNpdGlvblwiKTsgLy8gTmF0aXZlIGV2ZW50c1xuXG4gIHZhciBFVkVOVF9DTElDSyA9ICdjbGljayc7XG4gIHZhciBFVkVOVF9EQkxDTElDSyA9ICdkYmxjbGljayc7XG4gIHZhciBFVkVOVF9EUkFHX1NUQVJUID0gJ2RyYWdzdGFydCc7XG4gIHZhciBFVkVOVF9GT0NVU0lOID0gJ2ZvY3VzaW4nO1xuICB2YXIgRVZFTlRfS0VZX0RPV04gPSAna2V5ZG93bic7XG4gIHZhciBFVkVOVF9MT0FEID0gJ2xvYWQnO1xuICB2YXIgRVZFTlRfRVJST1IgPSAnZXJyb3InO1xuICB2YXIgRVZFTlRfVE9VQ0hfRU5EID0gSVNfVE9VQ0hfREVWSUNFID8gJ3RvdWNoZW5kIHRvdWNoY2FuY2VsJyA6ICdtb3VzZXVwJztcbiAgdmFyIEVWRU5UX1RPVUNIX01PVkUgPSBJU19UT1VDSF9ERVZJQ0UgPyAndG91Y2htb3ZlJyA6ICdtb3VzZW1vdmUnO1xuICB2YXIgRVZFTlRfVE9VQ0hfU1RBUlQgPSBJU19UT1VDSF9ERVZJQ0UgPyAndG91Y2hzdGFydCcgOiAnbW91c2Vkb3duJztcbiAgdmFyIEVWRU5UX1BPSU5URVJfRE9XTiA9IEhBU19QT0lOVEVSX0VWRU5UID8gJ3BvaW50ZXJkb3duJyA6IEVWRU5UX1RPVUNIX1NUQVJUO1xuICB2YXIgRVZFTlRfUE9JTlRFUl9NT1ZFID0gSEFTX1BPSU5URVJfRVZFTlQgPyAncG9pbnRlcm1vdmUnIDogRVZFTlRfVE9VQ0hfTU9WRTtcbiAgdmFyIEVWRU5UX1BPSU5URVJfVVAgPSBIQVNfUE9JTlRFUl9FVkVOVCA/ICdwb2ludGVydXAgcG9pbnRlcmNhbmNlbCcgOiBFVkVOVF9UT1VDSF9FTkQ7XG4gIHZhciBFVkVOVF9SRVNJWkUgPSAncmVzaXplJztcbiAgdmFyIEVWRU5UX1RSQU5TSVRJT05fRU5EID0gJ3RyYW5zaXRpb25lbmQnO1xuICB2YXIgRVZFTlRfV0hFRUwgPSAnd2hlZWwnOyAvLyBDdXN0b20gZXZlbnRzXG5cbiAgdmFyIEVWRU5UX1JFQURZID0gJ3JlYWR5JztcbiAgdmFyIEVWRU5UX1NIT1cgPSAnc2hvdyc7XG4gIHZhciBFVkVOVF9TSE9XTiA9ICdzaG93bic7XG4gIHZhciBFVkVOVF9ISURFID0gJ2hpZGUnO1xuICB2YXIgRVZFTlRfSElEREVOID0gJ2hpZGRlbic7XG4gIHZhciBFVkVOVF9WSUVXID0gJ3ZpZXcnO1xuICB2YXIgRVZFTlRfVklFV0VEID0gJ3ZpZXdlZCc7XG4gIHZhciBFVkVOVF9NT1ZFID0gJ21vdmUnO1xuICB2YXIgRVZFTlRfTU9WRUQgPSAnbW92ZWQnO1xuICB2YXIgRVZFTlRfUk9UQVRFID0gJ3JvdGF0ZSc7XG4gIHZhciBFVkVOVF9ST1RBVEVEID0gJ3JvdGF0ZWQnO1xuICB2YXIgRVZFTlRfU0NBTEUgPSAnc2NhbGUnO1xuICB2YXIgRVZFTlRfU0NBTEVEID0gJ3NjYWxlZCc7XG4gIHZhciBFVkVOVF9aT09NID0gJ3pvb20nO1xuICB2YXIgRVZFTlRfWk9PTUVEID0gJ3pvb21lZCc7XG4gIHZhciBFVkVOVF9QTEFZID0gJ3BsYXknO1xuICB2YXIgRVZFTlRfU1RPUCA9ICdzdG9wJzsgLy8gRGF0YSBrZXlzXG5cbiAgdmFyIERBVEFfQUNUSU9OID0gXCJcIi5jb25jYXQoTkFNRVNQQUNFLCBcIkFjdGlvblwiKTsgLy8gUmVnRXhwc1xuXG4gIHZhciBSRUdFWFBfU1BBQ0VTID0gL1xcc1xccyovOyAvLyBNaXNjXG5cbiAgdmFyIEJVVFRPTlMgPSBbJ3pvb20taW4nLCAnem9vbS1vdXQnLCAnb25lLXRvLW9uZScsICdyZXNldCcsICdwcmV2JywgJ3BsYXknLCAnbmV4dCcsICdyb3RhdGUtbGVmdCcsICdyb3RhdGUtcmlnaHQnLCAnZmxpcC1ob3Jpem9udGFsJywgJ2ZsaXAtdmVydGljYWwnXTtcblxuICAvKipcbiAgICogQ2hlY2sgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGEgc3RyaW5nLlxuICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGNoZWNrLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGEgc3RyaW5nLCBlbHNlIGBmYWxzZWAuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGlzU3RyaW5nKHZhbHVlKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZyc7XG4gIH1cbiAgLyoqXG4gICAqIENoZWNrIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBub3QgYSBudW1iZXIuXG4gICAqL1xuXG4gIHZhciBpc05hTiA9IE51bWJlci5pc05hTiB8fCBXSU5ET1cuaXNOYU47XG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBudW1iZXIuXG4gICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gY2hlY2suXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBudW1iZXIsIGVsc2UgYGZhbHNlYC5cbiAgICovXG5cbiAgZnVuY3Rpb24gaXNOdW1iZXIodmFsdWUpIHtcbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyAmJiAhaXNOYU4odmFsdWUpO1xuICB9XG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgdW5kZWZpbmVkLlxuICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGNoZWNrLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIHVuZGVmaW5lZCwgZWxzZSBgZmFsc2VgLlxuICAgKi9cblxuICBmdW5jdGlvbiBpc1VuZGVmaW5lZCh2YWx1ZSkge1xuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnO1xuICB9XG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYW4gb2JqZWN0LlxuICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGNoZWNrLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGFuIG9iamVjdCwgZWxzZSBgZmFsc2VgLlxuICAgKi9cblxuICBmdW5jdGlvbiBpc09iamVjdCh2YWx1ZSkge1xuICAgIHJldHVybiBfdHlwZW9mKHZhbHVlKSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgIT09IG51bGw7XG4gIH1cbiAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTtcbiAgLyoqXG4gICAqIENoZWNrIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhIHBsYWluIG9iamVjdC5cbiAgICogQHBhcmFtIHsqfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBjaGVjay5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgYHRydWVgIGlmIHRoZSBnaXZlbiB2YWx1ZSBpcyBhIHBsYWluIG9iamVjdCwgZWxzZSBgZmFsc2VgLlxuICAgKi9cblxuICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7XG4gICAgaWYgKCFpc09iamVjdCh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgdmFyIF9jb25zdHJ1Y3RvciA9IHZhbHVlLmNvbnN0cnVjdG9yO1xuICAgICAgdmFyIHByb3RvdHlwZSA9IF9jb25zdHJ1Y3Rvci5wcm90b3R5cGU7XG4gICAgICByZXR1cm4gX2NvbnN0cnVjdG9yICYmIHByb3RvdHlwZSAmJiBoYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3RvdHlwZSwgJ2lzUHJvdG90eXBlT2YnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICogQ2hlY2sgaWYgdGhlIGdpdmVuIHZhbHVlIGlzIGEgZnVuY3Rpb24uXG4gICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gY2hlY2suXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgZ2l2ZW4gdmFsdWUgaXMgYSBmdW5jdGlvbiwgZWxzZSBgZmFsc2VgLlxuICAgKi9cblxuICBmdW5jdGlvbiBpc0Z1bmN0aW9uKHZhbHVlKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ2Z1bmN0aW9uJztcbiAgfVxuICAvKipcbiAgICogSXRlcmF0ZSB0aGUgZ2l2ZW4gZGF0YS5cbiAgICogQHBhcmFtIHsqfSBkYXRhIC0gVGhlIGRhdGEgdG8gaXRlcmF0ZS5cbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgcHJvY2VzcyBmdW5jdGlvbiBmb3IgZWFjaCBlbGVtZW50LlxuICAgKiBAcmV0dXJucyB7Kn0gVGhlIG9yaWdpbmFsIGRhdGEuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGZvckVhY2goZGF0YSwgY2FsbGJhY2spIHtcbiAgICBpZiAoZGF0YSAmJiBpc0Z1bmN0aW9uKGNhbGxiYWNrKSkge1xuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkgfHwgaXNOdW1iZXIoZGF0YS5sZW5ndGgpXG4gICAgICAvKiBhcnJheS1saWtlICovXG4gICAgICApIHtcbiAgICAgICAgdmFyIGxlbmd0aCA9IGRhdGEubGVuZ3RoO1xuICAgICAgICB2YXIgaTtcblxuICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChkYXRhLCBkYXRhW2ldLCBpLCBkYXRhKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChpc09iamVjdChkYXRhKSkge1xuICAgICAgICBPYmplY3Qua2V5cyhkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICBjYWxsYmFjay5jYWxsKGRhdGEsIGRhdGFba2V5XSwga2V5LCBkYXRhKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbiAgLyoqXG4gICAqIEV4dGVuZCB0aGUgZ2l2ZW4gb2JqZWN0LlxuICAgKiBAcGFyYW0geyp9IG9iaiAtIFRoZSBvYmplY3QgdG8gYmUgZXh0ZW5kZWQuXG4gICAqIEBwYXJhbSB7Kn0gYXJncyAtIFRoZSByZXN0IG9iamVjdHMgd2hpY2ggd2lsbCBiZSBtZXJnZWQgdG8gdGhlIGZpcnN0IG9iamVjdC5cbiAgICogQHJldHVybnMge09iamVjdH0gVGhlIGV4dGVuZGVkIG9iamVjdC5cbiAgICovXG5cbiAgdmFyIGFzc2lnbiA9IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gYXNzaWduKG9iaikge1xuICAgIGZvciAodmFyIF9sZW4gPSBhcmd1bWVudHMubGVuZ3RoLCBhcmdzID0gbmV3IEFycmF5KF9sZW4gPiAxID8gX2xlbiAtIDEgOiAwKSwgX2tleSA9IDE7IF9rZXkgPCBfbGVuOyBfa2V5KyspIHtcbiAgICAgIGFyZ3NbX2tleSAtIDFdID0gYXJndW1lbnRzW19rZXldO1xuICAgIH1cblxuICAgIGlmIChpc09iamVjdChvYmopICYmIGFyZ3MubGVuZ3RoID4gMCkge1xuICAgICAgYXJncy5mb3JFYWNoKGZ1bmN0aW9uIChhcmcpIHtcbiAgICAgICAgaWYgKGlzT2JqZWN0KGFyZykpIHtcbiAgICAgICAgICBPYmplY3Qua2V5cyhhcmcpLmZvckVhY2goZnVuY3Rpb24gKGtleSkge1xuICAgICAgICAgICAgb2JqW2tleV0gPSBhcmdba2V5XTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9iajtcbiAgfTtcbiAgdmFyIFJFR0VYUF9TVUZGSVggPSAvXig/OndpZHRofGhlaWdodHxsZWZ0fHRvcHxtYXJnaW5MZWZ0fG1hcmdpblRvcCkkLztcbiAgLyoqXG4gICAqIEFwcGx5IHN0eWxlcyB0byB0aGUgZ2l2ZW4gZWxlbWVudC5cbiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IC0gVGhlIHRhcmdldCBlbGVtZW50LlxuICAgKiBAcGFyYW0ge09iamVjdH0gc3R5bGVzIC0gVGhlIHN0eWxlcyBmb3IgYXBwbHlpbmcuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIHNldFN0eWxlKGVsZW1lbnQsIHN0eWxlcykge1xuICAgIHZhciBzdHlsZSA9IGVsZW1lbnQuc3R5bGU7XG4gICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uICh2YWx1ZSwgcHJvcGVydHkpIHtcbiAgICAgIGlmIChSRUdFWFBfU1VGRklYLnRlc3QocHJvcGVydHkpICYmIGlzTnVtYmVyKHZhbHVlKSkge1xuICAgICAgICB2YWx1ZSArPSAncHgnO1xuICAgICAgfVxuXG4gICAgICBzdHlsZVtwcm9wZXJ0eV0gPSB2YWx1ZTtcbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICogRXNjYXBlIGEgc3RyaW5nIGZvciB1c2luZyBpbiBIVE1MLlxuICAgKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgLSBUaGUgc3RyaW5nIHRvIGVzY2FwZS5cbiAgICogQHJldHVybnMge1N0cmluZ30gUmV0dXJucyB0aGUgZXNjYXBlZCBzdHJpbmcuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGVzY2FwZUhUTUxFbnRpdGllcyh2YWx1ZSkge1xuICAgIHJldHVybiBpc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZS5yZXBsYWNlKC8mKD8hYW1wO3xxdW90O3wjMzk7fGx0O3xndDspL2csICcmYW1wOycpLnJlcGxhY2UoL1wiL2csICcmcXVvdDsnKS5yZXBsYWNlKC8nL2csICcmIzM5OycpLnJlcGxhY2UoLzwvZywgJyZsdDsnKS5yZXBsYWNlKC8+L2csICcmZ3Q7JykgOiB2YWx1ZTtcbiAgfVxuICAvKipcbiAgICogQ2hlY2sgaWYgdGhlIGdpdmVuIGVsZW1lbnQgaGFzIGEgc3BlY2lhbCBjbGFzcy5cbiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IC0gVGhlIGVsZW1lbnQgdG8gY2hlY2suXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBjbGFzcyB0byBzZWFyY2guXG4gICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgc3BlY2lhbCBjbGFzcyB3YXMgZm91bmQuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGhhc0NsYXNzKGVsZW1lbnQsIHZhbHVlKSB7XG4gICAgaWYgKCFlbGVtZW50IHx8ICF2YWx1ZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiBlbGVtZW50LmNsYXNzTGlzdCA/IGVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKHZhbHVlKSA6IGVsZW1lbnQuY2xhc3NOYW1lLmluZGV4T2YodmFsdWUpID4gLTE7XG4gIH1cbiAgLyoqXG4gICAqIEFkZCBjbGFzc2VzIHRvIHRoZSBnaXZlbiBlbGVtZW50LlxuICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgLSBUaGUgdGFyZ2V0IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBjbGFzc2VzIHRvIGJlIGFkZGVkLlxuICAgKi9cblxuICBmdW5jdGlvbiBhZGRDbGFzcyhlbGVtZW50LCB2YWx1ZSkge1xuICAgIGlmICghZWxlbWVudCB8fCAhdmFsdWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNOdW1iZXIoZWxlbWVudC5sZW5ndGgpKSB7XG4gICAgICBmb3JFYWNoKGVsZW1lbnQsIGZ1bmN0aW9uIChlbGVtKSB7XG4gICAgICAgIGFkZENsYXNzKGVsZW0sIHZhbHVlKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChlbGVtZW50LmNsYXNzTGlzdCkge1xuICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKHZhbHVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpO1xuXG4gICAgaWYgKCFjbGFzc05hbWUpIHtcbiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gdmFsdWU7XG4gICAgfSBlbHNlIGlmIChjbGFzc05hbWUuaW5kZXhPZih2YWx1ZSkgPCAwKSB7XG4gICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IFwiXCIuY29uY2F0KGNsYXNzTmFtZSwgXCIgXCIpLmNvbmNhdCh2YWx1ZSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBSZW1vdmUgY2xhc3NlcyBmcm9tIHRoZSBnaXZlbiBlbGVtZW50LlxuICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgLSBUaGUgdGFyZ2V0IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBjbGFzc2VzIHRvIGJlIHJlbW92ZWQuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIHJlbW92ZUNsYXNzKGVsZW1lbnQsIHZhbHVlKSB7XG4gICAgaWYgKCFlbGVtZW50IHx8ICF2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc051bWJlcihlbGVtZW50Lmxlbmd0aCkpIHtcbiAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW0pIHtcbiAgICAgICAgcmVtb3ZlQ2xhc3MoZWxlbSwgdmFsdWUpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGVsZW1lbnQuY2xhc3NMaXN0KSB7XG4gICAgICBlbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUodmFsdWUpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChlbGVtZW50LmNsYXNzTmFtZS5pbmRleE9mKHZhbHVlKSA+PSAwKSB7XG4gICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UodmFsdWUsICcnKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIEFkZCBvciByZW1vdmUgY2xhc3NlcyBmcm9tIHRoZSBnaXZlbiBlbGVtZW50LlxuICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgLSBUaGUgdGFyZ2V0IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBjbGFzc2VzIHRvIGJlIHRvZ2dsZWQuXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gYWRkZWQgLSBBZGQgb25seS5cbiAgICovXG5cbiAgZnVuY3Rpb24gdG9nZ2xlQ2xhc3MoZWxlbWVudCwgdmFsdWUsIGFkZGVkKSB7XG4gICAgaWYgKCF2YWx1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChpc051bWJlcihlbGVtZW50Lmxlbmd0aCkpIHtcbiAgICAgIGZvckVhY2goZWxlbWVudCwgZnVuY3Rpb24gKGVsZW0pIHtcbiAgICAgICAgdG9nZ2xlQ2xhc3MoZWxlbSwgdmFsdWUsIGFkZGVkKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH0gLy8gSUUxMC0xMSBkb2Vzbid0IHN1cHBvcnQgdGhlIHNlY29uZCBwYXJhbWV0ZXIgb2YgYGNsYXNzTGlzdC50b2dnbGVgXG5cblxuICAgIGlmIChhZGRlZCkge1xuICAgICAgYWRkQ2xhc3MoZWxlbWVudCwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZW1vdmVDbGFzcyhlbGVtZW50LCB2YWx1ZSk7XG4gICAgfVxuICB9XG4gIHZhciBSRUdFWFBfSFlQSEVOQVRFID0gLyhbYS16XFxkXSkoW0EtWl0pL2c7XG4gIC8qKlxuICAgKiBUcmFuc2Zvcm0gdGhlIGdpdmVuIHN0cmluZyBmcm9tIGNhbWVsQ2FzZSB0byBrZWJhYi1jYXNlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byB0cmFuc2Zvcm0uXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSB0cmFuc2Zvcm1lZCB2YWx1ZS5cbiAgICovXG5cbiAgZnVuY3Rpb24gaHlwaGVuYXRlKHZhbHVlKSB7XG4gICAgcmV0dXJuIHZhbHVlLnJlcGxhY2UoUkVHRVhQX0hZUEhFTkFURSwgJyQxLSQyJykudG9Mb3dlckNhc2UoKTtcbiAgfVxuICAvKipcbiAgICogR2V0IGRhdGEgZnJvbSB0aGUgZ2l2ZW4gZWxlbWVudC5cbiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IC0gVGhlIHRhcmdldCBlbGVtZW50LlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBkYXRhIGtleSB0byBnZXQuXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBkYXRhIHZhbHVlLlxuICAgKi9cblxuICBmdW5jdGlvbiBnZXREYXRhKGVsZW1lbnQsIG5hbWUpIHtcbiAgICBpZiAoaXNPYmplY3QoZWxlbWVudFtuYW1lXSkpIHtcbiAgICAgIHJldHVybiBlbGVtZW50W25hbWVdO1xuICAgIH1cblxuICAgIGlmIChlbGVtZW50LmRhdGFzZXQpIHtcbiAgICAgIHJldHVybiBlbGVtZW50LmRhdGFzZXRbbmFtZV07XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsZW1lbnQuZ2V0QXR0cmlidXRlKFwiZGF0YS1cIi5jb25jYXQoaHlwaGVuYXRlKG5hbWUpKSk7XG4gIH1cbiAgLyoqXG4gICAqIFNldCBkYXRhIHRvIHRoZSBnaXZlbiBlbGVtZW50LlxuICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgLSBUaGUgdGFyZ2V0IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIGRhdGEga2V5IHRvIHNldC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGRhdGEgLSBUaGUgZGF0YSB2YWx1ZS5cbiAgICovXG5cbiAgZnVuY3Rpb24gc2V0RGF0YShlbGVtZW50LCBuYW1lLCBkYXRhKSB7XG4gICAgaWYgKGlzT2JqZWN0KGRhdGEpKSB7XG4gICAgICBlbGVtZW50W25hbWVdID0gZGF0YTtcbiAgICB9IGVsc2UgaWYgKGVsZW1lbnQuZGF0YXNldCkge1xuICAgICAgZWxlbWVudC5kYXRhc2V0W25hbWVdID0gZGF0YTtcbiAgICB9IGVsc2Uge1xuICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoXCJkYXRhLVwiLmNvbmNhdChoeXBoZW5hdGUobmFtZSkpLCBkYXRhKTtcbiAgICB9XG4gIH1cblxuICB2YXIgb25jZVN1cHBvcnRlZCA9IGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgc3VwcG9ydGVkID0gZmFsc2U7XG5cbiAgICBpZiAoSVNfQlJPV1NFUikge1xuICAgICAgdmFyIG9uY2UgPSBmYWxzZTtcblxuICAgICAgdmFyIGxpc3RlbmVyID0gZnVuY3Rpb24gbGlzdGVuZXIoKSB7fTtcblxuICAgICAgdmFyIG9wdGlvbnMgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkoe30sICdvbmNlJywge1xuICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHtcbiAgICAgICAgICBzdXBwb3J0ZWQgPSB0cnVlO1xuICAgICAgICAgIHJldHVybiBvbmNlO1xuICAgICAgICB9LFxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUaGlzIHNldHRlciBjYW4gZml4IGEgYFR5cGVFcnJvcmAgaW4gc3RyaWN0IG1vZGVcbiAgICAgICAgICoge0BsaW5rIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0phdmFTY3JpcHQvUmVmZXJlbmNlL0Vycm9ycy9HZXR0ZXJfb25seX1cbiAgICAgICAgICogQHBhcmFtIHtib29sZWFufSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBzZXRcbiAgICAgICAgICovXG4gICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlKSB7XG4gICAgICAgICAgb25jZSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIFdJTkRPVy5hZGRFdmVudExpc3RlbmVyKCd0ZXN0JywgbGlzdGVuZXIsIG9wdGlvbnMpO1xuICAgICAgV0lORE9XLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Rlc3QnLCBsaXN0ZW5lciwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN1cHBvcnRlZDtcbiAgfSgpO1xuICAvKipcbiAgICogUmVtb3ZlIGV2ZW50IGxpc3RlbmVyIGZyb20gdGhlIHRhcmdldCBlbGVtZW50LlxuICAgKiBAcGFyYW0ge0VsZW1lbnR9IGVsZW1lbnQgLSBUaGUgZXZlbnQgdGFyZ2V0LlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIFRoZSBldmVudCB0eXBlKHMpLlxuICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFRoZSBldmVudCBsaXN0ZW5lci5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgZXZlbnQgb3B0aW9ucy5cbiAgICovXG5cblxuICBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihlbGVtZW50LCB0eXBlLCBsaXN0ZW5lcikge1xuICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgYXJndW1lbnRzWzNdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbM10gOiB7fTtcbiAgICB2YXIgaGFuZGxlciA9IGxpc3RlbmVyO1xuICAgIHR5cGUudHJpbSgpLnNwbGl0KFJFR0VYUF9TUEFDRVMpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBpZiAoIW9uY2VTdXBwb3J0ZWQpIHtcbiAgICAgICAgdmFyIGxpc3RlbmVycyA9IGVsZW1lbnQubGlzdGVuZXJzO1xuXG4gICAgICAgIGlmIChsaXN0ZW5lcnMgJiYgbGlzdGVuZXJzW2V2ZW50XSAmJiBsaXN0ZW5lcnNbZXZlbnRdW2xpc3RlbmVyXSkge1xuICAgICAgICAgIGhhbmRsZXIgPSBsaXN0ZW5lcnNbZXZlbnRdW2xpc3RlbmVyXTtcbiAgICAgICAgICBkZWxldGUgbGlzdGVuZXJzW2V2ZW50XVtsaXN0ZW5lcl07XG5cbiAgICAgICAgICBpZiAoT2JqZWN0LmtleXMobGlzdGVuZXJzW2V2ZW50XSkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBkZWxldGUgbGlzdGVuZXJzW2V2ZW50XTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoT2JqZWN0LmtleXMobGlzdGVuZXJzKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGRlbGV0ZSBlbGVtZW50Lmxpc3RlbmVycztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50LCBoYW5kbGVyLCBvcHRpb25zKTtcbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICogQWRkIGV2ZW50IGxpc3RlbmVyIHRvIHRoZSB0YXJnZXQgZWxlbWVudC5cbiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IC0gVGhlIGV2ZW50IHRhcmdldC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUgLSBUaGUgZXZlbnQgdHlwZShzKS5cbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gbGlzdGVuZXIgLSBUaGUgZXZlbnQgbGlzdGVuZXIuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIGV2ZW50IG9wdGlvbnMuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGFkZExpc3RlbmVyKGVsZW1lbnQsIHR5cGUsIGxpc3RlbmVyKSB7XG4gICAgdmFyIG9wdGlvbnMgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiBhcmd1bWVudHNbM10gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1szXSA6IHt9O1xuICAgIHZhciBfaGFuZGxlciA9IGxpc3RlbmVyO1xuICAgIHR5cGUudHJpbSgpLnNwbGl0KFJFR0VYUF9TUEFDRVMpLmZvckVhY2goZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICBpZiAob3B0aW9ucy5vbmNlICYmICFvbmNlU3VwcG9ydGVkKSB7XG4gICAgICAgIHZhciBfZWxlbWVudCRsaXN0ZW5lcnMgPSBlbGVtZW50Lmxpc3RlbmVycyxcbiAgICAgICAgICAgIGxpc3RlbmVycyA9IF9lbGVtZW50JGxpc3RlbmVycyA9PT0gdm9pZCAwID8ge30gOiBfZWxlbWVudCRsaXN0ZW5lcnM7XG5cbiAgICAgICAgX2hhbmRsZXIgPSBmdW5jdGlvbiBoYW5kbGVyKCkge1xuICAgICAgICAgIGRlbGV0ZSBsaXN0ZW5lcnNbZXZlbnRdW2xpc3RlbmVyXTtcbiAgICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnQsIF9oYW5kbGVyLCBvcHRpb25zKTtcblxuICAgICAgICAgIGZvciAodmFyIF9sZW4yID0gYXJndW1lbnRzLmxlbmd0aCwgYXJncyA9IG5ldyBBcnJheShfbGVuMiksIF9rZXkyID0gMDsgX2tleTIgPCBfbGVuMjsgX2tleTIrKykge1xuICAgICAgICAgICAgYXJnc1tfa2V5Ml0gPSBhcmd1bWVudHNbX2tleTJdO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGxpc3RlbmVyLmFwcGx5KGVsZW1lbnQsIGFyZ3MpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmICghbGlzdGVuZXJzW2V2ZW50XSkge1xuICAgICAgICAgIGxpc3RlbmVyc1tldmVudF0gPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChsaXN0ZW5lcnNbZXZlbnRdW2xpc3RlbmVyXSkge1xuICAgICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgbGlzdGVuZXJzW2V2ZW50XVtsaXN0ZW5lcl0sIG9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGlzdGVuZXJzW2V2ZW50XVtsaXN0ZW5lcl0gPSBfaGFuZGxlcjtcbiAgICAgICAgZWxlbWVudC5saXN0ZW5lcnMgPSBsaXN0ZW5lcnM7XG4gICAgICB9XG5cbiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihldmVudCwgX2hhbmRsZXIsIG9wdGlvbnMpO1xuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiBEaXNwYXRjaCBldmVudCBvbiB0aGUgdGFyZ2V0IGVsZW1lbnQuXG4gICAqIEBwYXJhbSB7RWxlbWVudH0gZWxlbWVudCAtIFRoZSBldmVudCB0YXJnZXQuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIGV2ZW50IHR5cGUocykuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIC0gVGhlIGFkZGl0aW9uYWwgZXZlbnQgZGF0YS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMgLSBUaGUgYWRkaXRpb25hbCBldmVudCBvcHRpb25zLlxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gSW5kaWNhdGUgaWYgdGhlIGV2ZW50IGlzIGRlZmF1bHQgcHJldmVudGVkIG9yIG5vdC5cbiAgICovXG5cbiAgZnVuY3Rpb24gZGlzcGF0Y2hFdmVudChlbGVtZW50LCB0eXBlLCBkYXRhLCBvcHRpb25zKSB7XG4gICAgdmFyIGV2ZW50OyAvLyBFdmVudCBhbmQgQ3VzdG9tRXZlbnQgb24gSUU5LTExIGFyZSBnbG9iYWwgb2JqZWN0cywgbm90IGNvbnN0cnVjdG9yc1xuXG4gICAgaWYgKGlzRnVuY3Rpb24oRXZlbnQpICYmIGlzRnVuY3Rpb24oQ3VzdG9tRXZlbnQpKSB7XG4gICAgICBldmVudCA9IG5ldyBDdXN0b21FdmVudCh0eXBlLCBfb2JqZWN0U3ByZWFkMih7XG4gICAgICAgIGJ1YmJsZXM6IHRydWUsXG4gICAgICAgIGNhbmNlbGFibGU6IHRydWUsXG4gICAgICAgIGRldGFpbDogZGF0YVxuICAgICAgfSwgb3B0aW9ucykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpO1xuICAgICAgZXZlbnQuaW5pdEN1c3RvbUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGRhdGEpO1xuICAgIH1cblxuICAgIHJldHVybiBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpO1xuICB9XG4gIC8qKlxuICAgKiBHZXQgdGhlIG9mZnNldCBiYXNlIG9uIHRoZSBkb2N1bWVudC5cbiAgICogQHBhcmFtIHtFbGVtZW50fSBlbGVtZW50IC0gVGhlIHRhcmdldCBlbGVtZW50LlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgb2Zmc2V0IGRhdGEuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGdldE9mZnNldChlbGVtZW50KSB7XG4gICAgdmFyIGJveCA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxlZnQ6IGJveC5sZWZ0ICsgKHdpbmRvdy5wYWdlWE9mZnNldCAtIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRMZWZ0KSxcbiAgICAgIHRvcDogYm94LnRvcCArICh3aW5kb3cucGFnZVlPZmZzZXQgLSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50VG9wKVxuICAgIH07XG4gIH1cbiAgLyoqXG4gICAqIEdldCB0cmFuc2Zvcm1zIGJhc2Ugb24gdGhlIGdpdmVuIG9iamVjdC5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9iaiAtIFRoZSB0YXJnZXQgb2JqZWN0LlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyBjb250YWlucyB0cmFuc2Zvcm0gdmFsdWVzLlxuICAgKi9cblxuICBmdW5jdGlvbiBnZXRUcmFuc2Zvcm1zKF9yZWYpIHtcbiAgICB2YXIgcm90YXRlID0gX3JlZi5yb3RhdGUsXG4gICAgICAgIHNjYWxlWCA9IF9yZWYuc2NhbGVYLFxuICAgICAgICBzY2FsZVkgPSBfcmVmLnNjYWxlWSxcbiAgICAgICAgdHJhbnNsYXRlWCA9IF9yZWYudHJhbnNsYXRlWCxcbiAgICAgICAgdHJhbnNsYXRlWSA9IF9yZWYudHJhbnNsYXRlWTtcbiAgICB2YXIgdmFsdWVzID0gW107XG5cbiAgICBpZiAoaXNOdW1iZXIodHJhbnNsYXRlWCkgJiYgdHJhbnNsYXRlWCAhPT0gMCkge1xuICAgICAgdmFsdWVzLnB1c2goXCJ0cmFuc2xhdGVYKFwiLmNvbmNhdCh0cmFuc2xhdGVYLCBcInB4KVwiKSk7XG4gICAgfVxuXG4gICAgaWYgKGlzTnVtYmVyKHRyYW5zbGF0ZVkpICYmIHRyYW5zbGF0ZVkgIT09IDApIHtcbiAgICAgIHZhbHVlcy5wdXNoKFwidHJhbnNsYXRlWShcIi5jb25jYXQodHJhbnNsYXRlWSwgXCJweClcIikpO1xuICAgIH0gLy8gUm90YXRlIHNob3VsZCBjb21lIGZpcnN0IGJlZm9yZSBzY2FsZSB0byBtYXRjaCBvcmllbnRhdGlvbiB0cmFuc2Zvcm1cblxuXG4gICAgaWYgKGlzTnVtYmVyKHJvdGF0ZSkgJiYgcm90YXRlICE9PSAwKSB7XG4gICAgICB2YWx1ZXMucHVzaChcInJvdGF0ZShcIi5jb25jYXQocm90YXRlLCBcImRlZylcIikpO1xuICAgIH1cblxuICAgIGlmIChpc051bWJlcihzY2FsZVgpICYmIHNjYWxlWCAhPT0gMSkge1xuICAgICAgdmFsdWVzLnB1c2goXCJzY2FsZVgoXCIuY29uY2F0KHNjYWxlWCwgXCIpXCIpKTtcbiAgICB9XG5cbiAgICBpZiAoaXNOdW1iZXIoc2NhbGVZKSAmJiBzY2FsZVkgIT09IDEpIHtcbiAgICAgIHZhbHVlcy5wdXNoKFwic2NhbGVZKFwiLmNvbmNhdChzY2FsZVksIFwiKVwiKSk7XG4gICAgfVxuXG4gICAgdmFyIHRyYW5zZm9ybSA9IHZhbHVlcy5sZW5ndGggPyB2YWx1ZXMuam9pbignICcpIDogJ25vbmUnO1xuICAgIHJldHVybiB7XG4gICAgICBXZWJraXRUcmFuc2Zvcm06IHRyYW5zZm9ybSxcbiAgICAgIG1zVHJhbnNmb3JtOiB0cmFuc2Zvcm0sXG4gICAgICB0cmFuc2Zvcm06IHRyYW5zZm9ybVxuICAgIH07XG4gIH1cbiAgLyoqXG4gICAqIEdldCBhbiBpbWFnZSBuYW1lIGZyb20gYW4gaW1hZ2UgdXJsLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVGhlIHRhcmdldCB1cmwuXG4gICAqIEBleGFtcGxlXG4gICAqIC8vIHBpY3R1cmUuanBnXG4gICAqIGdldEltYWdlTmFtZUZyb21VUkwoJ2h0dHBzOi8vZG9tYWluLmNvbS9wYXRoL3RvL3BpY3R1cmUuanBnP3NpemU9MTI4MMOXOTYwJylcbiAgICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgY29udGFpbnMgdGhlIGltYWdlIG5hbWUuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGdldEltYWdlTmFtZUZyb21VUkwodXJsKSB7XG4gICAgcmV0dXJuIGlzU3RyaW5nKHVybCkgPyBkZWNvZGVVUklDb21wb25lbnQodXJsLnJlcGxhY2UoL14uKlxcLy8sICcnKS5yZXBsYWNlKC9bPyYjXS4qJC8sICcnKSkgOiAnJztcbiAgfVxuICB2YXIgSVNfU0FGQVJJID0gV0lORE9XLm5hdmlnYXRvciAmJiAvKE1hY2ludG9zaHxpUGhvbmV8aVBvZHxpUGFkKS4qQXBwbGVXZWJLaXQvaS50ZXN0KFdJTkRPVy5uYXZpZ2F0b3IudXNlckFnZW50KTtcbiAgLyoqXG4gICAqIEdldCBhbiBpbWFnZSdzIG5hdHVyYWwgc2l6ZXMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBpbWFnZSAtIFRoZSB0YXJnZXQgaW1hZ2UuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIHZpZXdlciBvcHRpb25zLlxuICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayBmdW5jdGlvbi5cbiAgICogQHJldHVybnMge0hUTUxJbWFnZUVsZW1lbnR9IFRoZSBuZXcgaW1hZ2UuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGdldEltYWdlTmF0dXJhbFNpemVzKGltYWdlLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICAgIHZhciBuZXdJbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOyAvLyBNb2Rlcm4gYnJvd3NlcnMgKGV4Y2VwdCBTYWZhcmkpXG5cbiAgICBpZiAoaW1hZ2UubmF0dXJhbFdpZHRoICYmICFJU19TQUZBUkkpIHtcbiAgICAgIGNhbGxiYWNrKGltYWdlLm5hdHVyYWxXaWR0aCwgaW1hZ2UubmF0dXJhbEhlaWdodCk7XG4gICAgICByZXR1cm4gbmV3SW1hZ2U7XG4gICAgfVxuXG4gICAgdmFyIGJvZHkgPSBkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDtcblxuICAgIG5ld0ltYWdlLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGNhbGxiYWNrKG5ld0ltYWdlLndpZHRoLCBuZXdJbWFnZS5oZWlnaHQpO1xuXG4gICAgICBpZiAoIUlTX1NBRkFSSSkge1xuICAgICAgICBib2R5LnJlbW92ZUNoaWxkKG5ld0ltYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgZm9yRWFjaChvcHRpb25zLmluaGVyaXRlZEF0dHJpYnV0ZXMsIGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgICB2YXIgdmFsdWUgPSBpbWFnZS5nZXRBdHRyaWJ1dGUobmFtZSk7XG5cbiAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICBuZXdJbWFnZS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIG5ld0ltYWdlLnNyYyA9IGltYWdlLnNyYzsgLy8gaU9TIFNhZmFyaSB3aWxsIGNvbnZlcnQgdGhlIGltYWdlIGF1dG9tYXRpY2FsbHlcbiAgICAvLyB3aXRoIGl0cyBvcmllbnRhdGlvbiBvbmNlIGFwcGVuZCBpdCBpbnRvIERPTVxuXG4gICAgaWYgKCFJU19TQUZBUkkpIHtcbiAgICAgIG5ld0ltYWdlLnN0eWxlLmNzc1RleHQgPSAnbGVmdDowOycgKyAnbWF4LWhlaWdodDpub25lIWltcG9ydGFudDsnICsgJ21heC13aWR0aDpub25lIWltcG9ydGFudDsnICsgJ21pbi1oZWlnaHQ6MCFpbXBvcnRhbnQ7JyArICdtaW4td2lkdGg6MCFpbXBvcnRhbnQ7JyArICdvcGFjaXR5OjA7JyArICdwb3NpdGlvbjphYnNvbHV0ZTsnICsgJ3RvcDowOycgKyAnei1pbmRleDotMTsnO1xuICAgICAgYm9keS5hcHBlbmRDaGlsZChuZXdJbWFnZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld0ltYWdlO1xuICB9XG4gIC8qKlxuICAgKiBHZXQgdGhlIHJlbGF0ZWQgY2xhc3MgbmFtZSBvZiBhIHJlc3BvbnNpdmUgdHlwZSBudW1iZXIuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlIHJlc3BvbnNpdmUgdHlwZS5cbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIHJlbGF0ZWQgY2xhc3MgbmFtZS5cbiAgICovXG5cbiAgZnVuY3Rpb24gZ2V0UmVzcG9uc2l2ZUNsYXNzKHR5cGUpIHtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgMjpcbiAgICAgICAgcmV0dXJuIENMQVNTX0hJREVfWFNfRE9XTjtcblxuICAgICAgY2FzZSAzOlxuICAgICAgICByZXR1cm4gQ0xBU1NfSElERV9TTV9ET1dOO1xuXG4gICAgICBjYXNlIDQ6XG4gICAgICAgIHJldHVybiBDTEFTU19ISURFX01EX0RPV047XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiAnJztcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIEdldCB0aGUgbWF4IHJhdGlvIG9mIGEgZ3JvdXAgb2YgcG9pbnRlcnMuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwb2ludGVycyAtIFRoZSB0YXJnZXQgcG9pbnRlcnMuXG4gICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSByZXN1bHQgcmF0aW8uXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGdldE1heFpvb21SYXRpbyhwb2ludGVycykge1xuICAgIHZhciBwb2ludGVyczIgPSBfb2JqZWN0U3ByZWFkMih7fSwgcG9pbnRlcnMpO1xuXG4gICAgdmFyIHJhdGlvcyA9IFtdO1xuICAgIGZvckVhY2gocG9pbnRlcnMsIGZ1bmN0aW9uIChwb2ludGVyLCBwb2ludGVySWQpIHtcbiAgICAgIGRlbGV0ZSBwb2ludGVyczJbcG9pbnRlcklkXTtcbiAgICAgIGZvckVhY2gocG9pbnRlcnMyLCBmdW5jdGlvbiAocG9pbnRlcjIpIHtcbiAgICAgICAgdmFyIHgxID0gTWF0aC5hYnMocG9pbnRlci5zdGFydFggLSBwb2ludGVyMi5zdGFydFgpO1xuICAgICAgICB2YXIgeTEgPSBNYXRoLmFicyhwb2ludGVyLnN0YXJ0WSAtIHBvaW50ZXIyLnN0YXJ0WSk7XG4gICAgICAgIHZhciB4MiA9IE1hdGguYWJzKHBvaW50ZXIuZW5kWCAtIHBvaW50ZXIyLmVuZFgpO1xuICAgICAgICB2YXIgeTIgPSBNYXRoLmFicyhwb2ludGVyLmVuZFkgLSBwb2ludGVyMi5lbmRZKTtcbiAgICAgICAgdmFyIHoxID0gTWF0aC5zcXJ0KHgxICogeDEgKyB5MSAqIHkxKTtcbiAgICAgICAgdmFyIHoyID0gTWF0aC5zcXJ0KHgyICogeDIgKyB5MiAqIHkyKTtcbiAgICAgICAgdmFyIHJhdGlvID0gKHoyIC0gejEpIC8gejE7XG4gICAgICAgIHJhdGlvcy5wdXNoKHJhdGlvKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJhdGlvcy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XG4gICAgICByZXR1cm4gTWF0aC5hYnMoYSkgPCBNYXRoLmFicyhiKTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmF0aW9zWzBdO1xuICB9XG4gIC8qKlxuICAgKiBHZXQgYSBwb2ludGVyIGZyb20gYW4gZXZlbnQgb2JqZWN0LlxuICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnQgLSBUaGUgdGFyZ2V0IGV2ZW50IG9iamVjdC5cbiAgICogQHBhcmFtIHtib29sZWFufSBlbmRPbmx5IC0gSW5kaWNhdGVzIGlmIG9ubHkgcmV0dXJucyB0aGUgZW5kIHBvaW50IGNvb3JkaW5hdGUgb3Igbm90LlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgcmVzdWx0IHBvaW50ZXIgY29udGFpbnMgc3RhcnQgYW5kL29yIGVuZCBwb2ludCBjb29yZGluYXRlcy5cbiAgICovXG5cbiAgZnVuY3Rpb24gZ2V0UG9pbnRlcihfcmVmMiwgZW5kT25seSkge1xuICAgIHZhciBwYWdlWCA9IF9yZWYyLnBhZ2VYLFxuICAgICAgICBwYWdlWSA9IF9yZWYyLnBhZ2VZO1xuICAgIHZhciBlbmQgPSB7XG4gICAgICBlbmRYOiBwYWdlWCxcbiAgICAgIGVuZFk6IHBhZ2VZXG4gICAgfTtcbiAgICByZXR1cm4gZW5kT25seSA/IGVuZCA6IF9vYmplY3RTcHJlYWQyKHtcbiAgICAgIHRpbWVTdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHN0YXJ0WDogcGFnZVgsXG4gICAgICBzdGFydFk6IHBhZ2VZXG4gICAgfSwgZW5kKTtcbiAgfVxuICAvKipcbiAgICogR2V0IHRoZSBjZW50ZXIgcG9pbnQgY29vcmRpbmF0ZSBvZiBhIGdyb3VwIG9mIHBvaW50ZXJzLlxuICAgKiBAcGFyYW0ge09iamVjdH0gcG9pbnRlcnMgLSBUaGUgdGFyZ2V0IHBvaW50ZXJzLlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgY2VudGVyIHBvaW50IGNvb3JkaW5hdGUuXG4gICAqL1xuXG4gIGZ1bmN0aW9uIGdldFBvaW50ZXJzQ2VudGVyKHBvaW50ZXJzKSB7XG4gICAgdmFyIHBhZ2VYID0gMDtcbiAgICB2YXIgcGFnZVkgPSAwO1xuICAgIHZhciBjb3VudCA9IDA7XG4gICAgZm9yRWFjaChwb2ludGVycywgZnVuY3Rpb24gKF9yZWYzKSB7XG4gICAgICB2YXIgc3RhcnRYID0gX3JlZjMuc3RhcnRYLFxuICAgICAgICAgIHN0YXJ0WSA9IF9yZWYzLnN0YXJ0WTtcbiAgICAgIHBhZ2VYICs9IHN0YXJ0WDtcbiAgICAgIHBhZ2VZICs9IHN0YXJ0WTtcbiAgICAgIGNvdW50ICs9IDE7XG4gICAgfSk7XG4gICAgcGFnZVggLz0gY291bnQ7XG4gICAgcGFnZVkgLz0gY291bnQ7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhZ2VYOiBwYWdlWCxcbiAgICAgIHBhZ2VZOiBwYWdlWVxuICAgIH07XG4gIH1cblxuICB2YXIgcmVuZGVyID0ge1xuICAgIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkge1xuICAgICAgdGhpcy5pbml0Q29udGFpbmVyKCk7XG4gICAgICB0aGlzLmluaXRWaWV3ZXIoKTtcbiAgICAgIHRoaXMuaW5pdExpc3QoKTtcbiAgICAgIHRoaXMucmVuZGVyVmlld2VyKCk7XG4gICAgfSxcbiAgICBpbml0Qm9keTogZnVuY3Rpb24gaW5pdEJvZHkoKSB7XG4gICAgICB2YXIgb3duZXJEb2N1bWVudCA9IHRoaXMuZWxlbWVudC5vd25lckRvY3VtZW50O1xuICAgICAgdmFyIGJvZHkgPSBvd25lckRvY3VtZW50LmJvZHkgfHwgb3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7XG4gICAgICB0aGlzLmJvZHkgPSBib2R5O1xuICAgICAgdGhpcy5zY3JvbGxiYXJXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoIC0gb3duZXJEb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7XG4gICAgICB0aGlzLmluaXRpYWxCb2R5UGFkZGluZ1JpZ2h0ID0gYm9keS5zdHlsZS5wYWRkaW5nUmlnaHQ7XG4gICAgICB0aGlzLmluaXRpYWxCb2R5Q29tcHV0ZWRQYWRkaW5nUmlnaHQgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShib2R5KS5wYWRkaW5nUmlnaHQ7XG4gICAgfSxcbiAgICBpbml0Q29udGFpbmVyOiBmdW5jdGlvbiBpbml0Q29udGFpbmVyKCkge1xuICAgICAgdGhpcy5jb250YWluZXJEYXRhID0ge1xuICAgICAgICB3aWR0aDogd2luZG93LmlubmVyV2lkdGgsXG4gICAgICAgIGhlaWdodDogd2luZG93LmlubmVySGVpZ2h0XG4gICAgICB9O1xuICAgIH0sXG4gICAgaW5pdFZpZXdlcjogZnVuY3Rpb24gaW5pdFZpZXdlcigpIHtcbiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICAgIHBhcmVudCA9IHRoaXMucGFyZW50O1xuICAgICAgdmFyIHZpZXdlckRhdGE7XG5cbiAgICAgIGlmIChvcHRpb25zLmlubGluZSkge1xuICAgICAgICB2aWV3ZXJEYXRhID0ge1xuICAgICAgICAgIHdpZHRoOiBNYXRoLm1heChwYXJlbnQub2Zmc2V0V2lkdGgsIG9wdGlvbnMubWluV2lkdGgpLFxuICAgICAgICAgIGhlaWdodDogTWF0aC5tYXgocGFyZW50Lm9mZnNldEhlaWdodCwgb3B0aW9ucy5taW5IZWlnaHQpXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucGFyZW50RGF0YSA9IHZpZXdlckRhdGE7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmZ1bGxlZCB8fCAhdmlld2VyRGF0YSkge1xuICAgICAgICB2aWV3ZXJEYXRhID0gdGhpcy5jb250YWluZXJEYXRhO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnZpZXdlckRhdGEgPSBhc3NpZ24oe30sIHZpZXdlckRhdGEpO1xuICAgIH0sXG4gICAgcmVuZGVyVmlld2VyOiBmdW5jdGlvbiByZW5kZXJWaWV3ZXIoKSB7XG4gICAgICBpZiAodGhpcy5vcHRpb25zLmlubGluZSAmJiAhdGhpcy5mdWxsZWQpIHtcbiAgICAgICAgc2V0U3R5bGUodGhpcy52aWV3ZXIsIHRoaXMudmlld2VyRGF0YSk7XG4gICAgICB9XG4gICAgfSxcbiAgICBpbml0TGlzdDogZnVuY3Rpb24gaW5pdExpc3QoKSB7XG4gICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuXG4gICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICAgIGxpc3QgPSB0aGlzLmxpc3Q7XG4gICAgICB2YXIgaXRlbXMgPSBbXTsgLy8gaW5pdExpc3QgbWF5IGJlIGNhbGxlZCBpbiB0aGlzLnVwZGF0ZSwgc28gc2hvdWxkIGtlZXAgaWRlbXBvdGVudFxuXG4gICAgICBsaXN0LmlubmVySFRNTCA9ICcnO1xuICAgICAgZm9yRWFjaCh0aGlzLmltYWdlcywgZnVuY3Rpb24gKGltYWdlLCBpbmRleCkge1xuICAgICAgICB2YXIgc3JjID0gaW1hZ2Uuc3JjO1xuICAgICAgICB2YXIgYWx0ID0gaW1hZ2UuYWx0IHx8IGdldEltYWdlTmFtZUZyb21VUkwoc3JjKTtcblxuICAgICAgICB2YXIgdXJsID0gX3RoaXMuZ2V0SW1hZ2VVUkwoaW1hZ2UpO1xuXG4gICAgICAgIGlmIChzcmMgfHwgdXJsKSB7XG4gICAgICAgICAgdmFyIGl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICAgICAgICAgIHZhciBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgICAgICAgICBmb3JFYWNoKG9wdGlvbnMuaW5oZXJpdGVkQXR0cmlidXRlcywgZnVuY3Rpb24gKG5hbWUpIHtcbiAgICAgICAgICAgIHZhciB2YWx1ZSA9IGltYWdlLmdldEF0dHJpYnV0ZShuYW1lKTtcblxuICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIGltZy5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGltZy5zcmMgPSBzcmMgfHwgdXJsO1xuICAgICAgICAgIGltZy5hbHQgPSBhbHQ7XG4gICAgICAgICAgaW1nLnNldEF0dHJpYnV0ZSgnZGF0YS1vcmlnaW5hbC11cmwnLCB1cmwgfHwgc3JjKTtcbiAgICAgICAgICBpdGVtLnNldEF0dHJpYnV0ZSgnZGF0YS1pbmRleCcsIGluZGV4KTtcbiAgICAgICAgICBpdGVtLnNldEF0dHJpYnV0ZSgnZGF0YS12aWV3ZXItYWN0aW9uJywgJ3ZpZXcnKTtcbiAgICAgICAgICBpdGVtLnNldEF0dHJpYnV0ZSgncm9sZScsICdidXR0b24nKTtcblxuICAgICAgICAgIGlmIChvcHRpb25zLmtleWJvYXJkKSB7XG4gICAgICAgICAgICBpdGVtLnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCAwKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpdGVtLmFwcGVuZENoaWxkKGltZyk7XG4gICAgICAgICAgbGlzdC5hcHBlbmRDaGlsZChpdGVtKTtcbiAgICAgICAgICBpdGVtcy5wdXNoKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuaXRlbXMgPSBpdGVtcztcbiAgICAgIGZvckVhY2goaXRlbXMsIGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgIHZhciBpbWFnZSA9IGl0ZW0uZmlyc3RFbGVtZW50Q2hpbGQ7XG4gICAgICAgIHZhciBvbkxvYWQ7XG4gICAgICAgIHZhciBvbkVycm9yO1xuICAgICAgICBzZXREYXRhKGltYWdlLCAnZmlsbGVkJywgdHJ1ZSk7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMubG9hZGluZykge1xuICAgICAgICAgIGFkZENsYXNzKGl0ZW0sIENMQVNTX0xPQURJTkcpO1xuICAgICAgICB9XG5cbiAgICAgICAgYWRkTGlzdGVuZXIoaW1hZ2UsIEVWRU5UX0xPQUQsIG9uTG9hZCA9IGZ1bmN0aW9uIG9uTG9hZChldmVudCkge1xuICAgICAgICAgIHJlbW92ZUxpc3RlbmVyKGltYWdlLCBFVkVOVF9FUlJPUiwgb25FcnJvcik7XG5cbiAgICAgICAgICBpZiAob3B0aW9ucy5sb2FkaW5nKSB7XG4gICAgICAgICAgICByZW1vdmVDbGFzcyhpdGVtLCBDTEFTU19MT0FESU5HKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBfdGhpcy5sb2FkSW1hZ2UoZXZlbnQpO1xuICAgICAgICB9LCB7XG4gICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgYWRkTGlzdGVuZXIoaW1hZ2UsIEVWRU5UX0VSUk9SLCBvbkVycm9yID0gZnVuY3Rpb24gb25FcnJvcigpIHtcbiAgICAgICAgICByZW1vdmVMaXN0ZW5lcihpbWFnZSwgRVZFTlRfTE9BRCwgb25Mb2FkKTtcblxuICAgICAgICAgIGlmIChvcHRpb25zLmxvYWRpbmcpIHtcbiAgICAgICAgICAgIHJlbW92ZUNsYXNzKGl0ZW0sIENMQVNTX0xPQURJTkcpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwge1xuICAgICAgICAgIG9uY2U6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbikge1xuICAgICAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBFVkVOVF9WSUVXRUQsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBhZGRDbGFzcyhsaXN0LCBDTEFTU19UUkFOU0lUSU9OKTtcbiAgICAgICAgfSwge1xuICAgICAgICAgIG9uY2U6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSxcbiAgICByZW5kZXJMaXN0OiBmdW5jdGlvbiByZW5kZXJMaXN0KCkge1xuICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleDtcbiAgICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpbmRleF07XG5cbiAgICAgIGlmICghaXRlbSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHZhciBuZXh0ID0gaXRlbS5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICB2YXIgZ3V0dGVyID0gcGFyc2VJbnQod2luZG93LmdldENvbXB1dGVkU3R5bGUobmV4dCB8fCBpdGVtKS5tYXJnaW5MZWZ0LCAxMCk7XG4gICAgICB2YXIgb2Zmc2V0V2lkdGggPSBpdGVtLm9mZnNldFdpZHRoO1xuICAgICAgdmFyIG91dGVyV2lkdGggPSBvZmZzZXRXaWR0aCArIGd1dHRlcjsgLy8gUGxhY2UgdGhlIGFjdGl2ZSBpdGVtIGluIHRoZSBjZW50ZXIgb2YgdGhlIHNjcmVlblxuXG4gICAgICBzZXRTdHlsZSh0aGlzLmxpc3QsIGFzc2lnbih7XG4gICAgICAgIHdpZHRoOiBvdXRlcldpZHRoICogdGhpcy5sZW5ndGggLSBndXR0ZXJcbiAgICAgIH0sIGdldFRyYW5zZm9ybXMoe1xuICAgICAgICB0cmFuc2xhdGVYOiAodGhpcy52aWV3ZXJEYXRhLndpZHRoIC0gb2Zmc2V0V2lkdGgpIC8gMiAtIG91dGVyV2lkdGggKiBpbmRleFxuICAgICAgfSkpKTtcbiAgICB9LFxuICAgIHJlc2V0TGlzdDogZnVuY3Rpb24gcmVzZXRMaXN0KCkge1xuICAgICAgdmFyIGxpc3QgPSB0aGlzLmxpc3Q7XG4gICAgICBsaXN0LmlubmVySFRNTCA9ICcnO1xuICAgICAgcmVtb3ZlQ2xhc3MobGlzdCwgQ0xBU1NfVFJBTlNJVElPTik7XG4gICAgICBzZXRTdHlsZShsaXN0LCBnZXRUcmFuc2Zvcm1zKHtcbiAgICAgICAgdHJhbnNsYXRlWDogMFxuICAgICAgfSkpO1xuICAgIH0sXG4gICAgaW5pdEltYWdlOiBmdW5jdGlvbiBpbml0SW1hZ2UoZG9uZSkge1xuICAgICAgdmFyIF90aGlzMiA9IHRoaXM7XG5cbiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICAgIGltYWdlID0gdGhpcy5pbWFnZSxcbiAgICAgICAgICB2aWV3ZXJEYXRhID0gdGhpcy52aWV3ZXJEYXRhO1xuICAgICAgdmFyIGZvb3RlckhlaWdodCA9IHRoaXMuZm9vdGVyLm9mZnNldEhlaWdodDtcbiAgICAgIHZhciB2aWV3ZXJXaWR0aCA9IHZpZXdlckRhdGEud2lkdGg7XG4gICAgICB2YXIgdmlld2VySGVpZ2h0ID0gTWF0aC5tYXgodmlld2VyRGF0YS5oZWlnaHQgLSBmb290ZXJIZWlnaHQsIGZvb3RlckhlaWdodCk7XG4gICAgICB2YXIgb2xkSW1hZ2VEYXRhID0gdGhpcy5pbWFnZURhdGEgfHwge307XG4gICAgICB2YXIgc2l6aW5nSW1hZ2U7XG4gICAgICB0aGlzLmltYWdlSW5pdGlhbGl6aW5nID0ge1xuICAgICAgICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoKSB7XG4gICAgICAgICAgc2l6aW5nSW1hZ2Uub25sb2FkID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIHNpemluZ0ltYWdlID0gZ2V0SW1hZ2VOYXR1cmFsU2l6ZXMoaW1hZ2UsIG9wdGlvbnMsIGZ1bmN0aW9uIChuYXR1cmFsV2lkdGgsIG5hdHVyYWxIZWlnaHQpIHtcbiAgICAgICAgdmFyIGFzcGVjdFJhdGlvID0gbmF0dXJhbFdpZHRoIC8gbmF0dXJhbEhlaWdodDtcbiAgICAgICAgdmFyIHdpZHRoID0gdmlld2VyV2lkdGg7XG4gICAgICAgIHZhciBoZWlnaHQgPSB2aWV3ZXJIZWlnaHQ7XG4gICAgICAgIF90aGlzMi5pbWFnZUluaXRpYWxpemluZyA9IGZhbHNlO1xuXG4gICAgICAgIGlmICh2aWV3ZXJIZWlnaHQgKiBhc3BlY3RSYXRpbyA+IHZpZXdlcldpZHRoKSB7XG4gICAgICAgICAgaGVpZ2h0ID0gdmlld2VyV2lkdGggLyBhc3BlY3RSYXRpbztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3aWR0aCA9IHZpZXdlckhlaWdodCAqIGFzcGVjdFJhdGlvO1xuICAgICAgICB9XG5cbiAgICAgICAgd2lkdGggPSBNYXRoLm1pbih3aWR0aCAqIDAuOSwgbmF0dXJhbFdpZHRoKTtcbiAgICAgICAgaGVpZ2h0ID0gTWF0aC5taW4oaGVpZ2h0ICogMC45LCBuYXR1cmFsSGVpZ2h0KTtcbiAgICAgICAgdmFyIGxlZnQgPSAodmlld2VyV2lkdGggLSB3aWR0aCkgLyAyO1xuICAgICAgICB2YXIgdG9wID0gKHZpZXdlckhlaWdodCAtIGhlaWdodCkgLyAyO1xuICAgICAgICB2YXIgaW1hZ2VEYXRhID0ge1xuICAgICAgICAgIGxlZnQ6IGxlZnQsXG4gICAgICAgICAgdG9wOiB0b3AsXG4gICAgICAgICAgeDogbGVmdCxcbiAgICAgICAgICB5OiB0b3AsXG4gICAgICAgICAgd2lkdGg6IHdpZHRoLFxuICAgICAgICAgIGhlaWdodDogaGVpZ2h0LFxuICAgICAgICAgIG9sZFJhdGlvOiAxLFxuICAgICAgICAgIHJhdGlvOiB3aWR0aCAvIG5hdHVyYWxXaWR0aCxcbiAgICAgICAgICBhc3BlY3RSYXRpbzogYXNwZWN0UmF0aW8sXG4gICAgICAgICAgbmF0dXJhbFdpZHRoOiBuYXR1cmFsV2lkdGgsXG4gICAgICAgICAgbmF0dXJhbEhlaWdodDogbmF0dXJhbEhlaWdodFxuICAgICAgICB9O1xuICAgICAgICB2YXIgaW5pdGlhbEltYWdlRGF0YSA9IGFzc2lnbih7fSwgaW1hZ2VEYXRhKTtcblxuICAgICAgICBpZiAob3B0aW9ucy5yb3RhdGFibGUpIHtcbiAgICAgICAgICBpbWFnZURhdGEucm90YXRlID0gb2xkSW1hZ2VEYXRhLnJvdGF0ZSB8fCAwO1xuICAgICAgICAgIGluaXRpYWxJbWFnZURhdGEucm90YXRlID0gMDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLnNjYWxhYmxlKSB7XG4gICAgICAgICAgaW1hZ2VEYXRhLnNjYWxlWCA9IG9sZEltYWdlRGF0YS5zY2FsZVggfHwgMTtcbiAgICAgICAgICBpbWFnZURhdGEuc2NhbGVZID0gb2xkSW1hZ2VEYXRhLnNjYWxlWSB8fCAxO1xuICAgICAgICAgIGluaXRpYWxJbWFnZURhdGEuc2NhbGVYID0gMTtcbiAgICAgICAgICBpbml0aWFsSW1hZ2VEYXRhLnNjYWxlWSA9IDE7XG4gICAgICAgIH1cblxuICAgICAgICBfdGhpczIuaW1hZ2VEYXRhID0gaW1hZ2VEYXRhO1xuICAgICAgICBfdGhpczIuaW5pdGlhbEltYWdlRGF0YSA9IGluaXRpYWxJbWFnZURhdGE7XG5cbiAgICAgICAgaWYgKGRvbmUpIHtcbiAgICAgICAgICBkb25lKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sXG4gICAgcmVuZGVySW1hZ2U6IGZ1bmN0aW9uIHJlbmRlckltYWdlKGRvbmUpIHtcbiAgICAgIHZhciBfdGhpczMgPSB0aGlzO1xuXG4gICAgICB2YXIgaW1hZ2UgPSB0aGlzLmltYWdlLFxuICAgICAgICAgIGltYWdlRGF0YSA9IHRoaXMuaW1hZ2VEYXRhO1xuICAgICAgc2V0U3R5bGUoaW1hZ2UsIGFzc2lnbih7XG4gICAgICAgIHdpZHRoOiBpbWFnZURhdGEud2lkdGgsXG4gICAgICAgIGhlaWdodDogaW1hZ2VEYXRhLmhlaWdodCxcbiAgICAgICAgLy8gWFhYOiBOb3QgdG8gdXNlIHRyYW5zbGF0ZVgvWSB0byBhdm9pZCBpbWFnZSBzaGFraW5nIHdoZW4gem9vbWluZ1xuICAgICAgICBtYXJnaW5MZWZ0OiBpbWFnZURhdGEueCxcbiAgICAgICAgbWFyZ2luVG9wOiBpbWFnZURhdGEueVxuICAgICAgfSwgZ2V0VHJhbnNmb3JtcyhpbWFnZURhdGEpKSk7XG5cbiAgICAgIGlmIChkb25lKSB7XG4gICAgICAgIGlmICgodGhpcy52aWV3aW5nIHx8IHRoaXMubW92aW5nIHx8IHRoaXMucm90YXRpbmcgfHwgdGhpcy5zY2FsaW5nIHx8IHRoaXMuem9vbWluZykgJiYgdGhpcy5vcHRpb25zLnRyYW5zaXRpb24gJiYgaGFzQ2xhc3MoaW1hZ2UsIENMQVNTX1RSQU5TSVRJT04pKSB7XG4gICAgICAgICAgdmFyIG9uVHJhbnNpdGlvbkVuZCA9IGZ1bmN0aW9uIG9uVHJhbnNpdGlvbkVuZCgpIHtcbiAgICAgICAgICAgIF90aGlzMy5pbWFnZVJlbmRlcmluZyA9IGZhbHNlO1xuICAgICAgICAgICAgZG9uZSgpO1xuICAgICAgICAgIH07XG5cbiAgICAgICAgICB0aGlzLmltYWdlUmVuZGVyaW5nID0ge1xuICAgICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkge1xuICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcihpbWFnZSwgRVZFTlRfVFJBTlNJVElPTl9FTkQsIG9uVHJhbnNpdGlvbkVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfTtcbiAgICAgICAgICBhZGRMaXN0ZW5lcihpbWFnZSwgRVZFTlRfVFJBTlNJVElPTl9FTkQsIG9uVHJhbnNpdGlvbkVuZCwge1xuICAgICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGRvbmUoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgcmVzZXRJbWFnZTogZnVuY3Rpb24gcmVzZXRJbWFnZSgpIHtcbiAgICAgIC8vIHRoaXMuaW1hZ2Ugb25seSBkZWZpbmVkIGFmdGVyIHZpZXdlZFxuICAgICAgaWYgKHRoaXMudmlld2luZyB8fCB0aGlzLnZpZXdlZCkge1xuICAgICAgICB2YXIgaW1hZ2UgPSB0aGlzLmltYWdlO1xuXG4gICAgICAgIGlmICh0aGlzLnZpZXdpbmcpIHtcbiAgICAgICAgICB0aGlzLnZpZXdpbmcuYWJvcnQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGltYWdlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoaW1hZ2UpO1xuICAgICAgICB0aGlzLmltYWdlID0gbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgdmFyIGV2ZW50cyA9IHtcbiAgICBiaW5kOiBmdW5jdGlvbiBiaW5kKCkge1xuICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgdmlld2VyID0gdGhpcy52aWV3ZXIsXG4gICAgICAgICAgY2FudmFzID0gdGhpcy5jYW52YXM7XG4gICAgICB2YXIgZG9jdW1lbnQgPSB0aGlzLmVsZW1lbnQub3duZXJEb2N1bWVudDtcbiAgICAgIGFkZExpc3RlbmVyKHZpZXdlciwgRVZFTlRfQ0xJQ0ssIHRoaXMub25DbGljayA9IHRoaXMuY2xpY2suYmluZCh0aGlzKSk7XG4gICAgICBhZGRMaXN0ZW5lcih2aWV3ZXIsIEVWRU5UX0RSQUdfU1RBUlQsIHRoaXMub25EcmFnU3RhcnQgPSB0aGlzLmRyYWdzdGFydC5iaW5kKHRoaXMpKTtcbiAgICAgIGFkZExpc3RlbmVyKGNhbnZhcywgRVZFTlRfUE9JTlRFUl9ET1dOLCB0aGlzLm9uUG9pbnRlckRvd24gPSB0aGlzLnBvaW50ZXJkb3duLmJpbmQodGhpcykpO1xuICAgICAgYWRkTGlzdGVuZXIoZG9jdW1lbnQsIEVWRU5UX1BPSU5URVJfTU9WRSwgdGhpcy5vblBvaW50ZXJNb3ZlID0gdGhpcy5wb2ludGVybW92ZS5iaW5kKHRoaXMpKTtcbiAgICAgIGFkZExpc3RlbmVyKGRvY3VtZW50LCBFVkVOVF9QT0lOVEVSX1VQLCB0aGlzLm9uUG9pbnRlclVwID0gdGhpcy5wb2ludGVydXAuYmluZCh0aGlzKSk7XG4gICAgICBhZGRMaXN0ZW5lcihkb2N1bWVudCwgRVZFTlRfS0VZX0RPV04sIHRoaXMub25LZXlEb3duID0gdGhpcy5rZXlkb3duLmJpbmQodGhpcykpO1xuICAgICAgYWRkTGlzdGVuZXIod2luZG93LCBFVkVOVF9SRVNJWkUsIHRoaXMub25SZXNpemUgPSB0aGlzLnJlc2l6ZS5iaW5kKHRoaXMpKTtcblxuICAgICAgaWYgKG9wdGlvbnMuem9vbWFibGUgJiYgb3B0aW9ucy56b29tT25XaGVlbCkge1xuICAgICAgICBhZGRMaXN0ZW5lcih2aWV3ZXIsIEVWRU5UX1dIRUVMLCB0aGlzLm9uV2hlZWwgPSB0aGlzLndoZWVsLmJpbmQodGhpcyksIHtcbiAgICAgICAgICBwYXNzaXZlOiBmYWxzZSxcbiAgICAgICAgICBjYXB0dXJlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBpZiAob3B0aW9ucy50b2dnbGVPbkRibGNsaWNrKSB7XG4gICAgICAgIGFkZExpc3RlbmVyKGNhbnZhcywgRVZFTlRfREJMQ0xJQ0ssIHRoaXMub25EYmxjbGljayA9IHRoaXMuZGJsY2xpY2suYmluZCh0aGlzKSk7XG4gICAgICB9XG4gICAgfSxcbiAgICB1bmJpbmQ6IGZ1bmN0aW9uIHVuYmluZCgpIHtcbiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICAgIHZpZXdlciA9IHRoaXMudmlld2VyLFxuICAgICAgICAgIGNhbnZhcyA9IHRoaXMuY2FudmFzO1xuICAgICAgdmFyIGRvY3VtZW50ID0gdGhpcy5lbGVtZW50Lm93bmVyRG9jdW1lbnQ7XG4gICAgICByZW1vdmVMaXN0ZW5lcih2aWV3ZXIsIEVWRU5UX0NMSUNLLCB0aGlzLm9uQ2xpY2spO1xuICAgICAgcmVtb3ZlTGlzdGVuZXIodmlld2VyLCBFVkVOVF9EUkFHX1NUQVJULCB0aGlzLm9uRHJhZ1N0YXJ0KTtcbiAgICAgIHJlbW92ZUxpc3RlbmVyKGNhbnZhcywgRVZFTlRfUE9JTlRFUl9ET1dOLCB0aGlzLm9uUG9pbnRlckRvd24pO1xuICAgICAgcmVtb3ZlTGlzdGVuZXIoZG9jdW1lbnQsIEVWRU5UX1BPSU5URVJfTU9WRSwgdGhpcy5vblBvaW50ZXJNb3ZlKTtcbiAgICAgIHJlbW92ZUxpc3RlbmVyKGRvY3VtZW50LCBFVkVOVF9QT0lOVEVSX1VQLCB0aGlzLm9uUG9pbnRlclVwKTtcbiAgICAgIHJlbW92ZUxpc3RlbmVyKGRvY3VtZW50LCBFVkVOVF9LRVlfRE9XTiwgdGhpcy5vbktleURvd24pO1xuICAgICAgcmVtb3ZlTGlzdGVuZXIod2luZG93LCBFVkVOVF9SRVNJWkUsIHRoaXMub25SZXNpemUpO1xuXG4gICAgICBpZiAob3B0aW9ucy56b29tYWJsZSAmJiBvcHRpb25zLnpvb21PbldoZWVsKSB7XG4gICAgICAgIHJlbW92ZUxpc3RlbmVyKHZpZXdlciwgRVZFTlRfV0hFRUwsIHRoaXMub25XaGVlbCwge1xuICAgICAgICAgIHBhc3NpdmU6IGZhbHNlLFxuICAgICAgICAgIGNhcHR1cmU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChvcHRpb25zLnRvZ2dsZU9uRGJsY2xpY2spIHtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoY2FudmFzLCBFVkVOVF9EQkxDTElDSywgdGhpcy5vbkRibGNsaWNrKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgdmFyIGhhbmRsZXJzID0ge1xuICAgIGNsaWNrOiBmdW5jdGlvbiBjbGljayhldmVudCkge1xuICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgaW1hZ2VEYXRhID0gdGhpcy5pbWFnZURhdGE7XG4gICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgICAgdmFyIGFjdGlvbiA9IGdldERhdGEodGFyZ2V0LCBEQVRBX0FDVElPTik7XG5cbiAgICAgIGlmICghYWN0aW9uICYmIHRhcmdldC5sb2NhbE5hbWUgPT09ICdpbWcnICYmIHRhcmdldC5wYXJlbnRFbGVtZW50LmxvY2FsTmFtZSA9PT0gJ2xpJykge1xuICAgICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50RWxlbWVudDtcbiAgICAgICAgYWN0aW9uID0gZ2V0RGF0YSh0YXJnZXQsIERBVEFfQUNUSU9OKTtcbiAgICAgIH0gLy8gQ2FuY2VsIHRoZSBlbXVsYXRlZCBjbGljayB3aGVuIHRoZSBuYXRpdmUgY2xpY2sgZXZlbnQgd2FzIHRyaWdnZXJlZC5cblxuXG4gICAgICBpZiAoSVNfVE9VQ0hfREVWSUNFICYmIGV2ZW50LmlzVHJ1c3RlZCAmJiB0YXJnZXQgPT09IHRoaXMuY2FudmFzKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmNsaWNrQ2FudmFzVGltZW91dCk7XG4gICAgICB9XG5cbiAgICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICAgIGNhc2UgJ21peCc6XG4gICAgICAgICAgaWYgKHRoaXMucGxheWVkKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuaW5saW5lKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5mdWxsZWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5leGl0KCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aGlzLmZ1bGwoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnaGlkZSc6XG4gICAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAndmlldyc6XG4gICAgICAgICAgdGhpcy52aWV3KGdldERhdGEodGFyZ2V0LCAnaW5kZXgnKSk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnem9vbS1pbic6XG4gICAgICAgICAgdGhpcy56b29tKDAuMSwgdHJ1ZSk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnem9vbS1vdXQnOlxuICAgICAgICAgIHRoaXMuem9vbSgtMC4xLCB0cnVlKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlICdvbmUtdG8tb25lJzpcbiAgICAgICAgICB0aGlzLnRvZ2dsZSgpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgJ3Jlc2V0JzpcbiAgICAgICAgICB0aGlzLnJlc2V0KCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncHJldic6XG4gICAgICAgICAgdGhpcy5wcmV2KG9wdGlvbnMubG9vcCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncGxheSc6XG4gICAgICAgICAgdGhpcy5wbGF5KG9wdGlvbnMuZnVsbHNjcmVlbik7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnbmV4dCc6XG4gICAgICAgICAgdGhpcy5uZXh0KG9wdGlvbnMubG9vcCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncm90YXRlLWxlZnQnOlxuICAgICAgICAgIHRoaXMucm90YXRlKC05MCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAncm90YXRlLXJpZ2h0JzpcbiAgICAgICAgICB0aGlzLnJvdGF0ZSg5MCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnZmxpcC1ob3Jpem9udGFsJzpcbiAgICAgICAgICB0aGlzLnNjYWxlWCgtaW1hZ2VEYXRhLnNjYWxlWCB8fCAtMSk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSAnZmxpcC12ZXJ0aWNhbCc6XG4gICAgICAgICAgdGhpcy5zY2FsZVkoLWltYWdlRGF0YS5zY2FsZVkgfHwgLTEpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgaWYgKHRoaXMucGxheWVkKSB7XG4gICAgICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgICAgICB9XG5cbiAgICAgIH1cbiAgICB9LFxuICAgIGRibGNsaWNrOiBmdW5jdGlvbiBkYmxjbGljayhldmVudCkge1xuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgaWYgKHRoaXMudmlld2VkICYmIGV2ZW50LnRhcmdldCA9PT0gdGhpcy5pbWFnZSkge1xuICAgICAgICAvLyBDYW5jZWwgdGhlIGVtdWxhdGVkIGRvdWJsZSBjbGljayB3aGVuIHRoZSBuYXRpdmUgZGJsY2xpY2sgZXZlbnQgd2FzIHRyaWdnZXJlZC5cbiAgICAgICAgaWYgKElTX1RPVUNIX0RFVklDRSAmJiBldmVudC5pc1RydXN0ZWQpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kb3VibGVDbGlja0ltYWdlVGltZW91dCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnRvZ2dsZShldmVudCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBsb2FkOiBmdW5jdGlvbiBsb2FkKCkge1xuICAgICAgdmFyIF90aGlzID0gdGhpcztcblxuICAgICAgaWYgKHRoaXMudGltZW91dCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcbiAgICAgICAgdGhpcy50aW1lb3V0ID0gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgaW1hZ2UgPSB0aGlzLmltYWdlLFxuICAgICAgICAgIGluZGV4ID0gdGhpcy5pbmRleCxcbiAgICAgICAgICB2aWV3ZXJEYXRhID0gdGhpcy52aWV3ZXJEYXRhO1xuICAgICAgcmVtb3ZlQ2xhc3MoaW1hZ2UsIENMQVNTX0lOVklTSUJMRSk7XG5cbiAgICAgIGlmIChvcHRpb25zLmxvYWRpbmcpIHtcbiAgICAgICAgcmVtb3ZlQ2xhc3ModGhpcy5jYW52YXMsIENMQVNTX0xPQURJTkcpO1xuICAgICAgfVxuXG4gICAgICBpbWFnZS5zdHlsZS5jc3NUZXh0ID0gJ2hlaWdodDowOycgKyBcIm1hcmdpbi1sZWZ0OlwiLmNvbmNhdCh2aWV3ZXJEYXRhLndpZHRoIC8gMiwgXCJweDtcIikgKyBcIm1hcmdpbi10b3A6XCIuY29uY2F0KHZpZXdlckRhdGEuaGVpZ2h0IC8gMiwgXCJweDtcIikgKyAnbWF4LXdpZHRoOm5vbmUhaW1wb3J0YW50OycgKyAncG9zaXRpb246cmVsYXRpdmU7JyArICd3aWR0aDowOyc7XG4gICAgICB0aGlzLmluaXRJbWFnZShmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRvZ2dsZUNsYXNzKGltYWdlLCBDTEFTU19NT1ZFLCBvcHRpb25zLm1vdmFibGUpO1xuICAgICAgICB0b2dnbGVDbGFzcyhpbWFnZSwgQ0xBU1NfVFJBTlNJVElPTiwgb3B0aW9ucy50cmFuc2l0aW9uKTtcblxuICAgICAgICBfdGhpcy5yZW5kZXJJbWFnZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgX3RoaXMudmlld2VkID0gdHJ1ZTtcbiAgICAgICAgICBfdGhpcy52aWV3aW5nID0gZmFsc2U7XG5cbiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihvcHRpb25zLnZpZXdlZCkpIHtcbiAgICAgICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIEVWRU5UX1ZJRVdFRCwgb3B0aW9ucy52aWV3ZWQsIHtcbiAgICAgICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGlzcGF0Y2hFdmVudChlbGVtZW50LCBFVkVOVF9WSUVXRUQsIHtcbiAgICAgICAgICAgIG9yaWdpbmFsSW1hZ2U6IF90aGlzLmltYWdlc1tpbmRleF0sXG4gICAgICAgICAgICBpbmRleDogaW5kZXgsXG4gICAgICAgICAgICBpbWFnZTogaW1hZ2VcbiAgICAgICAgICB9LCB7XG4gICAgICAgICAgICBjYW5jZWxhYmxlOiBmYWxzZVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgbG9hZEltYWdlOiBmdW5jdGlvbiBsb2FkSW1hZ2UoZXZlbnQpIHtcbiAgICAgIHZhciBpbWFnZSA9IGV2ZW50LnRhcmdldDtcbiAgICAgIHZhciBwYXJlbnQgPSBpbWFnZS5wYXJlbnROb2RlO1xuICAgICAgdmFyIHBhcmVudFdpZHRoID0gcGFyZW50Lm9mZnNldFdpZHRoIHx8IDMwO1xuICAgICAgdmFyIHBhcmVudEhlaWdodCA9IHBhcmVudC5vZmZzZXRIZWlnaHQgfHwgNTA7XG4gICAgICB2YXIgZmlsbGVkID0gISFnZXREYXRhKGltYWdlLCAnZmlsbGVkJyk7XG4gICAgICBnZXRJbWFnZU5hdHVyYWxTaXplcyhpbWFnZSwgdGhpcy5vcHRpb25zLCBmdW5jdGlvbiAobmF0dXJhbFdpZHRoLCBuYXR1cmFsSGVpZ2h0KSB7XG4gICAgICAgIHZhciBhc3BlY3RSYXRpbyA9IG5hdHVyYWxXaWR0aCAvIG5hdHVyYWxIZWlnaHQ7XG4gICAgICAgIHZhciB3aWR0aCA9IHBhcmVudFdpZHRoO1xuICAgICAgICB2YXIgaGVpZ2h0ID0gcGFyZW50SGVpZ2h0O1xuXG4gICAgICAgIGlmIChwYXJlbnRIZWlnaHQgKiBhc3BlY3RSYXRpbyA+IHBhcmVudFdpZHRoKSB7XG4gICAgICAgICAgaWYgKGZpbGxlZCkge1xuICAgICAgICAgICAgd2lkdGggPSBwYXJlbnRIZWlnaHQgKiBhc3BlY3RSYXRpbztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaGVpZ2h0ID0gcGFyZW50V2lkdGggLyBhc3BlY3RSYXRpbztcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoZmlsbGVkKSB7XG4gICAgICAgICAgaGVpZ2h0ID0gcGFyZW50V2lkdGggLyBhc3BlY3RSYXRpbztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3aWR0aCA9IHBhcmVudEhlaWdodCAqIGFzcGVjdFJhdGlvO1xuICAgICAgICB9XG5cbiAgICAgICAgc2V0U3R5bGUoaW1hZ2UsIGFzc2lnbih7XG4gICAgICAgICAgd2lkdGg6IHdpZHRoLFxuICAgICAgICAgIGhlaWdodDogaGVpZ2h0XG4gICAgICAgIH0sIGdldFRyYW5zZm9ybXMoe1xuICAgICAgICAgIHRyYW5zbGF0ZVg6IChwYXJlbnRXaWR0aCAtIHdpZHRoKSAvIDIsXG4gICAgICAgICAgdHJhbnNsYXRlWTogKHBhcmVudEhlaWdodCAtIGhlaWdodCkgLyAyXG4gICAgICAgIH0pKSk7XG4gICAgICB9KTtcbiAgICB9LFxuICAgIGtleWRvd246IGZ1bmN0aW9uIGtleWRvd24oZXZlbnQpIHtcbiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zO1xuXG4gICAgICBpZiAoIW9wdGlvbnMua2V5Ym9hcmQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB2YXIga2V5Q29kZSA9IGV2ZW50LmtleUNvZGUgfHwgZXZlbnQud2hpY2ggfHwgZXZlbnQuY2hhckNvZGU7XG5cbiAgICAgIHN3aXRjaCAoa2V5Q29kZSkge1xuICAgICAgICAvLyBFbnRlclxuICAgICAgICBjYXNlIDEzOlxuICAgICAgICAgIGlmICh0aGlzLnZpZXdlci5jb250YWlucyhldmVudC50YXJnZXQpKSB7XG4gICAgICAgICAgICB0aGlzLmNsaWNrKGV2ZW50KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLmZ1bGxlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHN3aXRjaCAoa2V5Q29kZSkge1xuICAgICAgICAvLyBFc2NhcGVcbiAgICAgICAgY2FzZSAyNzpcbiAgICAgICAgICBpZiAodGhpcy5wbGF5ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5pbmxpbmUpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmZ1bGxlZCkge1xuICAgICAgICAgICAgICB0aGlzLmV4aXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIC8vIFNwYWNlXG5cbiAgICAgICAgY2FzZSAzMjpcbiAgICAgICAgICBpZiAodGhpcy5wbGF5ZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGJyZWFrO1xuICAgICAgICAvLyBBcnJvd0xlZnRcblxuICAgICAgICBjYXNlIDM3OlxuICAgICAgICAgIHRoaXMucHJldihvcHRpb25zLmxvb3ApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICAvLyBBcnJvd1VwXG5cbiAgICAgICAgY2FzZSAzODpcbiAgICAgICAgICAvLyBQcmV2ZW50IHNjcm9sbCBvbiBGaXJlZm94XG4gICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gWm9vbSBpblxuXG4gICAgICAgICAgdGhpcy56b29tKG9wdGlvbnMuem9vbVJhdGlvLCB0cnVlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgLy8gQXJyb3dSaWdodFxuXG4gICAgICAgIGNhc2UgMzk6XG4gICAgICAgICAgdGhpcy5uZXh0KG9wdGlvbnMubG9vcCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIC8vIEFycm93RG93blxuXG4gICAgICAgIGNhc2UgNDA6XG4gICAgICAgICAgLy8gUHJldmVudCBzY3JvbGwgb24gRmlyZWZveFxuICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vIFpvb20gb3V0XG5cbiAgICAgICAgICB0aGlzLnpvb20oLW9wdGlvbnMuem9vbVJhdGlvLCB0cnVlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgLy8gQ3RybCArIDBcblxuICAgICAgICBjYXNlIDQ4OiAvLyBGYWxsIHRocm91Z2hcbiAgICAgICAgLy8gQ3RybCArIDFcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWZhbGx0aHJvdWdoXG5cbiAgICAgICAgY2FzZSA0OTpcbiAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSkge1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSxcbiAgICBkcmFnc3RhcnQ6IGZ1bmN0aW9uIGRyYWdzdGFydChldmVudCkge1xuICAgICAgaWYgKGV2ZW50LnRhcmdldC5sb2NhbE5hbWUgPT09ICdpbWcnKSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBwb2ludGVyZG93bjogZnVuY3Rpb24gcG9pbnRlcmRvd24oZXZlbnQpIHtcbiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICAgIHBvaW50ZXJzID0gdGhpcy5wb2ludGVycztcbiAgICAgIHZhciBidXR0b25zID0gZXZlbnQuYnV0dG9ucyxcbiAgICAgICAgICBidXR0b24gPSBldmVudC5idXR0b247XG5cbiAgICAgIGlmICghdGhpcy52aWV3ZWQgfHwgdGhpcy5zaG93aW5nIHx8IHRoaXMudmlld2luZyB8fCB0aGlzLmhpZGluZyAvLyBIYW5kbGUgbW91c2UgZXZlbnQgYW5kIHBvaW50ZXIgZXZlbnQgYW5kIGlnbm9yZSB0b3VjaCBldmVudFxuICAgICAgfHwgKGV2ZW50LnR5cGUgPT09ICdtb3VzZWRvd24nIHx8IGV2ZW50LnR5cGUgPT09ICdwb2ludGVyZG93bicgJiYgZXZlbnQucG9pbnRlclR5cGUgPT09ICdtb3VzZScpICYmICggLy8gTm8gcHJpbWFyeSBidXR0b24gKFVzdWFsbHkgdGhlIGxlZnQgYnV0dG9uKVxuICAgICAgaXNOdW1iZXIoYnV0dG9ucykgJiYgYnV0dG9ucyAhPT0gMSB8fCBpc051bWJlcihidXR0b24pICYmIGJ1dHRvbiAhPT0gMCAvLyBPcGVuIGNvbnRleHQgbWVudVxuICAgICAgfHwgZXZlbnQuY3RybEtleSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSAvLyBQcmV2ZW50IGRlZmF1bHQgYmVoYXZpb3VycyBhcyBwYWdlIHpvb21pbmcgaW4gdG91Y2ggZGV2aWNlcy5cblxuXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICBpZiAoZXZlbnQuY2hhbmdlZFRvdWNoZXMpIHtcbiAgICAgICAgZm9yRWFjaChldmVudC5jaGFuZ2VkVG91Y2hlcywgZnVuY3Rpb24gKHRvdWNoKSB7XG4gICAgICAgICAgcG9pbnRlcnNbdG91Y2guaWRlbnRpZmllcl0gPSBnZXRQb2ludGVyKHRvdWNoKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwb2ludGVyc1tldmVudC5wb2ludGVySWQgfHwgMF0gPSBnZXRQb2ludGVyKGV2ZW50KTtcbiAgICAgIH1cblxuICAgICAgdmFyIGFjdGlvbiA9IG9wdGlvbnMubW92YWJsZSA/IEFDVElPTl9NT1ZFIDogZmFsc2U7XG5cbiAgICAgIGlmIChvcHRpb25zLnpvb21PblRvdWNoICYmIG9wdGlvbnMuem9vbWFibGUgJiYgT2JqZWN0LmtleXMocG9pbnRlcnMpLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgYWN0aW9uID0gQUNUSU9OX1pPT007XG4gICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuc2xpZGVPblRvdWNoICYmIChldmVudC5wb2ludGVyVHlwZSA9PT0gJ3RvdWNoJyB8fCBldmVudC50eXBlID09PSAndG91Y2hzdGFydCcpICYmIHRoaXMuaXNTd2l0Y2hhYmxlKCkpIHtcbiAgICAgICAgYWN0aW9uID0gQUNUSU9OX1NXSVRDSDtcbiAgICAgIH1cblxuICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbiAmJiAoYWN0aW9uID09PSBBQ1RJT05fTU9WRSB8fCBhY3Rpb24gPT09IEFDVElPTl9aT09NKSkge1xuICAgICAgICByZW1vdmVDbGFzcyh0aGlzLmltYWdlLCBDTEFTU19UUkFOU0lUSU9OKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hY3Rpb24gPSBhY3Rpb247XG4gICAgfSxcbiAgICBwb2ludGVybW92ZTogZnVuY3Rpb24gcG9pbnRlcm1vdmUoZXZlbnQpIHtcbiAgICAgIHZhciBwb2ludGVycyA9IHRoaXMucG9pbnRlcnMsXG4gICAgICAgICAgYWN0aW9uID0gdGhpcy5hY3Rpb247XG5cbiAgICAgIGlmICghdGhpcy52aWV3ZWQgfHwgIWFjdGlvbikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykge1xuICAgICAgICBmb3JFYWNoKGV2ZW50LmNoYW5nZWRUb3VjaGVzLCBmdW5jdGlvbiAodG91Y2gpIHtcbiAgICAgICAgICBhc3NpZ24ocG9pbnRlcnNbdG91Y2guaWRlbnRpZmllcl0gfHwge30sIGdldFBvaW50ZXIodG91Y2gsIHRydWUpKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhc3NpZ24ocG9pbnRlcnNbZXZlbnQucG9pbnRlcklkIHx8IDBdIHx8IHt9LCBnZXRQb2ludGVyKGV2ZW50LCB0cnVlKSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY2hhbmdlKGV2ZW50KTtcbiAgICB9LFxuICAgIHBvaW50ZXJ1cDogZnVuY3Rpb24gcG9pbnRlcnVwKGV2ZW50KSB7XG4gICAgICB2YXIgX3RoaXMyID0gdGhpcztcblxuICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgYWN0aW9uID0gdGhpcy5hY3Rpb24sXG4gICAgICAgICAgcG9pbnRlcnMgPSB0aGlzLnBvaW50ZXJzO1xuICAgICAgdmFyIHBvaW50ZXI7XG5cbiAgICAgIGlmIChldmVudC5jaGFuZ2VkVG91Y2hlcykge1xuICAgICAgICBmb3JFYWNoKGV2ZW50LmNoYW5nZWRUb3VjaGVzLCBmdW5jdGlvbiAodG91Y2gpIHtcbiAgICAgICAgICBwb2ludGVyID0gcG9pbnRlcnNbdG91Y2guaWRlbnRpZmllcl07XG4gICAgICAgICAgZGVsZXRlIHBvaW50ZXJzW3RvdWNoLmlkZW50aWZpZXJdO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBvaW50ZXIgPSBwb2ludGVyc1tldmVudC5wb2ludGVySWQgfHwgMF07XG4gICAgICAgIGRlbGV0ZSBwb2ludGVyc1tldmVudC5wb2ludGVySWQgfHwgMF07XG4gICAgICB9XG5cbiAgICAgIGlmICghYWN0aW9uKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbiAmJiAoYWN0aW9uID09PSBBQ1RJT05fTU9WRSB8fCBhY3Rpb24gPT09IEFDVElPTl9aT09NKSkge1xuICAgICAgICBhZGRDbGFzcyh0aGlzLmltYWdlLCBDTEFTU19UUkFOU0lUSU9OKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hY3Rpb24gPSBmYWxzZTsgLy8gRW11bGF0ZSBjbGljayBhbmQgZG91YmxlIGNsaWNrIGluIHRvdWNoIGRldmljZXMgdG8gc3VwcG9ydCBiYWNrZHJvcCBhbmQgaW1hZ2Ugem9vbWluZyAoIzIxMCkuXG5cbiAgICAgIGlmIChJU19UT1VDSF9ERVZJQ0UgJiYgYWN0aW9uICE9PSBBQ1RJT05fWk9PTSAmJiBwb2ludGVyICYmIERhdGUubm93KCkgLSBwb2ludGVyLnRpbWVTdGFtcCA8IDUwMCkge1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5jbGlja0NhbnZhc1RpbWVvdXQpO1xuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kb3VibGVDbGlja0ltYWdlVGltZW91dCk7XG5cbiAgICAgICAgaWYgKG9wdGlvbnMudG9nZ2xlT25EYmxjbGljayAmJiB0aGlzLnZpZXdlZCAmJiBldmVudC50YXJnZXQgPT09IHRoaXMuaW1hZ2UpIHtcbiAgICAgICAgICBpZiAodGhpcy5pbWFnZUNsaWNrZWQpIHtcbiAgICAgICAgICAgIHRoaXMuaW1hZ2VDbGlja2VkID0gZmFsc2U7IC8vIFRoaXMgdGltZW91dCB3aWxsIGJlIGNsZWFyZWQgbGF0ZXIgd2hlbiBhIG5hdGl2ZSBkYmxjbGljayBldmVudCBpcyB0cmlnZ2VyaW5nXG5cbiAgICAgICAgICAgIHRoaXMuZG91YmxlQ2xpY2tJbWFnZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgZGlzcGF0Y2hFdmVudChfdGhpczIuaW1hZ2UsIEVWRU5UX0RCTENMSUNLKTtcbiAgICAgICAgICAgIH0sIDUwKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5pbWFnZUNsaWNrZWQgPSB0cnVlOyAvLyBUaGUgZGVmYXVsdCB0aW1pbmcgb2YgYSBkb3VibGUgY2xpY2sgaW4gV2luZG93cyBpcyA1MDAgbXNcblxuICAgICAgICAgICAgdGhpcy5kb3VibGVDbGlja0ltYWdlVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICBfdGhpczIuaW1hZ2VDbGlja2VkID0gZmFsc2U7XG4gICAgICAgICAgICB9LCA1MDApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmltYWdlQ2xpY2tlZCA9IGZhbHNlO1xuXG4gICAgICAgICAgaWYgKG9wdGlvbnMuYmFja2Ryb3AgJiYgb3B0aW9ucy5iYWNrZHJvcCAhPT0gJ3N0YXRpYycgJiYgZXZlbnQudGFyZ2V0ID09PSB0aGlzLmNhbnZhcykge1xuICAgICAgICAgICAgLy8gVGhpcyB0aW1lb3V0IHdpbGwgYmUgY2xlYXJlZCBsYXRlciB3aGVuIGEgbmF0aXZlIGNsaWNrIGV2ZW50IGlzIHRyaWdnZXJpbmdcbiAgICAgICAgICAgIHRoaXMuY2xpY2tDYW52YXNUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQoX3RoaXMyLmNhbnZhcywgRVZFTlRfQ0xJQ0spO1xuICAgICAgICAgICAgfSwgNTApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgcmVzaXplOiBmdW5jdGlvbiByZXNpemUoKSB7XG4gICAgICB2YXIgX3RoaXMzID0gdGhpcztcblxuICAgICAgaWYgKCF0aGlzLmlzU2hvd24gfHwgdGhpcy5oaWRpbmcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5mdWxsZWQpIHtcbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICB0aGlzLmluaXRCb2R5KCk7XG4gICAgICAgIHRoaXMub3BlbigpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmluaXRDb250YWluZXIoKTtcbiAgICAgIHRoaXMuaW5pdFZpZXdlcigpO1xuICAgICAgdGhpcy5yZW5kZXJWaWV3ZXIoKTtcbiAgICAgIHRoaXMucmVuZGVyTGlzdCgpO1xuXG4gICAgICBpZiAodGhpcy52aWV3ZWQpIHtcbiAgICAgICAgdGhpcy5pbml0SW1hZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzMy5yZW5kZXJJbWFnZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMucGxheWVkKSB7XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiB0aGlzLmZ1bGxlZCAmJiAhKGRvY3VtZW50LmZ1bGxzY3JlZW5FbGVtZW50IHx8IGRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbGVtZW50IHx8IGRvY3VtZW50Lm1vekZ1bGxTY3JlZW5FbGVtZW50IHx8IGRvY3VtZW50Lm1zRnVsbHNjcmVlbkVsZW1lbnQpKSB7XG4gICAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yRWFjaCh0aGlzLnBsYXllci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaW1nJyksIGZ1bmN0aW9uIChpbWFnZSkge1xuICAgICAgICAgIGFkZExpc3RlbmVyKGltYWdlLCBFVkVOVF9MT0FELCBfdGhpczMubG9hZEltYWdlLmJpbmQoX3RoaXMzKSwge1xuICAgICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGRpc3BhdGNoRXZlbnQoaW1hZ2UsIEVWRU5UX0xPQUQpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LFxuICAgIHdoZWVsOiBmdW5jdGlvbiB3aGVlbChldmVudCkge1xuICAgICAgdmFyIF90aGlzNCA9IHRoaXM7XG5cbiAgICAgIGlmICghdGhpcy52aWV3ZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBMaW1pdCB3aGVlbCBzcGVlZCB0byBwcmV2ZW50IHpvb20gdG9vIGZhc3RcblxuICAgICAgaWYgKHRoaXMud2hlZWxpbmcpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLndoZWVsaW5nID0gdHJ1ZTtcbiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICBfdGhpczQud2hlZWxpbmcgPSBmYWxzZTtcbiAgICAgIH0sIDUwKTtcbiAgICAgIHZhciByYXRpbyA9IE51bWJlcih0aGlzLm9wdGlvbnMuem9vbVJhdGlvKSB8fCAwLjE7XG4gICAgICB2YXIgZGVsdGEgPSAxO1xuXG4gICAgICBpZiAoZXZlbnQuZGVsdGFZKSB7XG4gICAgICAgIGRlbHRhID0gZXZlbnQuZGVsdGFZID4gMCA/IDEgOiAtMTtcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQud2hlZWxEZWx0YSkge1xuICAgICAgICBkZWx0YSA9IC1ldmVudC53aGVlbERlbHRhIC8gMTIwO1xuICAgICAgfSBlbHNlIGlmIChldmVudC5kZXRhaWwpIHtcbiAgICAgICAgZGVsdGEgPSBldmVudC5kZXRhaWwgPiAwID8gMSA6IC0xO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnpvb20oLWRlbHRhICogcmF0aW8sIHRydWUsIGV2ZW50KTtcbiAgICB9XG4gIH07XG5cbiAgdmFyIG1ldGhvZHMgPSB7XG4gICAgLyoqIFNob3cgdGhlIHZpZXdlciAob25seSBhdmFpbGFibGUgaW4gbW9kYWwgbW9kZSlcbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtpbW1lZGlhdGU9ZmFsc2VdIC0gSW5kaWNhdGVzIGlmIHNob3cgdGhlIHZpZXdlciBpbW1lZGlhdGVseSBvciBub3QuXG4gICAgICogQHJldHVybnMge1ZpZXdlcn0gdGhpc1xuICAgICAqL1xuICAgIHNob3c6IGZ1bmN0aW9uIHNob3coKSB7XG4gICAgICB2YXIgaW1tZWRpYXRlID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTtcbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7XG5cbiAgICAgIGlmIChvcHRpb25zLmlubGluZSB8fCB0aGlzLnNob3dpbmcgfHwgdGhpcy5pc1Nob3duIHx8IHRoaXMuc2hvd2luZykge1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLnJlYWR5KSB7XG4gICAgICAgIHRoaXMuYnVpbGQoKTtcblxuICAgICAgICBpZiAodGhpcy5yZWFkeSkge1xuICAgICAgICAgIHRoaXMuc2hvdyhpbW1lZGlhdGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMuc2hvdykpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfU0hPVywgb3B0aW9ucy5zaG93LCB7XG4gICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpc3BhdGNoRXZlbnQoZWxlbWVudCwgRVZFTlRfU0hPVykgPT09IGZhbHNlIHx8ICF0aGlzLnJlYWR5KSB7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5oaWRpbmcpIHtcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uaW5nLmFib3J0KCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuc2hvd2luZyA9IHRydWU7XG4gICAgICB0aGlzLm9wZW4oKTtcbiAgICAgIHZhciB2aWV3ZXIgPSB0aGlzLnZpZXdlcjtcbiAgICAgIHJlbW92ZUNsYXNzKHZpZXdlciwgQ0xBU1NfSElERSk7XG4gICAgICB2aWV3ZXIuc2V0QXR0cmlidXRlKCdyb2xlJywgJ2RpYWxvZycpO1xuICAgICAgdmlld2VyLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbGxlZGJ5JywgdGhpcy50aXRsZS5pZCk7XG4gICAgICB2aWV3ZXIuc2V0QXR0cmlidXRlKCdhcmlhLW1vZGFsJywgdHJ1ZSk7XG4gICAgICB2aWV3ZXIucmVtb3ZlQXR0cmlidXRlKCdhcmlhLWhpZGRlbicpO1xuXG4gICAgICBpZiAob3B0aW9ucy50cmFuc2l0aW9uICYmICFpbW1lZGlhdGUpIHtcbiAgICAgICAgdmFyIHNob3duID0gdGhpcy5zaG93bi5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLnRyYW5zaXRpb25pbmcgPSB7XG4gICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkge1xuICAgICAgICAgICAgcmVtb3ZlTGlzdGVuZXIodmlld2VyLCBFVkVOVF9UUkFOU0lUSU9OX0VORCwgc2hvd24pO1xuICAgICAgICAgICAgcmVtb3ZlQ2xhc3Modmlld2VyLCBDTEFTU19JTik7XG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhZGRDbGFzcyh2aWV3ZXIsIENMQVNTX1RSQU5TSVRJT04pOyAvLyBGb3JjZSByZWZsb3cgdG8gZW5hYmxlIENTUzMgdHJhbnNpdGlvblxuXG4gICAgICAgIHZpZXdlci5pbml0aWFsT2Zmc2V0V2lkdGggPSB2aWV3ZXIub2Zmc2V0V2lkdGg7XG4gICAgICAgIGFkZExpc3RlbmVyKHZpZXdlciwgRVZFTlRfVFJBTlNJVElPTl9FTkQsIHNob3duLCB7XG4gICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgYWRkQ2xhc3Modmlld2VyLCBDTEFTU19JTik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhZGRDbGFzcyh2aWV3ZXIsIENMQVNTX0lOKTtcbiAgICAgICAgdGhpcy5zaG93bigpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSGlkZSB0aGUgdmlld2VyIChvbmx5IGF2YWlsYWJsZSBpbiBtb2RhbCBtb2RlKVxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ltbWVkaWF0ZT1mYWxzZV0gLSBJbmRpY2F0ZXMgaWYgaGlkZSB0aGUgdmlld2VyIGltbWVkaWF0ZWx5IG9yIG5vdC5cbiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSB0aGlzXG4gICAgICovXG4gICAgaGlkZTogZnVuY3Rpb24gaGlkZSgpIHtcbiAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG5cbiAgICAgIHZhciBpbW1lZGlhdGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlO1xuICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucztcblxuICAgICAgaWYgKG9wdGlvbnMuaW5saW5lIHx8IHRoaXMuaGlkaW5nIHx8ICEodGhpcy5pc1Nob3duIHx8IHRoaXMuc2hvd2luZykpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMuaGlkZSkpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfSElERSwgb3B0aW9ucy5oaWRlLCB7XG4gICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpc3BhdGNoRXZlbnQoZWxlbWVudCwgRVZFTlRfSElERSkgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5zaG93aW5nKSB7XG4gICAgICAgIHRoaXMudHJhbnNpdGlvbmluZy5hYm9ydCgpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmhpZGluZyA9IHRydWU7XG5cbiAgICAgIGlmICh0aGlzLnBsYXllZCkge1xuICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy52aWV3aW5nKSB7XG4gICAgICAgIHRoaXMudmlld2luZy5hYm9ydCgpO1xuICAgICAgfVxuXG4gICAgICB2YXIgdmlld2VyID0gdGhpcy52aWV3ZXIsXG4gICAgICAgICAgaW1hZ2UgPSB0aGlzLmltYWdlO1xuXG4gICAgICB2YXIgaGlkZUltbWVkaWF0ZWx5ID0gZnVuY3Rpb24gaGlkZUltbWVkaWF0ZWx5KCkge1xuICAgICAgICByZW1vdmVDbGFzcyh2aWV3ZXIsIENMQVNTX0lOKTtcblxuICAgICAgICBfdGhpcy5oaWRkZW4oKTtcbiAgICAgIH07XG5cbiAgICAgIGlmIChvcHRpb25zLnRyYW5zaXRpb24gJiYgIWltbWVkaWF0ZSkge1xuICAgICAgICB2YXIgb25WaWV3ZXJUcmFuc2l0aW9uRW5kID0gZnVuY3Rpb24gb25WaWV3ZXJUcmFuc2l0aW9uRW5kKGV2ZW50KSB7XG4gICAgICAgICAgLy8gSWdub3JlIGFsbCBwcm9wYWdhdGluZyBgdHJhbnNpdGlvbmVuZGAgZXZlbnRzICgjMjc1KS5cbiAgICAgICAgICBpZiAoZXZlbnQgJiYgZXZlbnQudGFyZ2V0ID09PSB2aWV3ZXIpIHtcbiAgICAgICAgICAgIHJlbW92ZUxpc3RlbmVyKHZpZXdlciwgRVZFTlRfVFJBTlNJVElPTl9FTkQsIG9uVmlld2VyVHJhbnNpdGlvbkVuZCk7XG5cbiAgICAgICAgICAgIF90aGlzLmhpZGRlbigpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgb25JbWFnZVRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbiBvbkltYWdlVHJhbnNpdGlvbkVuZCgpIHtcbiAgICAgICAgICAvLyBJbiBjYXNlIG9mIHNob3cgdGhlIHZpZXdlciBieSBgdmlld2VyLnNob3codHJ1ZSlgIHByZXZpb3VzbHkgKCM0MDcpLlxuICAgICAgICAgIGlmIChoYXNDbGFzcyh2aWV3ZXIsIENMQVNTX1RSQU5TSVRJT04pKSB7XG4gICAgICAgICAgICBhZGRMaXN0ZW5lcih2aWV3ZXIsIEVWRU5UX1RSQU5TSVRJT05fRU5ELCBvblZpZXdlclRyYW5zaXRpb25FbmQpO1xuICAgICAgICAgICAgcmVtb3ZlQ2xhc3Modmlld2VyLCBDTEFTU19JTik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGhpZGVJbW1lZGlhdGVseSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnRyYW5zaXRpb25pbmcgPSB7XG4gICAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uIGFib3J0KCkge1xuICAgICAgICAgICAgaWYgKF90aGlzLnZpZXdlZCAmJiBoYXNDbGFzcyhpbWFnZSwgQ0xBU1NfVFJBTlNJVElPTikpIHtcbiAgICAgICAgICAgICAgcmVtb3ZlTGlzdGVuZXIoaW1hZ2UsIEVWRU5UX1RSQU5TSVRJT05fRU5ELCBvbkltYWdlVHJhbnNpdGlvbkVuZCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGhhc0NsYXNzKHZpZXdlciwgQ0xBU1NfVFJBTlNJVElPTikpIHtcbiAgICAgICAgICAgICAgcmVtb3ZlTGlzdGVuZXIodmlld2VyLCBFVkVOVF9UUkFOU0lUSU9OX0VORCwgb25WaWV3ZXJUcmFuc2l0aW9uRW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH07IC8vIEluIGNhc2Ugb2YgaGlkaW5nIHRoZSB2aWV3ZXIgd2hlbiBob2xkaW5nIG9uIHRoZSBpbWFnZSAoIzI1NSksXG4gICAgICAgIC8vIG5vdGUgdGhhdCB0aGUgYENMQVNTX1RSQU5TSVRJT05gIGNsYXNzIHdpbGwgYmUgcmVtb3ZlZCBvbiBwb2ludGVyIGRvd24uXG5cbiAgICAgICAgaWYgKHRoaXMudmlld2VkICYmIGhhc0NsYXNzKGltYWdlLCBDTEFTU19UUkFOU0lUSU9OKSkge1xuICAgICAgICAgIGFkZExpc3RlbmVyKGltYWdlLCBFVkVOVF9UUkFOU0lUSU9OX0VORCwgb25JbWFnZVRyYW5zaXRpb25FbmQsIHtcbiAgICAgICAgICAgIG9uY2U6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLnpvb21UbygwLCBmYWxzZSwgbnVsbCwgdHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb25JbWFnZVRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGlkZUltbWVkaWF0ZWx5KCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBWaWV3IG9uZSBvZiB0aGUgaW1hZ2VzIHdpdGggaW1hZ2UncyBpbmRleFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgaW1hZ2UgdG8gdmlldy5cbiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSB0aGlzXG4gICAgICovXG4gICAgdmlldzogZnVuY3Rpb24gdmlldygpIHtcbiAgICAgIHZhciBfdGhpczIgPSB0aGlzO1xuXG4gICAgICB2YXIgaW5kZXggPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IHRoaXMub3B0aW9ucy5pbml0aWFsVmlld0luZGV4O1xuICAgICAgaW5kZXggPSBOdW1iZXIoaW5kZXgpIHx8IDA7XG5cbiAgICAgIGlmICh0aGlzLmhpZGluZyB8fCB0aGlzLnBsYXllZCB8fCBpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5sZW5ndGggfHwgdGhpcy52aWV3ZWQgJiYgaW5kZXggPT09IHRoaXMuaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5pc1Nob3duKSB7XG4gICAgICAgIHRoaXMuaW5kZXggPSBpbmRleDtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2hvdygpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy52aWV3aW5nKSB7XG4gICAgICAgIHRoaXMudmlld2luZy5hYm9ydCgpO1xuICAgICAgfVxuXG4gICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zLFxuICAgICAgICAgIHRpdGxlID0gdGhpcy50aXRsZSxcbiAgICAgICAgICBjYW52YXMgPSB0aGlzLmNhbnZhcztcbiAgICAgIHZhciBpdGVtID0gdGhpcy5pdGVtc1tpbmRleF07XG4gICAgICB2YXIgaW1nID0gaXRlbS5xdWVyeVNlbGVjdG9yKCdpbWcnKTtcbiAgICAgIHZhciB1cmwgPSBnZXREYXRhKGltZywgJ29yaWdpbmFsVXJsJyk7XG4gICAgICB2YXIgYWx0ID0gaW1nLmdldEF0dHJpYnV0ZSgnYWx0Jyk7XG4gICAgICB2YXIgaW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgICAgIGZvckVhY2gob3B0aW9ucy5pbmhlcml0ZWRBdHRyaWJ1dGVzLCBmdW5jdGlvbiAobmFtZSkge1xuICAgICAgICB2YXIgdmFsdWUgPSBpbWcuZ2V0QXR0cmlidXRlKG5hbWUpO1xuXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgIGltYWdlLnNldEF0dHJpYnV0ZShuYW1lLCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaW1hZ2Uuc3JjID0gdXJsO1xuICAgICAgaW1hZ2UuYWx0ID0gYWx0O1xuXG4gICAgICBpZiAoaXNGdW5jdGlvbihvcHRpb25zLnZpZXcpKSB7XG4gICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIEVWRU5UX1ZJRVcsIG9wdGlvbnMudmlldywge1xuICAgICAgICAgIG9uY2U6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaXNwYXRjaEV2ZW50KGVsZW1lbnQsIEVWRU5UX1ZJRVcsIHtcbiAgICAgICAgb3JpZ2luYWxJbWFnZTogdGhpcy5pbWFnZXNbaW5kZXhdLFxuICAgICAgICBpbmRleDogaW5kZXgsXG4gICAgICAgIGltYWdlOiBpbWFnZVxuICAgICAgfSkgPT09IGZhbHNlIHx8ICF0aGlzLmlzU2hvd24gfHwgdGhpcy5oaWRpbmcgfHwgdGhpcy5wbGF5ZWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIHZhciBhY3RpdmVJdGVtID0gdGhpcy5pdGVtc1t0aGlzLmluZGV4XTtcblxuICAgICAgaWYgKGFjdGl2ZUl0ZW0pIHtcbiAgICAgICAgcmVtb3ZlQ2xhc3MoYWN0aXZlSXRlbSwgQ0xBU1NfQUNUSVZFKTtcbiAgICAgICAgYWN0aXZlSXRlbS5yZW1vdmVBdHRyaWJ1dGUoJ2FyaWEtc2VsZWN0ZWQnKTtcbiAgICAgIH1cblxuICAgICAgYWRkQ2xhc3MoaXRlbSwgQ0xBU1NfQUNUSVZFKTtcbiAgICAgIGl0ZW0uc2V0QXR0cmlidXRlKCdhcmlhLXNlbGVjdGVkJywgdHJ1ZSk7XG5cbiAgICAgIGlmIChvcHRpb25zLmZvY3VzKSB7XG4gICAgICAgIGl0ZW0uZm9jdXMoKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5pbWFnZSA9IGltYWdlO1xuICAgICAgdGhpcy52aWV3ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuaW5kZXggPSBpbmRleDtcbiAgICAgIHRoaXMuaW1hZ2VEYXRhID0ge307XG4gICAgICBhZGRDbGFzcyhpbWFnZSwgQ0xBU1NfSU5WSVNJQkxFKTtcblxuICAgICAgaWYgKG9wdGlvbnMubG9hZGluZykge1xuICAgICAgICBhZGRDbGFzcyhjYW52YXMsIENMQVNTX0xPQURJTkcpO1xuICAgICAgfVxuXG4gICAgICBjYW52YXMuaW5uZXJIVE1MID0gJyc7XG4gICAgICBjYW52YXMuYXBwZW5kQ2hpbGQoaW1hZ2UpOyAvLyBDZW50ZXIgY3VycmVudCBpdGVtXG5cbiAgICAgIHRoaXMucmVuZGVyTGlzdCgpOyAvLyBDbGVhciB0aXRsZVxuXG4gICAgICB0aXRsZS5pbm5lckhUTUwgPSAnJzsgLy8gR2VuZXJhdGUgdGl0bGUgYWZ0ZXIgdmlld2VkXG5cbiAgICAgIHZhciBvblZpZXdlZCA9IGZ1bmN0aW9uIG9uVmlld2VkKCkge1xuICAgICAgICB2YXIgaW1hZ2VEYXRhID0gX3RoaXMyLmltYWdlRGF0YTtcbiAgICAgICAgdmFyIHJlbmRlciA9IEFycmF5LmlzQXJyYXkob3B0aW9ucy50aXRsZSkgPyBvcHRpb25zLnRpdGxlWzFdIDogb3B0aW9ucy50aXRsZTtcbiAgICAgICAgdGl0bGUuaW5uZXJIVE1MID0gZXNjYXBlSFRNTEVudGl0aWVzKGlzRnVuY3Rpb24ocmVuZGVyKSA/IHJlbmRlci5jYWxsKF90aGlzMiwgaW1hZ2UsIGltYWdlRGF0YSkgOiBcIlwiLmNvbmNhdChhbHQsIFwiIChcIikuY29uY2F0KGltYWdlRGF0YS5uYXR1cmFsV2lkdGgsIFwiIFxceEQ3IFwiKS5jb25jYXQoaW1hZ2VEYXRhLm5hdHVyYWxIZWlnaHQsIFwiKVwiKSk7XG4gICAgICB9O1xuXG4gICAgICB2YXIgb25Mb2FkO1xuICAgICAgdmFyIG9uRXJyb3I7XG4gICAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBFVkVOVF9WSUVXRUQsIG9uVmlld2VkLCB7XG4gICAgICAgIG9uY2U6IHRydWVcbiAgICAgIH0pO1xuICAgICAgdGhpcy52aWV3aW5nID0ge1xuICAgICAgICBhYm9ydDogZnVuY3Rpb24gYWJvcnQoKSB7XG4gICAgICAgICAgcmVtb3ZlTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfVklFV0VELCBvblZpZXdlZCk7XG5cbiAgICAgICAgICBpZiAoaW1hZ2UuY29tcGxldGUpIHtcbiAgICAgICAgICAgIGlmIChfdGhpczIuaW1hZ2VSZW5kZXJpbmcpIHtcbiAgICAgICAgICAgICAgX3RoaXMyLmltYWdlUmVuZGVyaW5nLmFib3J0KCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKF90aGlzMi5pbWFnZUluaXRpYWxpemluZykge1xuICAgICAgICAgICAgICBfdGhpczIuaW1hZ2VJbml0aWFsaXppbmcuYWJvcnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gQ2FuY2VsIGRvd25sb2FkIHRvIHNhdmUgYmFuZHdpZHRoLlxuICAgICAgICAgICAgaW1hZ2Uuc3JjID0gJyc7XG4gICAgICAgICAgICByZW1vdmVMaXN0ZW5lcihpbWFnZSwgRVZFTlRfTE9BRCwgb25Mb2FkKTtcblxuICAgICAgICAgICAgaWYgKF90aGlzMi50aW1lb3V0KSB7XG4gICAgICAgICAgICAgIGNsZWFyVGltZW91dChfdGhpczIudGltZW91dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBpZiAoaW1hZ2UuY29tcGxldGUpIHtcbiAgICAgICAgdGhpcy5sb2FkKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhZGRMaXN0ZW5lcihpbWFnZSwgRVZFTlRfTE9BRCwgb25Mb2FkID0gZnVuY3Rpb24gb25Mb2FkKCkge1xuICAgICAgICAgIHJlbW92ZUxpc3RlbmVyKGltYWdlLCBFVkVOVF9FUlJPUiwgb25FcnJvcik7XG5cbiAgICAgICAgICBfdGhpczIubG9hZCgpO1xuICAgICAgICB9LCB7XG4gICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgYWRkTGlzdGVuZXIoaW1hZ2UsIEVWRU5UX0VSUk9SLCBvbkVycm9yID0gZnVuY3Rpb24gb25FcnJvcigpIHtcbiAgICAgICAgICByZW1vdmVMaXN0ZW5lcihpbWFnZSwgRVZFTlRfTE9BRCwgb25Mb2FkKTtcblxuICAgICAgICAgIGlmIChfdGhpczIudGltZW91dCkge1xuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KF90aGlzMi50aW1lb3V0KTtcbiAgICAgICAgICAgIF90aGlzMi50aW1lb3V0ID0gZmFsc2U7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmVtb3ZlQ2xhc3MoaW1hZ2UsIENMQVNTX0lOVklTSUJMRSk7XG5cbiAgICAgICAgICBpZiAob3B0aW9ucy5sb2FkaW5nKSB7XG4gICAgICAgICAgICByZW1vdmVDbGFzcyhfdGhpczIuY2FudmFzLCBDTEFTU19MT0FESU5HKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIHtcbiAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLnRpbWVvdXQpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcbiAgICAgICAgfSAvLyBNYWtlIHRoZSBpbWFnZSB2aXNpYmxlIGlmIGl0IGZhaWxzIHRvIGxvYWQgd2l0aGluIDFzXG5cblxuICAgICAgICB0aGlzLnRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICByZW1vdmVDbGFzcyhpbWFnZSwgQ0xBU1NfSU5WSVNJQkxFKTtcbiAgICAgICAgICBfdGhpczIudGltZW91dCA9IGZhbHNlO1xuICAgICAgICB9LCAxMDAwKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFZpZXcgdGhlIHByZXZpb3VzIGltYWdlXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBJbmRpY2F0ZSBpZiB2aWV3IHRoZSBsYXN0IG9uZVxuICAgICAqIHdoZW4gaXQgaXMgdGhlIGZpcnN0IG9uZSBhdCBwcmVzZW50LlxuICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IHRoaXNcbiAgICAgKi9cbiAgICBwcmV2OiBmdW5jdGlvbiBwcmV2KCkge1xuICAgICAgdmFyIGxvb3AgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlO1xuICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleCAtIDE7XG5cbiAgICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgICAgaW5kZXggPSBsb29wID8gdGhpcy5sZW5ndGggLSAxIDogMDtcbiAgICAgIH1cblxuICAgICAgdGhpcy52aWV3KGluZGV4KTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBWaWV3IHRoZSBuZXh0IGltYWdlXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBJbmRpY2F0ZSBpZiB2aWV3IHRoZSBmaXJzdCBvbmVcbiAgICAgKiB3aGVuIGl0IGlzIHRoZSBsYXN0IG9uZSBhdCBwcmVzZW50LlxuICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IHRoaXNcbiAgICAgKi9cbiAgICBuZXh0OiBmdW5jdGlvbiBuZXh0KCkge1xuICAgICAgdmFyIGxvb3AgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiBhcmd1bWVudHNbMF0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1swXSA6IGZhbHNlO1xuICAgICAgdmFyIG1heEluZGV4ID0gdGhpcy5sZW5ndGggLSAxO1xuICAgICAgdmFyIGluZGV4ID0gdGhpcy5pbmRleCArIDE7XG5cbiAgICAgIGlmIChpbmRleCA+IG1heEluZGV4KSB7XG4gICAgICAgIGluZGV4ID0gbG9vcCA/IDAgOiBtYXhJbmRleDtcbiAgICAgIH1cblxuICAgICAgdGhpcy52aWV3KGluZGV4KTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBNb3ZlIHRoZSBpbWFnZSB3aXRoIHJlbGF0aXZlIG9mZnNldHMuXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgbW92aW5nIGRpc3RhbmNlIGluIHRoZSBob3Jpem9udGFsIGRpcmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3k9eF0gVGhlIG1vdmluZyBkaXN0YW5jZSBpbiB0aGUgdmVydGljYWwgZGlyZWN0aW9uLlxuICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IHRoaXNcbiAgICAgKi9cbiAgICBtb3ZlOiBmdW5jdGlvbiBtb3ZlKHgpIHtcbiAgICAgIHZhciB5ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiB4O1xuICAgICAgdmFyIGltYWdlRGF0YSA9IHRoaXMuaW1hZ2VEYXRhO1xuICAgICAgdGhpcy5tb3ZlVG8oaXNVbmRlZmluZWQoeCkgPyB4IDogaW1hZ2VEYXRhLnggKyBOdW1iZXIoeCksIGlzVW5kZWZpbmVkKHkpID8geSA6IGltYWdlRGF0YS55ICsgTnVtYmVyKHkpKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBNb3ZlIHRoZSBpbWFnZSB0byBhbiBhYnNvbHV0ZSBwb2ludC5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBuZXcgcG9zaXRpb24gaW4gdGhlIGhvcml6b250YWwgZGlyZWN0aW9uLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeT14XSAtIFRoZSBuZXcgcG9zaXRpb24gaW4gdGhlIHZlcnRpY2FsIGRpcmVjdGlvbi5cbiAgICAgKiBAcGFyYW0ge0V2ZW50fSBbX29yaWdpbmFsRXZlbnQ9bnVsbF0gLSBUaGUgb3JpZ2luYWwgZXZlbnQgaWYgYW55LlxuICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IHRoaXNcbiAgICAgKi9cbiAgICBtb3ZlVG86IGZ1bmN0aW9uIG1vdmVUbyh4KSB7XG4gICAgICB2YXIgX3RoaXMzID0gdGhpcztcblxuICAgICAgdmFyIHkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHg7XG5cbiAgICAgIHZhciBfb3JpZ2luYWxFdmVudCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDtcblxuICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyxcbiAgICAgICAgICBpbWFnZURhdGEgPSB0aGlzLmltYWdlRGF0YTtcbiAgICAgIHggPSBOdW1iZXIoeCk7XG4gICAgICB5ID0gTnVtYmVyKHkpO1xuXG4gICAgICBpZiAodGhpcy52aWV3ZWQgJiYgIXRoaXMucGxheWVkICYmIG9wdGlvbnMubW92YWJsZSkge1xuICAgICAgICB2YXIgb2xkWCA9IGltYWdlRGF0YS54O1xuICAgICAgICB2YXIgb2xkWSA9IGltYWdlRGF0YS55O1xuICAgICAgICB2YXIgY2hhbmdlZCA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChpc051bWJlcih4KSkge1xuICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHggPSBvbGRYO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlzTnVtYmVyKHkpKSB7XG4gICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgeSA9IG9sZFk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMubW92ZSkpIHtcbiAgICAgICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIEVWRU5UX01PVkUsIG9wdGlvbnMubW92ZSwge1xuICAgICAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoZGlzcGF0Y2hFdmVudChlbGVtZW50LCBFVkVOVF9NT1ZFLCB7XG4gICAgICAgICAgICB4OiB4LFxuICAgICAgICAgICAgeTogeSxcbiAgICAgICAgICAgIG9sZFg6IG9sZFgsXG4gICAgICAgICAgICBvbGRZOiBvbGRZLFxuICAgICAgICAgICAgb3JpZ2luYWxFdmVudDogX29yaWdpbmFsRXZlbnRcbiAgICAgICAgICB9KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGltYWdlRGF0YS54ID0geDtcbiAgICAgICAgICBpbWFnZURhdGEueSA9IHk7XG4gICAgICAgICAgaW1hZ2VEYXRhLmxlZnQgPSB4O1xuICAgICAgICAgIGltYWdlRGF0YS50b3AgPSB5O1xuICAgICAgICAgIHRoaXMubW92aW5nID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLnJlbmRlckltYWdlKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIF90aGlzMy5tb3ZpbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob3B0aW9ucy5tb3ZlZCkpIHtcbiAgICAgICAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfTU9WRUQsIG9wdGlvbnMubW92ZWQsIHtcbiAgICAgICAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGVsZW1lbnQsIEVWRU5UX01PVkVELCB7XG4gICAgICAgICAgICAgIHg6IHgsXG4gICAgICAgICAgICAgIHk6IHksXG4gICAgICAgICAgICAgIG9sZFg6IG9sZFgsXG4gICAgICAgICAgICAgIG9sZFk6IG9sZFksXG4gICAgICAgICAgICAgIG9yaWdpbmFsRXZlbnQ6IF9vcmlnaW5hbEV2ZW50XG4gICAgICAgICAgICB9LCB7XG4gICAgICAgICAgICAgIGNhbmNlbGFibGU6IGZhbHNlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUm90YXRlIHRoZSBpbWFnZSB3aXRoIGEgcmVsYXRpdmUgZGVncmVlLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWdyZWUgLSBUaGUgcm90YXRlIGRlZ3JlZS5cbiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSB0aGlzXG4gICAgICovXG4gICAgcm90YXRlOiBmdW5jdGlvbiByb3RhdGUoZGVncmVlKSB7XG4gICAgICB0aGlzLnJvdGF0ZVRvKCh0aGlzLmltYWdlRGF0YS5yb3RhdGUgfHwgMCkgKyBOdW1iZXIoZGVncmVlKSk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUm90YXRlIHRoZSBpbWFnZSB0byBhbiBhYnNvbHV0ZSBkZWdyZWUuXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGRlZ3JlZSAtIFRoZSByb3RhdGUgZGVncmVlLlxuICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IHRoaXNcbiAgICAgKi9cbiAgICByb3RhdGVUbzogZnVuY3Rpb24gcm90YXRlVG8oZGVncmVlKSB7XG4gICAgICB2YXIgX3RoaXM0ID0gdGhpcztcblxuICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyxcbiAgICAgICAgICBpbWFnZURhdGEgPSB0aGlzLmltYWdlRGF0YTtcbiAgICAgIGRlZ3JlZSA9IE51bWJlcihkZWdyZWUpO1xuXG4gICAgICBpZiAoaXNOdW1iZXIoZGVncmVlKSAmJiB0aGlzLnZpZXdlZCAmJiAhdGhpcy5wbGF5ZWQgJiYgb3B0aW9ucy5yb3RhdGFibGUpIHtcbiAgICAgICAgdmFyIG9sZERlZ3JlZSA9IGltYWdlRGF0YS5yb3RhdGU7XG5cbiAgICAgICAgaWYgKGlzRnVuY3Rpb24ob3B0aW9ucy5yb3RhdGUpKSB7XG4gICAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfUk9UQVRFLCBvcHRpb25zLnJvdGF0ZSwge1xuICAgICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRpc3BhdGNoRXZlbnQoZWxlbWVudCwgRVZFTlRfUk9UQVRFLCB7XG4gICAgICAgICAgZGVncmVlOiBkZWdyZWUsXG4gICAgICAgICAgb2xkRGVncmVlOiBvbGREZWdyZWVcbiAgICAgICAgfSkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cblxuICAgICAgICBpbWFnZURhdGEucm90YXRlID0gZGVncmVlO1xuICAgICAgICB0aGlzLnJvdGF0aW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yZW5kZXJJbWFnZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgX3RoaXM0LnJvdGF0aW5nID0gZmFsc2U7XG5cbiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihvcHRpb25zLnJvdGF0ZWQpKSB7XG4gICAgICAgICAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBFVkVOVF9ST1RBVEVELCBvcHRpb25zLnJvdGF0ZWQsIHtcbiAgICAgICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGlzcGF0Y2hFdmVudChlbGVtZW50LCBFVkVOVF9ST1RBVEVELCB7XG4gICAgICAgICAgICBkZWdyZWU6IGRlZ3JlZSxcbiAgICAgICAgICAgIG9sZERlZ3JlZTogb2xkRGVncmVlXG4gICAgICAgICAgfSwge1xuICAgICAgICAgICAgY2FuY2VsYWJsZTogZmFsc2VcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTY2FsZSB0aGUgaW1hZ2Ugb24gdGhlIHgtYXhpcy5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGVYIC0gVGhlIHNjYWxlIHJhdGlvIG9uIHRoZSB4LWF4aXMuXG4gICAgICogQHJldHVybnMge1ZpZXdlcn0gdGhpc1xuICAgICAqL1xuICAgIHNjYWxlWDogZnVuY3Rpb24gc2NhbGVYKF9zY2FsZVgpIHtcbiAgICAgIHRoaXMuc2NhbGUoX3NjYWxlWCwgdGhpcy5pbWFnZURhdGEuc2NhbGVZKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTY2FsZSB0aGUgaW1hZ2Ugb24gdGhlIHktYXhpcy5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGVZIC0gVGhlIHNjYWxlIHJhdGlvIG9uIHRoZSB5LWF4aXMuXG4gICAgICogQHJldHVybnMge1ZpZXdlcn0gdGhpc1xuICAgICAqL1xuICAgIHNjYWxlWTogZnVuY3Rpb24gc2NhbGVZKF9zY2FsZVkpIHtcbiAgICAgIHRoaXMuc2NhbGUodGhpcy5pbWFnZURhdGEuc2NhbGVYLCBfc2NhbGVZKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTY2FsZSB0aGUgaW1hZ2UuXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxlWCAtIFRoZSBzY2FsZSByYXRpbyBvbiB0aGUgeC1heGlzLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc2NhbGVZPXNjYWxlWF0gLSBUaGUgc2NhbGUgcmF0aW8gb24gdGhlIHktYXhpcy5cbiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSB0aGlzXG4gICAgICovXG4gICAgc2NhbGU6IGZ1bmN0aW9uIHNjYWxlKHNjYWxlWCkge1xuICAgICAgdmFyIF90aGlzNSA9IHRoaXM7XG5cbiAgICAgIHZhciBzY2FsZVkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiBhcmd1bWVudHNbMV0gIT09IHVuZGVmaW5lZCA/IGFyZ3VtZW50c1sxXSA6IHNjYWxlWDtcbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgaW1hZ2VEYXRhID0gdGhpcy5pbWFnZURhdGE7XG4gICAgICBzY2FsZVggPSBOdW1iZXIoc2NhbGVYKTtcbiAgICAgIHNjYWxlWSA9IE51bWJlcihzY2FsZVkpO1xuXG4gICAgICBpZiAodGhpcy52aWV3ZWQgJiYgIXRoaXMucGxheWVkICYmIG9wdGlvbnMuc2NhbGFibGUpIHtcbiAgICAgICAgdmFyIG9sZFNjYWxlWCA9IGltYWdlRGF0YS5zY2FsZVg7XG4gICAgICAgIHZhciBvbGRTY2FsZVkgPSBpbWFnZURhdGEuc2NhbGVZO1xuICAgICAgICB2YXIgY2hhbmdlZCA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChpc051bWJlcihzY2FsZVgpKSB7XG4gICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc2NhbGVYID0gb2xkU2NhbGVYO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGlzTnVtYmVyKHNjYWxlWSkpIHtcbiAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzY2FsZVkgPSBvbGRTY2FsZVk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMuc2NhbGUpKSB7XG4gICAgICAgICAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBFVkVOVF9TQ0FMRSwgb3B0aW9ucy5zY2FsZSwge1xuICAgICAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoZGlzcGF0Y2hFdmVudChlbGVtZW50LCBFVkVOVF9TQ0FMRSwge1xuICAgICAgICAgICAgc2NhbGVYOiBzY2FsZVgsXG4gICAgICAgICAgICBzY2FsZVk6IHNjYWxlWSxcbiAgICAgICAgICAgIG9sZFNjYWxlWDogb2xkU2NhbGVYLFxuICAgICAgICAgICAgb2xkU2NhbGVZOiBvbGRTY2FsZVlcbiAgICAgICAgICB9KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGltYWdlRGF0YS5zY2FsZVggPSBzY2FsZVg7XG4gICAgICAgICAgaW1hZ2VEYXRhLnNjYWxlWSA9IHNjYWxlWTtcbiAgICAgICAgICB0aGlzLnNjYWxpbmcgPSB0cnVlO1xuICAgICAgICAgIHRoaXMucmVuZGVySW1hZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgX3RoaXM1LnNjYWxpbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24ob3B0aW9ucy5zY2FsZWQpKSB7XG4gICAgICAgICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIEVWRU5UX1NDQUxFRCwgb3B0aW9ucy5zY2FsZWQsIHtcbiAgICAgICAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBkaXNwYXRjaEV2ZW50KGVsZW1lbnQsIEVWRU5UX1NDQUxFRCwge1xuICAgICAgICAgICAgICBzY2FsZVg6IHNjYWxlWCxcbiAgICAgICAgICAgICAgc2NhbGVZOiBzY2FsZVksXG4gICAgICAgICAgICAgIG9sZFNjYWxlWDogb2xkU2NhbGVYLFxuICAgICAgICAgICAgICBvbGRTY2FsZVk6IG9sZFNjYWxlWVxuICAgICAgICAgICAgfSwge1xuICAgICAgICAgICAgICBjYW5jZWxhYmxlOiBmYWxzZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFpvb20gdGhlIGltYWdlIHdpdGggYSByZWxhdGl2ZSByYXRpby5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcmF0aW8gLSBUaGUgdGFyZ2V0IHJhdGlvLlxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2hhc1Rvb2x0aXA9ZmFsc2VdIC0gSW5kaWNhdGVzIGlmIGl0IGhhcyBhIHRvb2x0aXAgb3Igbm90LlxuICAgICAqIEBwYXJhbSB7RXZlbnR9IFtfb3JpZ2luYWxFdmVudD1udWxsXSAtIFRoZSBvcmlnaW5hbCBldmVudCBpZiBhbnkuXG4gICAgICogQHJldHVybnMge1ZpZXdlcn0gdGhpc1xuICAgICAqL1xuICAgIHpvb206IGZ1bmN0aW9uIHpvb20ocmF0aW8pIHtcbiAgICAgIHZhciBoYXNUb29sdGlwID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgYXJndW1lbnRzWzFdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMV0gOiBmYWxzZTtcblxuICAgICAgdmFyIF9vcmlnaW5hbEV2ZW50ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiBudWxsO1xuXG4gICAgICB2YXIgaW1hZ2VEYXRhID0gdGhpcy5pbWFnZURhdGE7XG4gICAgICByYXRpbyA9IE51bWJlcihyYXRpbyk7XG5cbiAgICAgIGlmIChyYXRpbyA8IDApIHtcbiAgICAgICAgcmF0aW8gPSAxIC8gKDEgLSByYXRpbyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByYXRpbyA9IDEgKyByYXRpbztcbiAgICAgIH1cblxuICAgICAgdGhpcy56b29tVG8oaW1hZ2VEYXRhLndpZHRoICogcmF0aW8gLyBpbWFnZURhdGEubmF0dXJhbFdpZHRoLCBoYXNUb29sdGlwLCBfb3JpZ2luYWxFdmVudCk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogWm9vbSB0aGUgaW1hZ2UgdG8gYW4gYWJzb2x1dGUgcmF0aW8uXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHJhdGlvIC0gVGhlIHRhcmdldCByYXRpby5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtoYXNUb29sdGlwPWZhbHNlXSAtIEluZGljYXRlcyBpZiBpdCBoYXMgYSB0b29sdGlwIG9yIG5vdC5cbiAgICAgKiBAcGFyYW0ge0V2ZW50fSBbX29yaWdpbmFsRXZlbnQ9bnVsbF0gLSBUaGUgb3JpZ2luYWwgZXZlbnQgaWYgYW55LlxuICAgICAqIEBwYXJhbSB7RXZlbnR9IFtfem9vbWFibGU9ZmFsc2VdIC0gSW5kaWNhdGVzIGlmIHRoZSBjdXJyZW50IHpvb20gaXMgYXZhaWxhYmxlIG9yIG5vdC5cbiAgICAgKiBAcmV0dXJucyB7Vmlld2VyfSB0aGlzXG4gICAgICovXG4gICAgem9vbVRvOiBmdW5jdGlvbiB6b29tVG8ocmF0aW8pIHtcbiAgICAgIHZhciBfdGhpczYgPSB0aGlzO1xuXG4gICAgICB2YXIgaGFzVG9vbHRpcCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIGFyZ3VtZW50c1sxXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzFdIDogZmFsc2U7XG5cbiAgICAgIHZhciBfb3JpZ2luYWxFdmVudCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIGFyZ3VtZW50c1syXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzJdIDogbnVsbDtcblxuICAgICAgdmFyIF96b29tYWJsZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIGFyZ3VtZW50c1szXSAhPT0gdW5kZWZpbmVkID8gYXJndW1lbnRzWzNdIDogZmFsc2U7XG5cbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgcG9pbnRlcnMgPSB0aGlzLnBvaW50ZXJzLFxuICAgICAgICAgIGltYWdlRGF0YSA9IHRoaXMuaW1hZ2VEYXRhO1xuICAgICAgdmFyIHggPSBpbWFnZURhdGEueCxcbiAgICAgICAgICB5ID0gaW1hZ2VEYXRhLnksXG4gICAgICAgICAgd2lkdGggPSBpbWFnZURhdGEud2lkdGgsXG4gICAgICAgICAgaGVpZ2h0ID0gaW1hZ2VEYXRhLmhlaWdodCxcbiAgICAgICAgICBuYXR1cmFsV2lkdGggPSBpbWFnZURhdGEubmF0dXJhbFdpZHRoLFxuICAgICAgICAgIG5hdHVyYWxIZWlnaHQgPSBpbWFnZURhdGEubmF0dXJhbEhlaWdodDtcbiAgICAgIHJhdGlvID0gTWF0aC5tYXgoMCwgcmF0aW8pO1xuXG4gICAgICBpZiAoaXNOdW1iZXIocmF0aW8pICYmIHRoaXMudmlld2VkICYmICF0aGlzLnBsYXllZCAmJiAoX3pvb21hYmxlIHx8IG9wdGlvbnMuem9vbWFibGUpKSB7XG4gICAgICAgIGlmICghX3pvb21hYmxlKSB7XG4gICAgICAgICAgdmFyIG1pblpvb21SYXRpbyA9IE1hdGgubWF4KDAuMDEsIG9wdGlvbnMubWluWm9vbVJhdGlvKTtcbiAgICAgICAgICB2YXIgbWF4Wm9vbVJhdGlvID0gTWF0aC5taW4oMTAwLCBvcHRpb25zLm1heFpvb21SYXRpbyk7XG4gICAgICAgICAgcmF0aW8gPSBNYXRoLm1pbihNYXRoLm1heChyYXRpbywgbWluWm9vbVJhdGlvKSwgbWF4Wm9vbVJhdGlvKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChfb3JpZ2luYWxFdmVudCAmJiBvcHRpb25zLnpvb21SYXRpbyA+PSAwLjA1NSAmJiByYXRpbyA+IDAuOTUgJiYgcmF0aW8gPCAxLjA1KSB7XG4gICAgICAgICAgcmF0aW8gPSAxO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIG5ld1dpZHRoID0gbmF0dXJhbFdpZHRoICogcmF0aW87XG4gICAgICAgIHZhciBuZXdIZWlnaHQgPSBuYXR1cmFsSGVpZ2h0ICogcmF0aW87XG4gICAgICAgIHZhciBvZmZzZXRXaWR0aCA9IG5ld1dpZHRoIC0gd2lkdGg7XG4gICAgICAgIHZhciBvZmZzZXRIZWlnaHQgPSBuZXdIZWlnaHQgLSBoZWlnaHQ7XG4gICAgICAgIHZhciBvbGRSYXRpbyA9IGltYWdlRGF0YS5yYXRpbztcblxuICAgICAgICBpZiAoaXNGdW5jdGlvbihvcHRpb25zLnpvb20pKSB7XG4gICAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfWk9PTSwgb3B0aW9ucy56b29tLCB7XG4gICAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGlzcGF0Y2hFdmVudChlbGVtZW50LCBFVkVOVF9aT09NLCB7XG4gICAgICAgICAgcmF0aW86IHJhdGlvLFxuICAgICAgICAgIG9sZFJhdGlvOiBvbGRSYXRpbyxcbiAgICAgICAgICBvcmlnaW5hbEV2ZW50OiBfb3JpZ2luYWxFdmVudFxuICAgICAgICB9KSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuem9vbWluZyA9IHRydWU7XG5cbiAgICAgICAgaWYgKF9vcmlnaW5hbEV2ZW50KSB7XG4gICAgICAgICAgdmFyIG9mZnNldCA9IGdldE9mZnNldCh0aGlzLnZpZXdlcik7XG4gICAgICAgICAgdmFyIGNlbnRlciA9IHBvaW50ZXJzICYmIE9iamVjdC5rZXlzKHBvaW50ZXJzKS5sZW5ndGggPyBnZXRQb2ludGVyc0NlbnRlcihwb2ludGVycykgOiB7XG4gICAgICAgICAgICBwYWdlWDogX29yaWdpbmFsRXZlbnQucGFnZVgsXG4gICAgICAgICAgICBwYWdlWTogX29yaWdpbmFsRXZlbnQucGFnZVlcbiAgICAgICAgICB9OyAvLyBab29tIGZyb20gdGhlIHRyaWdnZXJpbmcgcG9pbnQgb2YgdGhlIGV2ZW50XG5cbiAgICAgICAgICBpbWFnZURhdGEueCAtPSBvZmZzZXRXaWR0aCAqICgoY2VudGVyLnBhZ2VYIC0gb2Zmc2V0LmxlZnQgLSB4KSAvIHdpZHRoKTtcbiAgICAgICAgICBpbWFnZURhdGEueSAtPSBvZmZzZXRIZWlnaHQgKiAoKGNlbnRlci5wYWdlWSAtIG9mZnNldC50b3AgLSB5KSAvIGhlaWdodCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gWm9vbSBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIGltYWdlXG4gICAgICAgICAgaW1hZ2VEYXRhLnggLT0gb2Zmc2V0V2lkdGggLyAyO1xuICAgICAgICAgIGltYWdlRGF0YS55IC09IG9mZnNldEhlaWdodCAvIDI7XG4gICAgICAgIH1cblxuICAgICAgICBpbWFnZURhdGEubGVmdCA9IGltYWdlRGF0YS54O1xuICAgICAgICBpbWFnZURhdGEudG9wID0gaW1hZ2VEYXRhLnk7XG4gICAgICAgIGltYWdlRGF0YS53aWR0aCA9IG5ld1dpZHRoO1xuICAgICAgICBpbWFnZURhdGEuaGVpZ2h0ID0gbmV3SGVpZ2h0O1xuICAgICAgICBpbWFnZURhdGEub2xkUmF0aW8gPSBvbGRSYXRpbztcbiAgICAgICAgaW1hZ2VEYXRhLnJhdGlvID0gcmF0aW87XG4gICAgICAgIHRoaXMucmVuZGVySW1hZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzNi56b29taW5nID0gZmFsc2U7XG5cbiAgICAgICAgICBpZiAoaXNGdW5jdGlvbihvcHRpb25zLnpvb21lZCkpIHtcbiAgICAgICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIEVWRU5UX1pPT01FRCwgb3B0aW9ucy56b29tZWQsIHtcbiAgICAgICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGlzcGF0Y2hFdmVudChlbGVtZW50LCBFVkVOVF9aT09NRUQsIHtcbiAgICAgICAgICAgIHJhdGlvOiByYXRpbyxcbiAgICAgICAgICAgIG9sZFJhdGlvOiBvbGRSYXRpbyxcbiAgICAgICAgICAgIG9yaWdpbmFsRXZlbnQ6IF9vcmlnaW5hbEV2ZW50XG4gICAgICAgICAgfSwge1xuICAgICAgICAgICAgY2FuY2VsYWJsZTogZmFsc2VcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKGhhc1Rvb2x0aXApIHtcbiAgICAgICAgICB0aGlzLnRvb2x0aXAoKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUGxheSB0aGUgaW1hZ2VzXG4gICAgICogQHBhcmFtIHtib29sZWFufEZ1bGxzY3JlZW5PcHRpb25zfSBbZnVsbHNjcmVlbj1mYWxzZV0gLSBJbmRpY2F0ZSBpZiByZXF1ZXN0IGZ1bGxzY3JlZW4gb3Igbm90LlxuICAgICAqIEByZXR1cm5zIHtWaWV3ZXJ9IHRoaXNcbiAgICAgKi9cbiAgICBwbGF5OiBmdW5jdGlvbiBwbGF5KCkge1xuICAgICAgdmFyIF90aGlzNyA9IHRoaXM7XG5cbiAgICAgIHZhciBmdWxsc2NyZWVuID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgYXJndW1lbnRzWzBdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMF0gOiBmYWxzZTtcblxuICAgICAgaWYgKCF0aGlzLmlzU2hvd24gfHwgdGhpcy5wbGF5ZWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5lbGVtZW50LFxuICAgICAgICAgIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7XG5cbiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMucGxheSkpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgRVZFTlRfUExBWSwgb3B0aW9ucy5wbGF5LCB7XG4gICAgICAgICAgb25jZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKGRpc3BhdGNoRXZlbnQoZWxlbWVudCwgRVZFTlRfUExBWSkgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuXG4gICAgICB2YXIgcGxheWVyID0gdGhpcy5wbGF5ZXI7XG4gICAgICB2YXIgb25Mb2FkID0gdGhpcy5sb2FkSW1hZ2UuYmluZCh0aGlzKTtcbiAgICAgIHZhciBsaXN0ID0gW107XG4gICAgICB2YXIgdG90YWwgPSAwO1xuICAgICAgdmFyIGluZGV4ID0gMDtcbiAgICAgIHRoaXMucGxheWVkID0gdHJ1ZTtcbiAgICAgIHRoaXMub25Mb2FkV2hlblBsYXkgPSBvbkxvYWQ7XG5cbiAgICAgIGlmIChmdWxsc2NyZWVuKSB7XG4gICAgICAgIHRoaXMucmVxdWVzdEZ1bGxzY3JlZW4oZnVsbHNjcmVlbik7XG4gICAgICB9XG5cbiAgICAgIGFkZENsYXNzKHBsYXllciwgQ0xBU1NfU0hPVyk7XG4gICAgICBmb3JFYWNoKHRoaXMuaXRlbXMsIGZ1bmN0aW9uIChpdGVtLCBpKSB7XG4gICAgICAgIHZhciBpbWcgPSBpdGVtLnF1ZXJ5U2VsZWN0b3IoJ2ltZycpO1xuICAgICAgICB2YXIgaW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgICAgICAgaW1hZ2Uuc3JjID0gZ2V0RGF0YShpbWcsICdvcmlnaW5hbFVybCcpO1xuICAgICAgICBpbWFnZS5hbHQgPSBpbWcuZ2V0QXR0cmlidXRlKCdhbHQnKTtcbiAgICAgICAgaW1hZ2UucmVmZXJyZXJQb2xpY3kgPSBpbWcucmVmZXJyZXJQb2xpY3k7XG4gICAgICAgIHRvdGFsICs9IDE7XG4gICAgICAgIGFkZENsYXNzKGltYWdlLCBDTEFTU19GQURFKTtcbiAgICAgICAgdG9nZ2xlQ2xhc3MoaW1hZ2UsIENMQVNTX1RSQU5TSVRJT04sIG9wdGlvbnMudHJhbnNpdGlvbik7XG5cbiAgICAgICAgaWYgKGhhc0NsYXNzKGl0ZW0sIENMQVNTX0FDVElWRSkpIHtcbiAgICAgICAgICBhZGRDbGFzcyhpbWFnZSwgQ0xBU1NfSU4pO1xuICAgICAgICAgIGluZGV4ID0gaTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxpc3QucHVzaChpbWFnZSk7XG4gICAgICAgIGFkZExpc3RlbmVyKGltYWdlLCBFVkVOVF9MT0FELCBvbkxvYWQsIHtcbiAgICAgICAgICBvbmNlOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICBwbGF5ZXIuYXBwZW5kQ2hpbGQoaW1hZ2UpO1xuICAgICAgfSk7XG5cbiAgICAgIGlmIChpc051bWJlcihvcHRpb25zLmludGVydmFsKSAmJiBvcHRpb25zLmludGVydmFsID4gMCkge1xuICAgICAgICB2YXIgcGxheSA9IGZ1bmN0aW9uIHBsYXkoKSB7XG4gICAgICAgICAgX3RoaXM3LnBsYXlpbmcgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJlbW92ZUNsYXNzKGxpc3RbaW5kZXhdLCBDTEFTU19JTik7XG4gICAgICAgICAgICBpbmRleCArPSAxO1xuICAgICAgICAgICAgaW5kZXggPSBpbmRleCA8IHRvdGFsID8gaW5kZXggOiAwO1xuICAgICAgICAgICAgYWRkQ2xhc3MobGlzdFtpbmRleF0sIENMQVNTX0lOKTtcbiAgICAgICAgICAgIHBsYXkoKTtcbiAgICAgICAgICB9LCBvcHRpb25zLmludGVydmFsKTtcbiAgICAgICAgfTtcblxuICAgICAgICBpZiAodG90YWwgPiAxKSB7XG4gICAgICAgICAgcGxheSgpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG4gICAgLy8gU3RvcCBwbGF5XG4gICAgc3RvcDogZnVuY3Rpb24gc3RvcCgpIHtcbiAgICAgIHZhciBfdGhpczggPSB0aGlzO1xuXG4gICAgICBpZiAoIXRoaXMucGxheWVkKSB7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuXG4gICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZWxlbWVudCxcbiAgICAgICAgICBvcHRpb25zID0gdGhpcy5vcHRpb25zO1xuXG4gICAgICBpZiAoaXNGdW5jdGlvbihvcHRpb25zLnN0b3ApKSB7XG4gICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIEVWRU5UX1NUT1AsIG9wdGlvbnMuc3RvcCwge1xuICAgICAgICAgIG9uY2U6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChkaXNwYXRjaEV2ZW50KGVsZW1lbnQsIEVWRU5UX1NUT1ApID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH1cblxuICAgICAgdmFyIHBsYXllciA9IHRoaXMucGxheWVyO1xuICAgICAgdGhpcy5wbGF5ZWQgPSBmYWxzZTtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnBsYXlpbmcpO1xuICAgICAgZm9yRWFjaChwbGF5ZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2ltZycpLCBmdW5jdGlvbiAoaW1hZ2UpIHtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoaW1hZ2UsIEVWRU5UX0xPQUQsIF90aGlzOC5vbkxvYWRXaGVuUGxheSk7XG4gICAgICB9KTtcbiAgICAgIHJlbW92ZUNsYXNzKHBsYXllciwgQ0xBU1NfU0hPVyk7XG4gICAgICBwbGF5ZXIuaW5uZXJIVE1MID0gJyc7XG4gICAgICB0aGlzLmV4aXRGdWxsc2NyZWVuKCk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuICAgIC8vIEVudGVyIG1vZGFsIG1vZGUgKG9ubHkgYXZhaWxhYmxlIGluIGlubGluZSBtb2RlKVxuICAgIGZ1bGw6IGZ1bmN0aW9uIGZ1bGwoKSB7XG4gICAgICB2YXIgX3RoaXM5ID0gdGhpcztcblxuICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgdmlld2VyID0gdGhpcy52aWV3ZXIsXG4gICAgICAgICAgaW1hZ2UgPSB0aGlzLmltYWdlLFxuICAgICAgICAgIGxpc3QgPSB0aGlzLmxpc3Q7XG5cbiAgICAgIGlmICghdGhpcy5pc1Nob3duIHx8IHRoaXMucGxheWVkIHx8IHRoaXMuZnVsbGVkIHx8ICFvcHRpb25zLmlubGluZSkge1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH1cblxuICAgICAgdGhpcy5mdWxsZWQgPSB0cnVlO1xuICAgICAgdGhpcy5vcGVuKCk7XG4gICAgICBhZGRDbGFzcyh0aGlzLmJ1dHRvbiwgQ0xBU1NfRlVMTFNDUkVFTl9FWElUKTtcblxuICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbikge1xuICAgICAgICByZW1vdmVDbGFzcyhsaXN0LCBDTEFTU19UUkFOU0lUSU9OKTtcblxuICAgICAgICBpZiAodGhpcy52aWV3ZWQpIHtcbiAgICAgICAgICByZW1vdmVDbGFzcyhpbWFnZSwgQ0xBU1NfVFJBTlNJVElPTik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgYWRkQ2xhc3Modmlld2VyLCBDTEFTU19GSVhFRCk7XG4gICAgICB2aWV3ZXIuc2V0QXR0cmlidXRlKCdyb2xlJywgJ2RpYWxvZycpO1xuICAgICAgdmlld2VyLnNldEF0dHJpYnV0ZSgnYXJpYS1sYWJlbGxlZGJ5JywgdGhpcy50aXRsZS5pZCk7XG4gICAgICB2aWV3ZXIuc2V0QXR0cmlidXRlKCdhcmlhLW1vZGFsJywgdHJ1ZSk7XG4gICAgICB2aWV3ZXIucmVtb3ZlQXR0cmlidXRlKCdzdHlsZScpO1xuICAgICAgc2V0U3R5bGUodmlld2VyLCB7XG4gICAgICAgIHpJbmRleDogb3B0aW9ucy56SW5kZXhcbiAgICAgIH0pO1xuXG4gICAgICBpZiAob3B0aW9ucy5mb2N1cykge1xuICAgICAgICB0aGlzLmVuZm9yY2VGb2N1cygpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmluaXRDb250YWluZXIoKTtcbiAgICAgIHRoaXMudmlld2VyRGF0YSA9IGFzc2lnbih7fSwgdGhpcy5jb250YWluZXJEYXRhKTtcbiAgICAgIHRoaXMucmVuZGVyTGlzdCgpO1xuXG4gICAgICBpZiAodGhpcy52aWV3ZWQpIHtcbiAgICAgICAgdGhpcy5pbml0SW1hZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzOS5yZW5kZXJJbWFnZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy50cmFuc2l0aW9uKSB7XG4gICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGFkZENsYXNzKGltYWdlLCBDTEFTU19UUkFOU0lUSU9OKTtcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhsaXN0LCBDTEFTU19UUkFOU0lUSU9OKTtcbiAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuICAgIC8vIEV4aXQgbW9kYWwgbW9kZSAob25seSBhdmFpbGFibGUgaW4gaW5saW5lIG1vZGUpXG4gICAgZXhpdDogZnVuY3Rpb24gZXhpdCgpIHtcbiAgICAgIHZhciBfdGhpczEwID0gdGhpcztcblxuICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsXG4gICAgICAgICAgdmlld2VyID0gdGhpcy52aWV3ZXIsXG4gICAgICAgICAgaW1hZ2UgPSB0aGlzLmltYWdlLFxuICAgICAgICAgIGxpc3QgPSB0aGlzLmxpc3Q7XG5cbiAgICAgIGlmICghdGhpcy5pc1Nob3duIHx8IHRoaXMucGxheWVkIHx8ICF0aGlzLmZ1bGxlZCB8fCAhb3B0aW9ucy5pbmxpbmUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZnVsbGVkID0gZmFsc2U7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICByZW1vdmVDbGFzcyh0aGlzLmJ1dHRvbiwgQ0xBU1NfRlVMTFNDUkVFTl9FWElUKTtcblxuICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbikge1xuICAgICAgICByZW1vdmVDbGFzcyhsaXN0LCBDTEFTU19UUkFOU0lUSU9OKTtcblxuICAgICAgICBpZiAodGhpcy52aWV3ZWQpIHtcbiAgICAgICAgICByZW1vdmVDbGFzcyhpbWFnZSwgQ0xBU1NfVFJBTlNJVElPTik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG9wdGlvbnMuZm9jdXMpIHtcbiAgICAgICAgdGhpcy5jbGVhckVuZm9yY2VGb2N1cygpO1xuICAgICAgfVxuXG4gICAgICB2aWV3ZXIucmVtb3ZlQXR0cmlidXRlKCdyb2xlJyk7XG4gICAgICB2aWV3ZXIucmVtb3ZlQXR0cmlidXRlKCdhcmlhLWxhYmVsbGVkYnknKTtcbiAgICAgIHZpZXdlci5yZW1vdmVBdHRyaWJ1dGUoJ2FyaWEtbW9kYWwnKTtcbiAgICAgIHJlbW92ZUNsYXNzKHZpZXdlciwgQ0xBU1NfRklYRUQpO1xuICAgICAgc2V0U3R5bGUodmlld2VyLCB7XG4gICAgICAgIHpJbmRleDogb3B0aW9ucy56SW5kZXhJbmxpbmVcbiAgICAgIH0pO1xuICAgICAgdGhpcy52aWV3ZXJEYXRhID0gYXNzaWduKHt9LCB0aGlzLnBhcmVudERhdGEpO1xuICAgICAgdGhpcy5yZW5kZXJWaWV3ZXIoKTtcbiAgICAgIHRoaXMucmVuZGVyTGlzdCgpO1xuXG4gICAgICBpZiAodGhpcy52aWV3ZWQpIHtcbiAgICAgICAgdGhpcy5pbml0SW1hZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIF90aGlzMTAucmVuZGVySW1hZ2UoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMudHJhbnNpdGlvbikge1xuICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBhZGRDbGFzcyhpbWFnZSwgQ0xBU1NfVFJBTlNJVElPTik7XG4gICAgICAgICAgICAgICAgYWRkQ2xhc3MobGlzdCwgQ0xBU1NfVFJBTlNJVElPTik7XG4gICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcbiAgICAvLyBTaG93IHRoZSBjdXJyZW50IHJhdGlvIG9mIHRoZSBpbWFnZSB3aXRoIHBlcmNlbnRhZ2VcbiAgICB0b29sdGlwOiBmdW5jdGlvbiB0b29sdGlwKCkge1xuICAgICAgdmFyIF90aGlzMTEgPSB0aGlzO1xuXG4gICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucyxcbiAgICAgICAgICB0b29sdGlwQm94ID0gdGhpcy50b29sdGlwQm94LFxuICAgICAgICAgIGltYWdlRGF0YSA9IHRoaXMuaW1hZ2VEYXRhO1xuXG4gICAgICBpZiAoIXRoaXMudmlld2VkIHx8IHRoaXMucGxheWVkIHx8ICFvcHRpb25zLnRvb2x0aXApIHtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICB9XG5cbiAgICAgIHRvb2x0aXBCb3gudGV4dENvbnRlbnQgPSBcIlwiLmNvbmNhdChNYXRoLnJvdW5kKGltYWdlRGF0YS5yYXRpbyAqIDEwMCksIFwiJVwiKTtcblxuICAgICAgaWYgKCF0aGlzLnRvb2x0aXBwaW5nKSB7XG4gICAgICAgIGlmIChvcHRpb25zLnRyYW5zaXRpb24pIHtcbiAgICAgICAgICBpZiAodGhpcy5mYWRpbmcpIHtcbiAgICAgICAgICAgIGRpc3BhdGNoRXZlbnQodG9vbHRpcEJveCwgRVZFTlRfVFJBTlNJVElPTl9FTkQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGFkZENsYXNzKHRvb2x0aXBCb3gsIENMQVNTX1NIT1cpO1xuICAgICAgICAgIGFkZENsYXNzKHRvb2x0aXBCb3gsIENMQVNTX0ZBREUpO1xuICAgICAgICAgIGFkZENsYXNzKHRvb2x0aXBCb3gsIENMQVNTX1RSQU5TSVRJT04pO1xuICAgICAgICAgIHRvb2x0aXBCb3gucmVtb3ZlQXR0cmlidXRlKCdhcmlhLWhpZGRlbicpOyAvLyBGb3JjZSByZWZsb3cgdG8gZW5hYmxlIENTUzMgdHJhbnNpdGlvblxuXG4gICAgICAgICAgdG9vbHRpcEJveC5pbml0aWFsT2Zmc2V0V2lkdGggPSB0b29sdGlwQm94Lm9mZnNldFdpZHRoO1xuICAgICAgICAgIGFkZENsYXNzKHRvb2x0aXBCb3gsIENMQVNTX0lOKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhZGRDbGFzcyh0b29sdGlwQm94LCBDTEFTU19TSE9XKTtcbiAgICAgICAgICB0b29sdGlwQm94LnJlbW92ZUF0dHJpYnV0ZSgnYXJpYS1oaWRkZW4nKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudG9vbHRpcHBpbmcpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnRvb2x0aXBwaW5nID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChvcHRpb25zLnRyYW5zaXRpb24pIHtcbiAgICAgICAgICBhZGRMaXN0ZW5lcih0b29sdGlwQm94LCBFVkVOVF9UUkFOU0lUSU9OX0VORCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmVtb3ZlQ2xhc3ModG9vbHRpcEJveCwgQ0xBU1NfU0hPVyk7XG4gICAgICAgICAgICByZW1vdmVDbGFzcyh0b29sdGlwQm94LCBDTEFTU19GQURFKTtcbiAgICAgICAgICAgIHJlbW92ZUNsYXNzKHRvb2x0aXBCb3gsIENMQVNTX1RSQU5TSVRJT04pO1xuICAgICAgICAgICAgdG9vbHRpcEJveC5zZXRBdHRyaWJ1dGUoJ2FyaWEtaGlkZGVuJywgdHJ1ZSk7XG4gICAgICAgICAgICBfdGhpczExLmZhZGluZyA9IGZhbHNlO1xuICAgICAgICAgIH0sIHtcbiAgICAgICAgICAgIG9uY2U6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgICByZW1vdmVDbGFzcyh0b29sdGlwQm94LCBDTEFTU19JTik7XG4gICAgICAgICAgX3RoaXMxMS5mYWRpbmcgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlbW92ZUNsYXNzKHRvb2x0aXBCb3gsIENMQVNTX1NIT1cpO1xuICAgICAgICAgIHRvb2x0aXBCb3guc2V0QXR0cmlidXRlKCdhcmlhLWhpZGRlbicsIHRydWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgX3RoaXMxMS50b29sdGlwcGluZyA9IGZhbHNlO1xuICAgICAgfSwgMTAwMCk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVG9nZ2xlIHRoZSBpbWFnZSBzaXplIGJldHdlZW4gaXRzIGN1cnJlbnQgc2l6ZSBhbmQgbmF0dXJhbCBzaXplXG4gICAgICogQHBhcmFtIHtFdmVudH0gW19vcmlnaW5hbEV2ZW50PW5