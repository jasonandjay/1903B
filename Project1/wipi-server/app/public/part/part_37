.$parent;\n      var parentName = parent.$options.componentName;\n      while (parentName !== 'ElForm') {\n        if (parentName === 'ElFormItem') {\n          this.isNested = true;\n        }\n        parent = parent.$parent;\n        parentName = parent.$options.componentName;\n      }\n      return parent;\n    },\n    fieldValue: function fieldValue() {\n      var model = this.form.model;\n      if (!model || !this.prop) {\n        return;\n      }\n\n      var path = this.prop;\n      if (path.indexOf(':') !== -1) {\n        path = path.replace(/:/, '.');\n      }\n\n      return Object(util_[\"getPropByPath\"])(model, path, true).v;\n    },\n    isRequired: function isRequired() {\n      var rules = this.getRules();\n      var isRequired = false;\n\n      if (rules && rules.length) {\n        rules.every(function (rule) {\n          if (rule.required) {\n            isRequired = true;\n            return false;\n          }\n          return true;\n        });\n      }\n      return isRequired;\n    },\n    _formSize: function _formSize() {\n      return this.elForm.size;\n    },\n    elFormItemSize: function elFormItemSize() {\n      return this.size || this._formSize;\n    },\n    sizeClass: function sizeClass() {\n      return this.elFormItemSize || (this.$ELEMENT || {}).size;\n    }\n  },\n  data: function data() {\n    return {\n      validateState: '',\n      validateMessage: '',\n      validateDisabled: false,\n      validator: {},\n      isNested: false,\n      computedLabelWidth: ''\n    };\n  },\n\n  methods: {\n    validate: function validate(trigger) {\n      var _this = this;\n\n      var callback = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : util_[\"noop\"];\n\n      this.validateDisabled = false;\n      var rules = this.getFilteredRule(trigger);\n      if ((!rules || rules.length === 0) && this.required === undefined) {\n        callback();\n        return true;\n      }\n\n      this.validateState = 'validating';\n\n      var descriptor = {};\n      if (rules && rules.length > 0) {\n        rules.forEach(function (rule) {\n          delete rule.trigger;\n        });\n      }\n      descriptor[this.prop] = rules;\n\n      var validator = new external_async_validator_default.a(descriptor);\n      var model = {};\n\n      model[this.prop] = this.fieldValue;\n\n      validator.validate(model, { firstFields: true }, function (errors, invalidFields) {\n        _this.validateState = !errors ? 'success' : 'error';\n        _this.validateMessage = errors ? errors[0].message : '';\n\n        callback(_this.validateMessage, invalidFields);\n        _this.elForm && _this.elForm.$emit('validate', _this.prop, !errors, _this.validateMessage || null);\n      });\n    },\n    clearValidate: function clearValidate() {\n      this.validateState = '';\n      this.validateMessage = '';\n      this.validateDisabled = false;\n    },\n    resetField: function resetField() {\n      var _this2 = this;\n\n      this.validateState = '';\n      this.validateMessage = '';\n\n      var model = this.form.model;\n      var value = this.fieldValue;\n      var path = this.prop;\n      if (path.indexOf(':') !== -1) {\n        path = path.replace(/:/, '.');\n      }\n\n      var prop = Object(util_[\"getPropByPath\"])(model, path, true);\n\n      this.validateDisabled = true;\n      if (Array.isArray(value)) {\n        prop.o[prop.k] = [].concat(this.initialValue);\n      } else {\n        prop.o[prop.k] = this.initialValue;\n      }\n\n      // reset validateDisabled after onFieldChange triggered\n      this.$nextTick(function () {\n        _this2.validateDisabled = false;\n      });\n\n      this.broadcast('ElTimeSelect', 'fieldReset', this.initialValue);\n    },\n    getRules: function getRules() {\n      var formRules = this.form.rules;\n      var selfRules = this.rules;\n      var requiredRule = this.required !== undefined ? { required: !!this.required } : [];\n\n      var prop = Object(util_[\"getPropByPath\"])(formRules, this.prop || '');\n      formRules = formRules ? prop.o[this.prop || ''] || prop.v : [];\n\n      return [].concat(selfRules || formRules || []).concat(requiredRule);\n    },\n    getFilteredRule: function getFilteredRule(trigger) {\n      var rules = this.getRules();\n\n      return rules.filter(function (rule) {\n        if (!rule.trigger || trigger === '') return true;\n        if (Array.isArray(rule.trigger)) {\n          return rule.trigger.indexOf(trigger) > -1;\n        } else {\n          return rule.trigger === trigger;\n        }\n      }).map(function (rule) {\n        return merge_default()({}, rule);\n      });\n    },\n    onFieldBlur: function onFieldBlur() {\n      this.validate('blur');\n    },\n    onFieldChange: function onFieldChange() {\n      if (this.validateDisabled) {\n        this.validateDisabled = false;\n        return;\n      }\n\n      this.validate('change');\n    },\n    updateComputedLabelWidth: function updateComputedLabelWidth(width) {\n      this.computedLabelWidth = width ? width + 'px' : '';\n    },\n    addValidateEvents: function addValidateEvents() {\n      var rules = this.getRules();\n\n      if (rules.length || this.required !== undefined) {\n        this.$on('el.form.blur', this.onFieldBlur);\n        this.$on('el.form.change', this.onFieldChange);\n      }\n    },\n    removeValidateEvents: function removeValidateEvents() {\n      this.$off();\n    }\n  },\n  mounted: function mounted() {\n    if (this.prop) {\n      this.dispatch('ElForm', 'el.form.addField', [this]);\n\n      var initialValue = this.fieldValue;\n      if (Array.isArray(initialValue)) {\n        initialValue = [].concat(initialValue);\n      }\n      Object.defineProperty(this, 'initialValue', {\n        value: initialValue\n      });\n\n      this.addValidateEvents();\n    }\n  },\n  beforeDestroy: function beforeDestroy() {\n    this.dispatch('ElForm', 'el.form.removeField', [this]);\n  }\n});\n// CONCATENATED MODULE: ./packages/form/src/form-item.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_form_itemvue_type_script_lang_js_ = (form_itemvue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/form/src/form-item.vue\n\n\n\n\n\n/* normalize component */\n\nvar form_item_component = normalizeComponent(\n  src_form_itemvue_type_script_lang_js_,\n  form_itemvue_type_template_id_b6f3db6c_render,\n  form_itemvue_type_template_id_b6f3db6c_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var form_item_api; }\nform_item_component.options.__file = \"packages/form/src/form-item.vue\"\n/* harmony default export */ var form_item = (form_item_component.exports);\n// CONCATENATED MODULE: ./packages/form-item/index.js\n\n\n/* istanbul ignore next */\nform_item.install = function (Vue) {\n  Vue.component(form_item.name, form_item);\n};\n\n/* harmony default export */ var packages_form_item = (form_item);\n// CONCATENATED MODULE: ./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/vue-loader/lib??vue-loader-options!./packages/tabs/src/tab-bar.vue?vue&type=template&id=2031f33a&\nvar tab_barvue_type_template_id_2031f33a_render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  return _c(\"div\", {\n    staticClass: \"el-tabs__active-bar\",\n    class: \"is-\" + _vm.rootTabs.tabPosition,\n    style: _vm.barStyle\n  })\n}\nvar tab_barvue_type_template_id_2031f33a_staticRenderFns = []\ntab_barvue_type_template_id_2031f33a_render._withStripped = true\n\n\n// CONCATENATED MODULE: ./packages/tabs/src/tab-bar.vue?vue&type=template&id=2031f33a&\n\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tabs/src/tab-bar.vue?vue&type=script&lang=js&\n//\n//\n//\n\n\n/* harmony default export */ var tab_barvue_type_script_lang_js_ = ({\n  name: 'TabBar',\n\n  props: {\n    tabs: Array\n  },\n\n  inject: ['rootTabs'],\n\n  computed: {\n    barStyle: {\n      get: function get() {\n        var _this = this;\n\n        var style = {};\n        var offset = 0;\n        var tabSize = 0;\n        var sizeName = ['top', 'bottom'].indexOf(this.rootTabs.tabPosition) !== -1 ? 'width' : 'height';\n        var sizeDir = sizeName === 'width' ? 'x' : 'y';\n        var firstUpperCase = function firstUpperCase(str) {\n          return str.toLowerCase().replace(/( |^)[a-z]/g, function (L) {\n            return L.toUpperCase();\n          });\n        };\n        this.tabs.every(function (tab, index) {\n          var $el = Object(util_[\"arrayFind\"])(_this.$parent.$refs.tabs || [], function (t) {\n            return t.id.replace('tab-', '') === tab.paneName;\n          });\n          if (!$el) {\n            return false;\n          }\n\n          if (!tab.active) {\n            offset += $el['client' + firstUpperCase(sizeName)];\n            return true;\n          } else {\n            tabSize = $el['client' + firstUpperCase(sizeName)];\n            var tabStyles = window.getComputedStyle($el);\n            if (sizeName === 'width' && _this.tabs.length > 1) {\n              tabSize -= parseFloat(tabStyles.paddingLeft) + parseFloat(tabStyles.paddingRight);\n            }\n            if (sizeName === 'width') {\n              offset += parseFloat(tabStyles.paddingLeft);\n            }\n            return false;\n          }\n        });\n\n        var transform = 'translate' + firstUpperCase(sizeDir) + '(' + offset + 'px)';\n        style[sizeName] = tabSize + 'px';\n        style.transform = transform;\n        style.msTransform = transform;\n        style.webkitTransform = transform;\n\n        return style;\n      }\n    }\n  }\n});\n// CONCATENATED MODULE: ./packages/tabs/src/tab-bar.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_tab_barvue_type_script_lang_js_ = (tab_barvue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/tabs/src/tab-bar.vue\n\n\n\n\n\n/* normalize component */\n\nvar tab_bar_component = normalizeComponent(\n  src_tab_barvue_type_script_lang_js_,\n  tab_barvue_type_template_id_2031f33a_render,\n  tab_barvue_type_template_id_2031f33a_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var tab_bar_api; }\ntab_bar_component.options.__file = \"packages/tabs/src/tab-bar.vue\"\n/* harmony default export */ var tab_bar = (tab_bar_component.exports);\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tabs/src/tab-nav.vue?vue&type=script&lang=js&\n\n\n\n\nfunction noop() {}\nvar tab_navvue_type_script_lang_js_firstUpperCase = function firstUpperCase(str) {\n  return str.toLowerCase().replace(/( |^)[a-z]/g, function (L) {\n    return L.toUpperCase();\n  });\n};\n\n/* harmony default export */ var tab_navvue_type_script_lang_js_ = ({\n  name: 'TabNav',\n\n  components: {\n    TabBar: tab_bar\n  },\n\n  inject: ['rootTabs'],\n\n  props: {\n    panes: Array,\n    currentName: String,\n    editable: Boolean,\n    onTabClick: {\n      type: Function,\n      default: noop\n    },\n    onTabRemove: {\n      type: Function,\n      default: noop\n    },\n    type: String,\n    stretch: Boolean\n  },\n\n  data: function data() {\n    return {\n      scrollable: false,\n      navOffset: 0,\n      isFocus: false,\n      focusable: true\n    };\n  },\n\n\n  computed: {\n    navStyle: function navStyle() {\n      var dir = ['top', 'bottom'].indexOf(this.rootTabs.tabPosition) !== -1 ? 'X' : 'Y';\n      return {\n        transform: 'translate' + dir + '(-' + this.navOffset + 'px)'\n      };\n    },\n    sizeName: function sizeName() {\n      return ['top', 'bottom'].indexOf(this.rootTabs.tabPosition) !== -1 ? 'width' : 'height';\n    }\n  },\n\n  methods: {\n    scrollPrev: function scrollPrev() {\n      var containerSize = this.$refs.navScroll['offset' + tab_navvue_type_script_lang_js_firstUpperCase(this.sizeName)];\n      var currentOffset = this.navOffset;\n\n      if (!currentOffset) return;\n\n      var newOffset = currentOffset > containerSize ? currentOffset - containerSize : 0;\n\n      this.navOffset = newOffset;\n    },\n    scrollNext: function scrollNext() {\n      var navSize = this.$refs.nav['offset' + tab_navvue_type_script_lang_js_firstUpperCase(this.sizeName)];\n      var containerSize = this.$refs.navScroll['offset' + tab_navvue_type_script_lang_js_firstUpperCase(this.sizeName)];\n      var currentOffset = this.navOffset;\n\n      if (navSize - currentOffset <= containerSize) return;\n\n      var newOffset = navSize - currentOffset > containerSize * 2 ? currentOffset + containerSize : navSize - containerSize;\n\n      this.navOffset = newOffset;\n    },\n    scrollToActiveTab: function scrollToActiveTab() {\n      if (!this.scrollable) return;\n      var nav = this.$refs.nav;\n      var activeTab = this.$el.querySelector('.is-active');\n      if (!activeTab) return;\n      var navScroll = this.$refs.navScroll;\n      var isHorizontal = ['top', 'bottom'].indexOf(this.rootTabs.tabPosition) !== -1;\n      var activeTabBounding = activeTab.getBoundingClientRect();\n      var navScrollBounding = navScroll.getBoundingClientRect();\n      var maxOffset = isHorizontal ? nav.offsetWidth - navScrollBounding.width : nav.offsetHeight - navScrollBounding.height;\n      var currentOffset = this.navOffset;\n      var newOffset = currentOffset;\n\n      if (isHorizontal) {\n        if (activeTabBounding.left < navScrollBounding.left) {\n          newOffset = currentOffset - (navScrollBounding.left - activeTabBounding.left);\n        }\n        if (activeTabBounding.right > navScrollBounding.right) {\n          newOffset = currentOffset + activeTabBounding.right - navScrollBounding.right;\n        }\n      } else {\n        if (activeTabBounding.top < navScrollBounding.top) {\n          newOffset = currentOffset - (navScrollBounding.top - activeTabBounding.top);\n        }\n        if (activeTabBounding.bottom > navScrollBounding.bottom) {\n          newOffset = currentOffset + (activeTabBounding.bottom - navScrollBounding.bottom);\n        }\n      }\n      newOffset = Math.max(newOffset, 0);\n      this.navOffset = Math.min(newOffset, maxOffset);\n    },\n    update: function update() {\n      if (!this.$refs.nav) return;\n      var sizeName = this.sizeName;\n      var navSize = this.$refs.nav['offset' + tab_navvue_type_script_lang_js_firstUpperCase(sizeName)];\n      var containerSize = this.$refs.navScroll['offset' + tab_navvue_type_script_lang_js_firstUpperCase(sizeName)];\n      var currentOffset = this.navOffset;\n\n      if (containerSize < navSize) {\n        var _currentOffset = this.navOffset;\n        this.scrollable = this.scrollable || {};\n        this.scrollable.prev = _currentOffset;\n        this.scrollable.next = _currentOffset + containerSize < navSize;\n        if (navSize - _currentOffset < containerSize) {\n          this.navOffset = navSize - containerSize;\n        }\n      } else {\n        this.scrollable = false;\n        if (currentOffset > 0) {\n          this.navOffset = 0;\n        }\n      }\n    },\n    changeTab: function changeTab(e) {\n      var keyCode = e.keyCode;\n      var nextIndex = void 0;\n      var currentIndex = void 0,\n          tabList = void 0;\n      if ([37, 38, 39, 40].indexOf(keyCode) !== -1) {\n        // 左右上下键更换tab\n        tabList = e.currentTarget.querySelectorAll('[role=tab]');\n        currentIndex = Array.prototype.indexOf.call(tabList, e.target);\n      } else {\n        return;\n      }\n      if (keyCode === 37 || keyCode === 38) {\n        // left\n        if (currentIndex === 0) {\n          // first\n          nextIndex = tabList.length - 1;\n        } else {\n          nextIndex = currentIndex - 1;\n        }\n      } else {\n        // right\n        if (currentIndex < tabList.length - 1) {\n          // not last\n          nextIndex = currentIndex + 1;\n        } else {\n          nextIndex = 0;\n        }\n      }\n      tabList[nextIndex].focus(); // 改变焦点元素\n      tabList[nextIndex].click(); // 选中下一个tab\n      this.setFocus();\n    },\n    setFocus: function setFocus() {\n      if (this.focusable) {\n        this.isFocus = true;\n      }\n    },\n    removeFocus: function removeFocus() {\n      this.isFocus = false;\n    },\n    visibilityChangeHandler: function visibilityChangeHandler() {\n      var _this = this;\n\n      var visibility = document.visibilityState;\n      if (visibility === 'hidden') {\n        this.focusable = false;\n      } else if (visibility === 'visible') {\n        setTimeout(function () {\n          _this.focusable = true;\n        }, 50);\n      }\n    },\n    windowBlurHandler: function windowBlurHandler() {\n      this.focusable = false;\n    },\n    windowFocusHandler: function windowFocusHandler() {\n      var _this2 = this;\n\n      setTimeout(function () {\n        _this2.focusable = true;\n      }, 50);\n    }\n  },\n\n  updated: function updated() {\n    this.update();\n  },\n  render: function render(h) {\n    var _this3 = this;\n\n    var type = this.type,\n        panes = this.panes,\n        editable = this.editable,\n        stretch = this.stretch,\n        onTabClick = this.onTabClick,\n        onTabRemove = this.onTabRemove,\n        navStyle = this.navStyle,\n        scrollable = this.scrollable,\n        scrollNext = this.scrollNext,\n        scrollPrev = this.scrollPrev,\n        changeTab = this.changeTab,\n        setFocus = this.setFocus,\n        removeFocus = this.removeFocus;\n\n    var scrollBtn = scrollable ? [h(\n      'span',\n      { 'class': ['el-tabs__nav-prev', scrollable.prev ? '' : 'is-disabled'], on: {\n          'click': scrollPrev\n        }\n      },\n      [h('i', { 'class': 'el-icon-arrow-left' })]\n    ), h(\n      'span',\n      { 'class': ['el-tabs__nav-next', scrollable.next ? '' : 'is-disabled'], on: {\n          'click': scrollNext\n        }\n      },\n      [h('i', { 'class': 'el-icon-arrow-right' })]\n    )] : null;\n\n    var tabs = this._l(panes, function (pane, index) {\n      var _ref;\n\n      var tabName = pane.name || pane.index || index;\n      var closable = pane.isClosable || editable;\n\n      pane.index = '' + index;\n\n      var btnClose = closable ? h('span', { 'class': 'el-icon-close', on: {\n          'click': function click(ev) {\n            onTabRemove(pane, ev);\n          }\n        }\n      }) : null;\n\n      var tabLabelContent = pane.$slots.label || pane.label;\n      var tabindex = pane.active ? 0 : -1;\n      return h(\n        'div',\n        {\n          'class': (_ref = {\n            'el-tabs__item': true\n          }, _ref['is-' + _this3.rootTabs.tabPosition] = true, _ref['is-active'] = pane.active, _ref['is-disabled'] = pane.disabled, _ref['is-closable'] = closable, _ref['is-focus'] = _this3.isFocus, _ref),\n          attrs: { id: 'tab-' + tabName,\n\n            'aria-controls': 'pane-' + tabName,\n            role: 'tab',\n            'aria-selected': pane.active,\n\n            tabindex: tabindex\n          },\n          key: 'tab-' + tabName, ref: 'tabs', refInFor: true,\n          on: {\n            'focus': function focus() {\n              setFocus();\n            },\n            'blur': function blur() {\n              removeFocus();\n            },\n            'click': function click(ev) {\n              removeFocus();onTabClick(pane, tabName, ev);\n            },\n            'keydown': function keydown(ev) {\n              if (closable && (ev.keyCode === 46 || ev.keyCode === 8)) {\n                onTabRemove(pane, ev);\n              }\n            }\n          }\n        },\n        [tabLabelContent, btnClose]\n      );\n    });\n    return h(\n      'div',\n      { 'class': ['el-tabs__nav-wrap', scrollable ? 'is-scrollable' : '', 'is-' + this.rootTabs.tabPosition] },\n      [scrollBtn, h(\n        'div',\n        { 'class': ['el-tabs__nav-scroll'], ref: 'navScroll' },\n        [h(\n          'div',\n          {\n            'class': ['el-tabs__nav', 'is-' + this.rootTabs.tabPosition, stretch && ['top', 'bottom'].indexOf(this.rootTabs.tabPosition) !== -1 ? 'is-stretch' : ''],\n            ref: 'nav',\n            style: navStyle,\n            attrs: { role: 'tablist'\n            },\n            on: {\n              'keydown': changeTab\n            }\n          },\n          [!type ? h('tab-bar', {\n            attrs: { tabs: panes }\n          }) : null, tabs]\n        )]\n      )]\n    );\n  },\n  mounted: function mounted() {\n    var _this4 = this;\n\n    Object(resize_event_[\"addResizeListener\"])(this.$el, this.update);\n    document.addEventListener('visibilitychange', this.visibilityChangeHandler);\n    window.addEventListener('blur', this.windowBlurHandler);\n    window.addEventListener('focus', this.windowFocusHandler);\n    setTimeout(function () {\n      _this4.scrollToActiveTab();\n    }, 0);\n  },\n  beforeDestroy: function beforeDestroy() {\n    if (this.$el && this.update) Object(resize_event_[\"removeResizeListener\"])(this.$el, this.update);\n    document.removeEventListener('visibilitychange', this.visibilityChangeHandler);\n    window.removeEventListener('blur', this.windowBlurHandler);\n    window.removeEventListener('focus', this.windowFocusHandler);\n  }\n});\n// CONCATENATED MODULE: ./packages/tabs/src/tab-nav.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_tab_navvue_type_script_lang_js_ = (tab_navvue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/tabs/src/tab-nav.vue\nvar tab_nav_render, tab_nav_staticRenderFns\n\n\n\n\n/* normalize component */\n\nvar tab_nav_component = normalizeComponent(\n  src_tab_navvue_type_script_lang_js_,\n  tab_nav_render,\n  tab_nav_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var tab_nav_api; }\ntab_nav_component.options.__file = \"packages/tabs/src/tab-nav.vue\"\n/* harmony default export */ var tab_nav = (tab_nav_component.exports);\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tabs/src/tabs.vue?vue&type=script&lang=js&\n\n\n\n/* harmony default export */ var tabsvue_type_script_lang_js_ = ({\n  name: 'ElTabs',\n\n  components: {\n    TabNav: tab_nav\n  },\n\n  props: {\n    type: String,\n    activeName: String,\n    closable: Boolean,\n    addable: Boolean,\n    value: {},\n    editable: Boolean,\n    tabPosition: {\n      type: String,\n      default: 'top'\n    },\n    beforeLeave: Function,\n    stretch: Boolean\n  },\n\n  provide: function provide() {\n    return {\n      rootTabs: this\n    };\n  },\n  data: function data() {\n    return {\n      currentName: this.value || this.activeName,\n      panes: []\n    };\n  },\n\n\n  watch: {\n    activeName: function activeName(value) {\n      this.setCurrentName(value);\n    },\n    value: function value(_value) {\n      this.setCurrentName(_value);\n    },\n    currentName: function currentName(value) {\n      var _this = this;\n\n      if (this.$refs.nav) {\n        this.$nextTick(function () {\n          _this.$refs.nav.$nextTick(function (_) {\n            _this.$refs.nav.scrollToActiveTab();\n          });\n        });\n      }\n    }\n  },\n\n  methods: {\n    calcPaneInstances: function calcPaneInstances() {\n      var _this2 = this;\n\n      var isForceUpdate = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n\n      if (this.$slots.default) {\n        var paneSlots = this.$slots.default.filter(function (vnode) {\n          return vnode.tag && vnode.componentOptions && vnode.componentOptions.Ctor.options.name === 'ElTabPane';\n        });\n        // update indeed\n        var panes = paneSlots.map(function (_ref) {\n          var componentInstance = _ref.componentInstance;\n          return componentInstance;\n        });\n        var panesChanged = !(panes.length === this.panes.length && panes.every(function (pane, index) {\n          return pane === _this2.panes[index];\n        }));\n        if (isForceUpdate || panesChanged) {\n          this.panes = panes;\n        }\n      } else if (this.panes.length !== 0) {\n        this.panes = [];\n      }\n    },\n    handleTabClick: function handleTabClick(tab, tabName, event) {\n      if (tab.disabled) return;\n      this.setCurrentName(tabName);\n      this.$emit('tab-click', tab, event);\n    },\n    handleTabRemove: function handleTabRemove(pane, ev) {\n      if (pane.disabled) return;\n      ev.stopPropagation();\n      this.$emit('edit', pane.name, 'remove');\n      this.$emit('tab-remove', pane.name);\n    },\n    handleTabAdd: function handleTabAdd() {\n      this.$emit('edit', null, 'add');\n      this.$emit('tab-add');\n    },\n    setCurrentName: function setCurrentName(value) {\n      var _this3 = this;\n\n      var changeCurrentName = function changeCurrentName() {\n        _this3.currentName = value;\n        _this3.$emit('input', value);\n      };\n      if (this.currentName !== value && this.beforeLeave) {\n        var before = this.beforeLeave(value, this.currentName);\n        if (before && before.then) {\n          before.then(function () {\n            changeCurrentName();\n            _this3.$refs.nav && _this3.$refs.nav.removeFocus();\n          }, function () {\n            // https://github.com/ElemeFE/element/pull/14816\n            // ignore promise rejection in `before-leave` hook\n          });\n        } else if (before !== false) {\n          changeCurrentName();\n        }\n      } else {\n        changeCurrentName();\n      }\n    }\n  },\n\n  render: function render(h) {\n    var _ref2;\n\n    var type = this.type,\n        handleTabClick = this.handleTabClick,\n        handleTabRemove = this.handleTabRemove,\n        handleTabAdd = this.handleTabAdd,\n        currentName = this.currentName,\n        panes = this.panes,\n        editable = this.editable,\n        addable = this.addable,\n        tabPosition = this.tabPosition,\n        stretch = this.stretch;\n\n\n    var newButton = editable || addable ? h(\n      'span',\n      {\n        'class': 'el-tabs__new-tab',\n        on: {\n          'click': handleTabAdd,\n          'keydown': function keydown(ev) {\n            if (ev.keyCode === 13) {\n              handleTabAdd();\n            }\n          }\n        },\n        attrs: {\n          tabindex: '0'\n        }\n      },\n      [h('i', { 'class': 'el-icon-plus' })]\n    ) : null;\n\n    var navData = {\n      props: {\n        currentName: currentName,\n        onTabClick: handleTabClick,\n        onTabRemove: handleTabRemove,\n        editable: editable,\n        type: type,\n        panes: panes,\n        stretch: stretch\n      },\n      ref: 'nav'\n    };\n    var header = h(\n      'div',\n      { 'class': ['el-tabs__header', 'is-' + tabPosition] },\n      [newButton, h('tab-nav', navData)]\n    );\n    var panels = h(\n      'div',\n      { 'class': 'el-tabs__content' },\n      [this.$slots.default]\n    );\n\n    return h(\n      'div',\n      { 'class': (_ref2 = {\n          'el-tabs': true,\n          'el-tabs--card': type === 'card'\n        }, _ref2['el-tabs--' + tabPosition] = true, _ref2['el-tabs--border-card'] = type === 'border-card', _ref2) },\n      [tabPosition !== 'bottom' ? [header, panels] : [panels, header]]\n    );\n  },\n  created: function created() {\n    if (!this.currentName) {\n      this.setCurrentName('0');\n    }\n\n    this.$on('tab-nav-update', this.calcPaneInstances.bind(null, true));\n  },\n  mounted: function mounted() {\n    this.calcPaneInstances();\n  },\n  updated: function updated() {\n    this.calcPaneInstances();\n  }\n});\n// CONCATENATED MODULE: ./packages/tabs/src/tabs.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_tabsvue_type_script_lang_js_ = (tabsvue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/tabs/src/tabs.vue\nvar tabs_render, tabs_staticRenderFns\n\n\n\n\n/* normalize component */\n\nvar tabs_component = normalizeComponent(\n  src_tabsvue_type_script_lang_js_,\n  tabs_render,\n  tabs_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var tabs_api; }\ntabs_component.options.__file = \"packages/tabs/src/tabs.vue\"\n/* harmony default export */ var tabs = (tabs_component.exports);\n// CONCATENATED MODULE: ./packages/tabs/index.js\n\n\n/* istanbul ignore next */\ntabs.install = function (Vue) {\n  Vue.component(tabs.name, tabs);\n};\n\n/* harmony default export */ var packages_tabs = (tabs);\n// CONCATENATED MODULE: ./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/vue-loader/lib??vue-loader-options!./packages/tabs/src/tab-pane.vue?vue&type=template&id=9145a070&\nvar tab_panevue_type_template_id_9145a070_render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  return !_vm.lazy || _vm.loaded || _vm.active\n    ? _c(\n        \"div\",\n        {\n          directives: [\n            {\n              name: \"show\",\n              rawName: \"v-show\",\n              value: _vm.active,\n              expression: \"active\"\n            }\n          ],\n          staticClass: \"el-tab-pane\",\n          attrs: {\n            role: \"tabpanel\",\n            \"aria-hidden\": !_vm.active,\n            id: \"pane-\" + _vm.paneName,\n            \"aria-labelledby\": \"tab-\" + _vm.paneName\n          }\n        },\n        [_vm._t(\"default\")],\n        2\n      )\n    : _vm._e()\n}\nvar tab_panevue_type_template_id_9145a070_staticRenderFns = []\ntab_panevue_type_template_id_9145a070_render._withStripped = true\n\n\n// CONCATENATED MODULE: ./packages/tabs/src/tab-pane.vue?vue&type=template&id=9145a070&\n\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tabs/src/tab-pane.vue?vue&type=script&lang=js&\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n/* harmony default export */ var tab_panevue_type_script_lang_js_ = ({\n  name: 'ElTabPane',\n\n  componentName: 'ElTabPane',\n\n  props: {\n    label: String,\n    labelContent: Function,\n    name: String,\n    closable: Boolean,\n    disabled: Boolean,\n    lazy: Boolean\n  },\n\n  data: function data() {\n    return {\n      index: null,\n      loaded: false\n    };\n  },\n\n\n  computed: {\n    isClosable: function isClosable() {\n      return this.closable || this.$parent.closable;\n    },\n    active: function active() {\n      var active = this.$parent.currentName === (this.name || this.index);\n      if (active) {\n        this.loaded = true;\n      }\n      return active;\n    },\n    paneName: function paneName() {\n      return this.name || this.index;\n    }\n  },\n\n  updated: function updated() {\n    this.$parent.$emit('tab-nav-update');\n  }\n});\n// CONCATENATED MODULE: ./packages/tabs/src/tab-pane.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_tab_panevue_type_script_lang_js_ = (tab_panevue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/tabs/src/tab-pane.vue\n\n\n\n\n\n/* normalize component */\n\nvar tab_pane_component = normalizeComponent(\n  src_tab_panevue_type_script_lang_js_,\n  tab_panevue_type_template_id_9145a070_render,\n  tab_panevue_type_template_id_9145a070_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var tab_pane_api; }\ntab_pane_component.options.__file = \"packages/tabs/src/tab-pane.vue\"\n/* harmony default export */ var tab_pane = (tab_pane_component.exports);\n// CONCATENATED MODULE: ./packages/tab-pane/index.js\n\n\n/* istanbul ignore next */\ntab_pane.install = function (Vue) {\n  Vue.component(tab_pane.name, tab_pane);\n};\n\n/* harmony default export */ var packages_tab_pane = (tab_pane);\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tag/src/tag.vue?vue&type=script&lang=js&\n\n/* harmony default export */ var tagvue_type_script_lang_js_ = ({\n  name: 'ElTag',\n  props: {\n    text: String,\n    closable: Boolean,\n    type: String,\n    hit: Boolean,\n    disableTransitions: Boolean,\n    color: String,\n    size: String,\n    effect: {\n      type: String,\n      default: 'light',\n      validator: function validator(val) {\n        return ['dark', 'light', 'plain'].indexOf(val) !== -1;\n      }\n    }\n  },\n  methods: {\n    handleClose: function handleClose(event) {\n      event.stopPropagation();\n      this.$emit('close', event);\n    },\n    handleClick: function handleClick(event) {\n      this.$emit('click', event);\n    }\n  },\n  computed: {\n    tagSize: function tagSize() {\n      return this.size || (this.$ELEMENT || {}).size;\n    }\n  },\n  render: function render(h) {\n    var type = this.type,\n        tagSize = this.tagSize,\n        hit = this.hit,\n        effect = this.effect;\n\n    var classes = ['el-tag', type ? 'el-tag--' + type : '', tagSize ? 'el-tag--' + tagSize : '', effect ? 'el-tag--' + effect : '', hit && 'is-hit'];\n    var tagEl = h(\n      'span',\n      {\n        'class': classes,\n        style: { backgroundColor: this.color },\n        on: {\n          'click': this.handleClick\n        }\n      },\n      [this.$slots.default, this.closable && h('i', { 'class': 'el-tag__close el-icon-close', on: {\n          'click': this.handleClose\n        }\n      })]\n    );\n\n    return this.disableTransitions ? tagEl : h(\n      'transition',\n      {\n        attrs: { name: 'el-zoom-in-center' }\n      },\n      [tagEl]\n    );\n  }\n});\n// CONCATENATED MODULE: ./packages/tag/src/tag.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_tagvue_type_script_lang_js_ = (tagvue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/tag/src/tag.vue\nvar tag_render, tag_staticRenderFns\n\n\n\n\n/* normalize component */\n\nvar tag_component = normalizeComponent(\n  src_tagvue_type_script_lang_js_,\n  tag_render,\n  tag_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var tag_api; }\ntag_component.options.__file = \"packages/tag/src/tag.vue\"\n/* harmony default export */ var src_tag = (tag_component.exports);\n// CONCATENATED MODULE: ./packages/tag/index.js\n\n\n/* istanbul ignore next */\nsrc_tag.install = function (Vue) {\n  Vue.component(src_tag.name, src_tag);\n};\n\n/* harmony default export */ var packages_tag = (src_tag);\n// CONCATENATED MODULE: ./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/vue-loader/lib??vue-loader-options!./packages/tree/src/tree.vue?vue&type=template&id=547575a6&\nvar treevue_type_template_id_547575a6_render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  return _c(\n    \"div\",\n    {\n      staticClass: \"el-tree\",\n      class: {\n        \"el-tree--highlight-current\": _vm.highlightCurrent,\n        \"is-dragging\": !!_vm.dragState.draggingNode,\n        \"is-drop-not-allow\": !_vm.dragState.allowDrop,\n        \"is-drop-inner\": _vm.dragState.dropType === \"inner\"\n      },\n      attrs: { role: \"tree\" }\n    },\n    [\n      _vm._l(_vm.root.childNodes, function(child) {\n        return _c(\"el-tree-node\", {\n          key: _vm.getNodeKey(child),\n          attrs: {\n            node: child,\n            props: _vm.props,\n            \"render-after-expand\": _vm.renderAfterExpand,\n            \"show-checkbox\": _vm.showCheckbox,\n            \"render-content\": _vm.renderContent\n          },\n          on: { \"node-expand\": _vm.handleNodeExpand }\n        })\n      }),\n      _vm.isEmpty\n        ? _c(\"div\", { staticClass: \"el-tree__empty-block\" }, [\n            _c(\"span\", { staticClass: \"el-tree__empty-text\" }, [\n              _vm._v(_vm._s(_vm.emptyText))\n            ])\n          ])\n        : _vm._e(),\n      _c(\"div\", {\n        directives: [\n          {\n            name: \"show\",\n            rawName: \"v-show\",\n            value: _vm.dragState.showDropIndicator,\n            expression: \"dragState.showDropIndicator\"\n          }\n        ],\n        ref: \"dropIndicator\",\n        staticClass: \"el-tree__drop-indicator\"\n      })\n    ],\n    2\n  )\n}\nvar treevue_type_template_id_547575a6_staticRenderFns = []\ntreevue_type_template_id_547575a6_render._withStripped = true\n\n\n// CONCATENATED MODULE: ./packages/tree/src/tree.vue?vue&type=template&id=547575a6&\n\n// CONCATENATED MODULE: ./packages/tree/src/model/util.js\nvar NODE_KEY = '$treeNodeId';\n\nvar markNodeData = function markNodeData(node, data) {\n  if (!data || data[NODE_KEY]) return;\n  Object.defineProperty(data, NODE_KEY, {\n    value: node.id,\n    enumerable: false,\n    configurable: false,\n    writable: false\n  });\n};\n\nvar util_getNodeKey = function getNodeKey(key, data) {\n  if (!key) return data[NODE_KEY];\n  return data[key];\n};\n\nvar findNearestComponent = function findNearestComponent(element, componentName) {\n  var target = element;\n  while (target && target.tagName !== 'BODY') {\n    if (target.__vue__ && target.__vue__.$options.name === componentName) {\n      return target.__vue__;\n    }\n    target = target.parentNode;\n  }\n  return null;\n};\n// CONCATENATED MODULE: ./packages/tree/src/model/node.js\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction node_classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n\n\n\n\nvar getChildState = function getChildState(node) {\n  var all = true;\n  var none = true;\n  var allWithoutDisable = true;\n  for (var i = 0, j = node.length; i < j; i++) {\n    var n = node[i];\n    if (n.checked !== true || n.indeterminate) {\n      all = false;\n      if (!n.disabled) {\n        allWithoutDisable = false;\n      }\n    }\n    if (n.checked !== false || n.indeterminate) {\n      none = false;\n    }\n  }\n\n  return { all: all, none: none, allWithoutDisable: allWithoutDisable, half: !all && !none };\n};\n\nvar reInitChecked = function reInitChecked(node) {\n  if (node.childNodes.length === 0) return;\n\n  var _getChildState = getChildState(node.childNodes),\n      all = _getChildState.all,\n      none = _getChildState.none,\n      half = _getChildState.half;\n\n  if (all) {\n    node.checked = true;\n    node.indeterminate = false;\n  } else if (half) {\n    node.checked = false;\n    node.indeterminate = true;\n  } else if (none) {\n    node.checked = false;\n    node.indeterminate = false;\n  }\n\n  var parent = node.parent;\n  if (!parent || parent.level === 0) return;\n\n  if (!node.store.checkStrictly) {\n    reInitChecked(parent);\n  }\n};\n\nvar getPropertyFromData = function getPropertyFromData(node, prop) {\n  var props = node.store.props;\n  var data = node.data || {};\n  var config = props[prop];\n\n  if (typeof config === 'function') {\n    return config(data, node);\n  } else if (typeof config === 'string') {\n    return data[config];\n  } else if (typeof config === 'undefined') {\n    var dataProp = data[prop];\n    return dataProp === undefined ? '' : dataProp;\n  }\n};\n\nvar nodeIdSeed = 0;\n\nvar node_Node = function () {\n  function Node(options) {\n    node_classCallCheck(this, Node);\n\n    this.id = nodeIdSeed++;\n    this.text = null;\n    this.checked = false;\n    this.indeterminate = false;\n    this.data = null;\n    this.expanded = false;\n    this.parent = null;\n    this.visible = true;\n    this.isCurrent = false;\n\n    for (var name in options) {\n      if (options.hasOwnProperty(name)) {\n        this[name] = options[name];\n      }\n    }\n\n    // internal\n    this.level = 0;\n    this.loaded = false;\n    this.childNodes = [];\n    this.loading = false;\n\n    if (this.parent) {\n      this.level = this.parent.level + 1;\n    }\n\n    var store = this.store;\n    if (!store) {\n      throw new Error('[Node]store is required!');\n    }\n    store.registerNode(this);\n\n    var props = store.props;\n    if (props && typeof props.isLeaf !== 'undefined') {\n      var isLeaf = getPropertyFromData(this, 'isLeaf');\n      if (typeof isLeaf === 'boolean') {\n        this.isLeafByUser = isLeaf;\n      }\n    }\n\n    if (store.lazy !== true && this.data) {\n      this.setData(this.data);\n\n      if (store.defaultExpandAll) {\n        this.expanded = true;\n      }\n    } else if (this.level > 0 && store.lazy && store.defaultExpandAll) {\n      this.expand();\n    }\n    if (!Array.isArray(this.data)) {\n      markNodeData(this, this.data);\n    }\n    if (!this.data) return;\n    var defaultExpandedKeys = store.defaultExpandedKeys;\n    var key = store.key;\n    if (key && defaultExpandedKeys && defaultExpandedKeys.indexOf(this.key) !== -1) {\n      this.expand(null, store.autoExpandParent);\n    }\n\n    if (key && store.currentNodeKey !== undefined && this.key === store.currentNodeKey) {\n      store.currentNode = this;\n      store.currentNode.isCurrent = true;\n    }\n\n    if (store.lazy) {\n      store._initDefaultCheckedNode(this);\n    }\n\n    this.updateLeafState();\n  }\n\n  Node.prototype.setData = function setData(data) {\n    if (!Array.isArray(data)) {\n      markNodeData(this, data);\n    }\n\n    this.data = data;\n    this.childNodes = [];\n\n    var children = void 0;\n    if (this.level === 0 && this.data instanceof Array) {\n      children = this.data;\n    } else {\n      children = getPropertyFromData(this, 'children') || [];\n    }\n\n    for (var i = 0, j = children.length; i < j; i++) {\n      this.insertChild({ data: children[i] });\n    }\n  };\n\n  Node.prototype.contains = function contains(target) {\n    var deep = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n\n    var walk = function walk(parent) {\n      var children = parent.childNodes || [];\n      var result = false;\n      for (var i = 0, j = children.length; i < j; i++) {\n        var child = children[i];\n        if (child === target || deep && walk(child)) {\n          result = true;\n          break;\n        }\n      }\n      return result;\n    };\n\n    return walk(this);\n  };\n\n  Node.prototype.remove = function remove() {\n    var parent = this.parent;\n    if (parent) {\n      parent.removeChild(this);\n    }\n  };\n\n  Node.prototype.insertChild = function insertChild(child, index, batch) {\n    if (!child) throw new Error('insertChild error: child is required.');\n\n    if (!(child instanceof Node)) {\n      if (!batch) {\n        var children = this.getChildren(true) || [];\n        if (children.indexOf(child.data) === -1) {\n          if (typeof index === 'undefined' || index < 0) {\n            children.push(child.data);\n          } else {\n            children.splice(index, 0, child.data);\n          }\n        }\n      }\n      merge_default()(child, {\n        parent: this,\n        store: this.store\n      });\n      child = new Node(child);\n    }\n\n    child.level = this.level + 1;\n\n    if (typeof index === 'undefined' || index < 0) {\n      this.childNodes.push(child);\n    } else {\n      this.childNodes.splice(index, 0, child);\n    }\n\n    this.updateLeafState();\n  };\n\n  Node.prototype.insertBefore = function insertBefore(child, ref) {\n    var index = void 0;\n    if (ref) {\n      index = this.childNodes.indexOf(ref);\n    }\n    this.insertChild(child, index);\n  };\n\n  Node.prototype.insertAfter = function insertAfter(child, ref) {\n    var index = void 0;\n    if (ref) {\n      index = this.childNodes.indexOf(ref);\n      if (index !== -1) index += 1;\n    }\n    this.insertChild(child, index);\n  };\n\n  Node.prototype.removeChild = function removeChild(child) {\n    var children = this.getChildren() || [];\n    var dataIndex = children.indexOf(child.data);\n    if (dataIndex > -1) {\n      children.splice(dataIndex, 1);\n    }\n\n    var index = this.childNodes.indexOf(child);\n\n    if (index > -1) {\n      this.store && this.store.deregisterNode(child);\n      child.parent = null;\n      this.childNodes.splice(index, 1);\n    }\n\n    this.updateLeafState();\n  };\n\n  Node.prototype.removeChildByData = function removeChildByData(data) {\n    var targetNode = null;\n\n    for (var i = 0; i < this.childNodes.length; i++) {\n      if (this.childNodes[i].data === data) {\n        targetNode = this.childNodes[i];\n        break;\n      }\n    }\n\n    if (targetNode) {\n      this.removeChild(targetNode);\n    }\n  };\n\n  Node.prototype.expand = function expand(callback, expandParent) {\n    var _this = this;\n\n    var done = function done() {\n      if (expandParent) {\n        var parent = _this.parent;\n        while (parent.level > 0) {\n          parent.expanded = true;\n          parent = parent.parent;\n        }\n      }\n      _this.expanded = true;\n      if (callback) callback();\n    };\n\n    if (this.shouldLoadData()) {\n      this.loadData(function (data) {\n        if (data instanceof Array) {\n          if (_this.checked) {\n            _this.setChecked(true, true);\n          } else if (!_this.store.checkStrictly) {\n            reInitChecked(_this);\n          }\n          done();\n        }\n      });\n    } else {\n      done();\n    }\n  };\n\n  Node.prototype.doCreateChildren = function doCreateChildren(array) {\n    var _this2 = this;\n\n    var defaultProps = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    array.forEach(function (item) {\n      _this2.insertChild(merge_default()({ data: item }, defaultProps), undefined, true);\n    });\n  };\n\n  Node.prototype.collapse = function collapse() {\n    this.expanded = false;\n  };\n\n  Node.prototype.shouldLoadData = function shouldLoadData() {\n    return this.store.lazy === true && this.store.load && !this.loaded;\n  };\n\n  Node.prototype.updateLeafState = function updateLeafState() {\n    if (this.store.lazy === true && this.loaded !== true && typeof this.isLeafByUser !== 'undefined') {\n      this.isLeaf = this.isLeafByUser;\n      return;\n    }\n    var childNodes = this.childNodes;\n    if (!this.store.lazy || this.store.lazy === true && this.loaded === true) {\n      this.isLeaf = !childNodes || childNodes.length === 0;\n      return;\n    }\n    this.isLeaf = false;\n  };\n\n  Node.prototype.setChecked = function setChecked(value, deep, recursion, passValue) {\n    var _this3 = this;\n\n    this.indeterminate = value === 'half';\n    this.checked = value === true;\n\n    if (this.store.checkStrictly) return;\n\n    if (!(this.shouldLoadData() && !this.store.checkDescendants)) {\n      var _getChildState2 = getChildState(this.childNodes),\n          all = _getChildState2.all,\n          allWithoutDisable = _getChildState2.allWithoutDisable;\n\n      if (!this.isLeaf && !all && allWithoutDisable) {\n        this.checked = false;\n        value = false;\n      }\n\n      var handleDescendants = function handleDescendants() {\n        if (deep) {\n          var childNodes = _this3.childNodes;\n          for (var i = 0, j = childNodes.length; i < j; i++) {\n            var child = childNodes[i];\n            passValue = passValue || value !== false;\n            var isCheck = child.disabled ? child.checked : passValue;\n            child.setChecked(isCheck, deep, true, passValue);\n          }\n\n          var _getChildState3 = getChildState(childNodes),\n              half = _getChildState3.half,\n              _all = _getChildState3.all;\n\n          if (!_all) {\n            _this3.checked = _all;\n            _this3.indeterminate = half;\n          }\n        }\n      };\n\n      if (this.shouldLoadData()) {\n        // Only work on lazy load data.\n        this.loadData(function () {\n          handleDescendants();\n          reInitChecked(_this3);\n        }, {\n          checked: value !== false\n        });\n        return;\n      } else {\n        handleDescendants();\n      }\n    }\n\n    var parent = this.parent;\n    if (!parent || parent.level === 0) return;\n\n    if (!recursion) {\n      reInitChecked(parent);\n    }\n  };\n\n  Node.prototype.getChildren = function getChildren() {\n    var forceInit = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    // this is data\n    if (this.level === 0) return this.data;\n    var data = this.data;\n    if (!data) return null;\n\n    var props = this.store.props;\n    var children = 'children';\n    if (props) {\n      children = props.children || 'children';\n    }\n\n    if (data[children] === undefined) {\n      data[children] = null;\n    }\n\n    if (forceInit && !data[children]) {\n      data[children] = [];\n    }\n\n    return data[children];\n  };\n\n  Node.prototype.updateChildren = function updateChildren() {\n    var _this4 = this;\n\n    var newData = this.getChildren() || [];\n    var oldData = this.childNodes.map(function (node) {\n      return node.data;\n    });\n\n    var newDataMap = {};\n    var newNodes = [];\n\n    newData.forEach(function (item, index) {\n      var key = item[NODE_KEY];\n      var isNodeExists = !!key && Object(util_[\"arrayFindIndex\"])(oldData, function (data) {\n        return data[NODE_KEY] === key;\n      }) >= 0;\n      if (isNodeExists) {\n        newDataMap[key] = { index: index, data: item };\n      } else {\n        newNodes.push({ index: index, data: item });\n      }\n    });\n\n    if (!this.store.lazy) {\n      oldData.forEach(function (item) {\n        if (!newDataMap[item[NODE_KEY]]) _this4.removeChildByData(item);\n      });\n    }\n\n    newNodes.forEach(function (_ref) {\n      var index = _ref.index,\n          data = _ref.data;\n\n      _this4.insertChild({ data: data }, index);\n    });\n\n    this.updateLeafState();\n  };\n\n  Node.prototype.loadData = function loadData(callback) {\n    var _this5 = this;\n\n    var defaultProps = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    if (this.store.lazy === true && this.store.load && !this.loaded && (!this.loading || Object.keys(defaultProps).length)) {\n      this.loading = true;\n\n      var resolve = function resolve(children) {\n        _this5.loaded = true;\n        _this5.loading = false;\n        _this5.childNodes = [];\n\n        _this5.doCreateChildren(children, defaultProps);\n\n        _this5.updateLeafState();\n        if (callback) {\n          callback.call(_this5, children);\n        }\n      };\n\n      this.store.load(this, resolve);\n    } else {\n      if (callback) {\n        callback.call(this);\n      }\n    }\n  };\n\n  _createClass(Node, [{\n    key: 'label',\n    get: function get() {\n      return getPropertyFromData(this, 'label');\n    }\n  }, {\n    key: 'key',\n    get: function get() {\n      var nodeKey = this.store.key;\n      if (this.data) return this.data[nodeKey];\n      return null;\n    }\n  }, {\n    key: 'disabled',\n    get: function get() {\n      return getPropertyFromData(this, 'disabled');\n    }\n  }, {\n    key: 'nextSibling',\n    get: function get() {\n      var parent = this.parent;\n      if (parent) {\n        var index = parent.childNodes.indexOf(this);\n        if (index > -1) {\n          return parent.childNodes[index + 1];\n        }\n      }\n      return null;\n    }\n  }, {\n    key: 'previousSibling',\n    get: function get() {\n      var parent = this.parent;\n      if (parent) {\n        var index = parent.childNodes.indexOf(this);\n        if (index > -1) {\n          return index > 0 ? parent.childNodes[index - 1] : null;\n        }\n      }\n      return null;\n    }\n  }]);\n\n  return Node;\n}();\n\n/* harmony default export */ var model_node = (node_Node);\n// CONCATENATED MODULE: ./packages/tree/src/model/tree-store.js\nvar tree_store_typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nfunction tree_store_classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\n\n\n\nvar tree_store_TreeStore = function () {\n  function TreeStore(options) {\n    var _this = this;\n\n    tree_store_classCallCheck(this, TreeStore);\n\n    this.currentNode = null;\n    this.currentNodeKey = null;\n\n    for (var option in options) {\n      if (options.hasOwnProperty(option)) {\n        this[option] = options[option];\n      }\n    }\n\n    this.nodesMap = {};\n\n    this.root = new model_node({\n      data: this.data,\n      store: this\n    });\n\n    if (this.lazy && this.load) {\n      var loadFn = this.load;\n      loadFn(this.root, function (data) {\n        _this.root.doCreateChildren(data);\n        _this._initDefaultCheckedNodes();\n      });\n    } else {\n      this._initDefaultCheckedNodes();\n    }\n  }\n\n  TreeStore.prototype.filter = function filter(value) {\n    var filterNodeMethod = this.filterNodeMethod;\n    var lazy = this.lazy;\n    var traverse = function traverse(node) {\n      var childNodes = node.root ? node.root.childNodes : node.childNodes;\n\n      childNodes.forEach(function (child) {\n        child.visible = filterNodeMethod.call(child, value, child.data, child);\n\n        traverse(child);\n      });\n\n      if (!node.visible && childNodes.length) {\n        var allHidden = true;\n        allHidden = !childNodes.some(function (child) {\n          return child.visible;\n        });\n\n        if (node.root) {\n          node.root.visible = allHidden === false;\n        } else {\n          node.visible = allHidden === false;\n        }\n      }\n      if (!value) return;\n\n      if (node.visible && !node.isLeaf && !lazy) node.expand();\n    };\n\n    traverse(this);\n  };\n\n  TreeStore.prototype.setData = function setData(newVal) {\n    var instanceChanged = newVal !== this.root.data;\n    if (instanceChanged) {\n      this.root.setData(newVal);\n      this._initDefaultCheckedNodes();\n    } else {\n      this.root.updateChildren();\n    }\n  };\n\n  TreeStore.prototype.getNode = function getNode(data) {\n    if (data instanceof model_node) return data;\n    var key = (typeof data === 'undefined' ? 'undefined' : tree_store_typeof(data)) !== 'object' ? data : util_getNodeKey(this.key, data);\n    return this.nodesMap[key] || null;\n  };\n\n  TreeStore.prototype.insertBefore = function insertBefore(data, refData) {\n    var refNode = this.getNode(refData);\n    refNode.parent.insertBefore({ data: data }, refNode);\n  };\n\n  TreeStore.prototype.insertAfter = function insertAfter(data, refData) {\n    var refNode = this.getNode(refData);\n    refNode.parent.insertAfter({ data: data }, refNode);\n  };\n\n  TreeStore.prototype.remove = function remove(data) {\n    var node = this.getNode(data);\n\n    if (node && node.parent) {\n      if (node === this.currentNode) {\n        this.currentNode = null;\n      }\n      node.parent.removeChild(node);\n    }\n  };\n\n  TreeStore.prototype.append = function append(data, parentData) {\n    var parentNode = parentData ? this.getNode(parentData) : this.root;\n\n    if (parentNode) {\n      parentNode.insertChild({ data: data });\n    }\n  };\n\n  TreeStore.prototype._initDefaultCheckedNodes = function _initDefaultCheckedNodes() {\n    var _this2 = this;\n\n    var defaultCheckedKeys = this.defaultCheckedKeys || [];\n    var nodesMap = this.nodesMap;\n\n    defaultCheckedKeys.forEach(function (checkedKey) {\n      var node = nodesMap[checkedKey];\n\n      if (node) {\n        node.setChecked(true, !_this2.checkStrictly);\n      }\n    });\n  };\n\n  TreeStore.prototype._initDefaultCheckedNode = function _initDefaultCheckedNode(node) {\n    var defaultCheckedKeys = this.defaultCheckedKeys || [];\n\n    if (defaultCheckedKeys.indexOf(node.key) !== -1) {\n      node.setChecked(true, !this.checkStrictly);\n    }\n  };\n\n  TreeStore.prototype.setDefaultCheckedKey = function setDefaultCheckedKey(newVal) {\n    if (newVal !== this.defaultCheckedKeys) {\n      this.defaultCheckedKeys = newVal;\n      this._initDefaultCheckedNodes();\n    }\n  };\n\n  TreeStore.prototype.registerNode = function registerNode(node) {\n    var key = this.key;\n    if (!key || !node || !node.data) return;\n\n    var nodeKey = node.key;\n    if (nodeKey !== undefined) this.nodesMap[node.key] = node;\n  };\n\n  TreeStore.prototype.deregisterNode = function deregisterNode(node) {\n    var _this3 = this;\n\n    var key = this.key;\n    if (!key || !node || !node.data) return;\n\n    node.childNodes.forEach(function (child) {\n      _this3.deregisterNode(child);\n    });\n\n    delete this.nodesMap[node.key];\n  };\n\n  TreeStore.prototype.getCheckedNodes = function getCheckedNodes() {\n    var leafOnly = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    var includeHalfChecked = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n    var checkedNodes = [];\n    var traverse = function traverse(node) {\n      var childNodes = node.root ? node.root.childNodes : node.childNodes;\n\n      childNodes.forEach(function (child) {\n        if ((child.checked || includeHalfChecked && child.indeterminate) && (!leafOnly || leafOnly && child.isLeaf)) {\n          checkedNodes.push(child.data);\n        }\n\n        traverse(child);\n      });\n    };\n\n    traverse(this);\n\n    return checkedNodes;\n  };\n\n  TreeStore.prototype.getCheckedKeys = function getCheckedKeys() {\n    var _this4 = this;\n\n    var leafOnly = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n\n    return this.getCheckedNodes(leafOnly).map(function (data) {\n      return (data || {})[_this4.key];\n    });\n  };\n\n  TreeStore.prototype.getHalfCheckedNodes = function getHalfCheckedNodes() {\n    var nodes = [];\n    var traverse = function traverse(node) {\n      var childNodes = node.root ? node.root.childNodes : node.childNodes;\n\n      childNodes.forEach(function (child) {\n        if (child.indeterminate) {\n          nodes.push(child.data);\n        }\n\n        traverse(child);\n      });\n    };\n\n    traverse(this);\n\n    return nodes;\n  };\n\n  TreeStore.prototype.getHalfCheckedKeys = function getHalfCheckedKeys() {\n    var _this5 = this;\n\n    return this.getHalfCheckedNodes().map(function (data) {\n      return (data || {})[_this5.key];\n    });\n  };\n\n  TreeStore.prototype._getAllNodes = function _getAllNodes() {\n    var allNodes = [];\n    var nodesMap = this.nodesMap;\n    for (var nodeKey in nodesMap) {\n      if (nodesMap.hasOwnProperty(nodeKey)) {\n        allNodes.push(nodesMap[nodeKey]);\n      }\n    }\n\n    return allNodes;\n  };\n\n  TreeStore.prototype.updateChildren = function updateChildren(key, data) {\n    var node = this.nodesMap[key];\n    if (!node) return;\n    var childNodes = node.childNodes;\n    for (var i = childNodes.length - 1; i >= 0; i--) {\n      var child = childNodes[i];\n      this.remove(child.data);\n    }\n    for (var _i = 0, j = data.length; _i < j; _i++) {\n      var _child = data[_i];\n      this.append(_child, node.data);\n    }\n  };\n\n  TreeStore.prototype._setCheckedKeys = function _setCheckedKeys(key) {\n    var leafOnly = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    var checkedKeys = arguments[2];\n\n    var allNodes = this._getAllNodes().sort(function (a, b) {\n      return b.level - a.level;\n    });\n    var cache = Object.create(null);\n    var keys = Object.keys(checkedKeys);\n    allNodes.forEach(function (node) {\n      return node.setChecked(false, false);\n    });\n    for (var i = 0, j = allNodes.length; i < j; i++) {\n      var node = allNodes[i];\n      var nodeKey = node.data[key].toString();\n      var checked = keys.indexOf(nodeKey) > -1;\n      if (!checked) {\n        if (node.checked && !cache[nodeKey]) {\n          node.setChecked(false, false);\n        }\n        continue;\n      }\n\n      var parent = node.parent;\n      while (parent && parent.level > 0) {\n        cache[parent.data[key]] = true;\n        parent = parent.parent;\n      }\n\n      if (node.isLeaf || this.checkStrictly) {\n        node.setChecked(true, false);\n        continue;\n      }\n      node.setChecked(true, true);\n\n      if (leafOnly) {\n        (function () {\n          node.setChecked(false, false);\n          var traverse = function traverse(node) {\n            var childNodes = node.childNodes;\n            childNodes.forEach(function (child) {\n              if (!child.isLeaf) {\n                child.setChecked(false, false);\n              }\n              traverse(child);\n            });\n          };\n          traverse(node);\n        })();\n      }\n    }\n  };\n\n  TreeStore.prototype.setCheckedNodes = function setCheckedNodes(array) {\n    var leafOnly = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n    var key = this.key;\n    var checkedKeys = {};\n    array.forEach(function (item) {\n      checkedKeys[(item || {})[key]] = true;\n    });\n\n    this._setCheckedKeys(key, leafOnly, checkedKeys);\n  };\n\n  TreeStore.prototype.setCheckedKeys = function setCheckedKeys(keys) {\n    var leafOnly = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n\n    this.defaultCheckedKeys = keys;\n    var key = this.key;\n    var checkedKeys = {};\n    keys.forEach(function (key) {\n      checkedKeys[key] = true;\n    });\n\n    this._setCheckedKeys(key, leafOnly, checkedKeys);\n  };\n\n  TreeStore.prototype.setDefaultExpandedKeys = function setDefaultExpandedKeys(keys) {\n    var _this6 = this;\n\n    keys = keys || [];\n    this.defaultExpandedKeys = keys;\n\n    keys.forEach(function (key) {\n      var node = _this6.getNode(key);\n      if (node) node.expand(null, _this6.autoExpandParent);\n    });\n  };\n\n  TreeStore.prototype.setChecked = function setChecked(data, checked, deep) {\n    var node = this.getNode(data);\n\n    if (node) {\n      node.setChecked(!!checked, deep);\n    }\n  };\n\n  TreeStore.prototype.getCurrentNode = function getCurrentNode() {\n    return this.currentNode;\n  };\n\n  TreeStore.prototype.setCurrentNode = function setCurrentNode(currentNode) {\n    var prevCurrentNode = this.currentNode;\n    if (prevCurrentNode) {\n      prevCurrentNode.isCurrent = false;\n    }\n    this.currentNode = currentNode;\n    this.currentNode.isCurrent = true;\n  };\n\n  TreeStore.prototype.setUserCurrentNode = function setUserCurrentNode(node) {\n    var key = node[this.key];\n    var currNode = this.nodesMap[key];\n    this.setCurrentNode(currNode);\n  };\n\n  TreeStore.prototype.setCurrentNodeKey = function setCurrentNodeKey(key) {\n    if (key === null || key === undefined) {\n      this.currentNode && (this.currentNode.isCurrent = false);\n      this.currentNode = null;\n      return;\n    }\n    var node = this.getNode(key);\n    if (node) {\n      this.setCurrentNode(node);\n    }\n  };\n\n  return TreeStore;\n}();\n\n/* harmony default export */ var tree_store = (tree_store_TreeStore);\n;\n// CONCATENATED MODULE: ./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/vue-loader/lib??vue-loader-options!./packages/tree/src/tree-node.vue?vue&type=template&id=3ba3ef0e&\nvar tree_nodevue_type_template_id_3ba3ef0e_render = function() {\n  var this$1 = this\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  return _c(\n    \"div\",\n    {\n      directives: [\n        {\n          name: \"show\",\n          rawName: \"v-show\",\n          value: _vm.node.visible,\n          expression: \"node.visible\"\n        }\n      ],\n      ref: \"node\",\n      staticClass: \"el-tree-node\",\n      class: {\n        \"is-expanded\": _vm.expanded,\n        \"is-current\": _vm.node.isCurrent,\n        \"is-hidden\": !_vm.node.visible,\n        \"is-focusable\": !_vm.node.disabled,\n        \"is-checked\": !_vm.node.disabled && _vm.node.checked\n      },\n      attrs: {\n        role: \"treeitem\",\n        tabindex: \"-1\",\n        \"aria-expanded\": _vm.expanded,\n        \"aria-disabled\": _vm.node.disabled,\n        \"aria-checked\": _vm.node.checked,\n        draggable: _vm.tree.draggable\n      },\n      on: {\n        click: function($event) {\n          $event.stopPropagation()\n          return _vm.handleClick($event)\n        },\n        contextmenu: function($event) {\n          return this$1.handleContextMenu($event)\n        },\n        dragstart: function($event) {\n          $event.stopPropagation()\n          return _vm.handleDragStart($event)\n        },\n        dragover: function($event) {\n          $event.stopPropagation()\n          return _vm.handleDragOver($event)\n        },\n        dragend: function($event) {\n          $event.stopPropagation()\n          return _vm.handleDragEnd($event)\n        },\n        drop: function($event) {\n          $event.stopPropagation()\n          return _vm.handleDrop($event)\n        }\n      }\n    },\n    [\n      _c(\n        \"div\",\n        {\n          staticClass: \"el-tree-node__content\",\n          style: {\n            \"padding-left\": (_vm.node.level - 1) * _vm.tree.indent + \"px\"\n          }\n        },\n        [\n          _c(\"span\", {\n            class: [\n              {\n                \"is-leaf\": _vm.node.isLeaf,\n                expanded: !_vm.node.isLeaf && _vm.expanded\n              },\n              \"el-tree-node__expand-icon\",\n              _vm.tree.iconClass ? _vm.tree.iconClass : \"el-icon-caret-right\"\n            ],\n            on: {\n              click: function($event) {\n                $event.stopPropagation()\n                return _vm.handleExpandIconClick($event)\n              }\n            }\n          }),\n          _vm.showCheckbox\n            ? _c(\"el-checkbox\", {\n                attrs: {\n                  indeterminate: _vm.node.indeterminate,\n                  disabled: !!_vm.node.disabled\n                },\n                on: { change: _vm.handleCheckChange },\n                nativeOn: {\n                  click: function($event) {\n                    $event.stopPropagation()\n                  }\n                },\n                model: {\n                  value: _vm.node.checked,\n                  callback: function($$v) {\n                    _vm.$set(_vm.node, \"checked\", $$v)\n                  },\n                  expression: \"node.checked\"\n                }\n              })\n            : _vm._e(),\n          _vm.node.loading\n            ? _c(\"span\", {\n                staticClass: \"el-tree-node__loading-icon el-icon-loading\"\n              })\n            : _vm._e(),\n          _c(\"node-content\", { attrs: { node: _vm.node } })\n        ],\n        1\n      ),\n      _c(\"el-collapse-transition\", [\n        !_vm.renderAfterExpand || _vm.childNodeRendered\n          ? _c(\n              \"div\",\n              {\n                directives: [\n                  {\n                    name: \"show\",\n                    rawName: \"v-show\",\n                    value: _vm.expanded,\n                    expression: \"expanded\"\n                  }\n                ],\n                staticClass: \"el-tree-node__children\",\n                attrs: { role: \"group\", \"aria-expanded\": _vm.expanded }\n              },\n              _vm._l(_vm.node.childNodes, function(child) {\n                return _c(\"el-tree-node\", {\n                  key: _vm.getNodeKey(child),\n                  attrs: {\n                    \"render-content\": _vm.renderContent,\n                    \"render-after-expand\": _vm.renderAfterExpand,\n                    \"show-checkbox\": _vm.showCheckbox,\n                    node: child\n                  },\n                  on: { \"node-expand\": _vm.handleChildNodeExpand }\n                })\n              }),\n              1\n            )\n          : _vm._e()\n      ])\n    ],\n    1\n  )\n}\nvar tree_nodevue_type_template_id_3ba3ef0e_staticRenderFns = []\ntree_nodevue_type_template_id_3ba3ef0e_render._withStripped = true\n\n\n// CONCATENATED MODULE: ./packages/tree/src/tree-node.vue?vue&type=template&id=3ba3ef0e&\n\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tree/src/tree-node.vue?vue&type=script&lang=js&\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n\n\n\n\n\n/* harmony default export */ var tree_nodevue_type_script_lang_js_ = ({\n  name: 'ElTreeNode',\n\n  componentName: 'ElTreeNode',\n\n  mixins: [emitter_default.a],\n\n  props: {\n    node: {\n      default: function _default() {\n        return {};\n      }\n    },\n    props: {},\n    renderContent: Function,\n    renderAfterExpand: {\n      type: Boolean,\n      default: true\n    },\n    showCheckbox: {\n      type: Boolean,\n      default: false\n    }\n  },\n\n  components: {\n    ElCollapseTransition: collapse_transition_default.a,\n    ElCheckbox: checkbox_default.a,\n    NodeContent: {\n      props: {\n        node: {\n          required: true\n        }\n      },\n      render: function render(h) {\n        var parent = this.$parent;\n        var tree = parent.tree;\n        var node = this.node;\n        var data = node.data,\n            store = node.store;\n\n        return parent.renderContent ? parent.renderContent.call(parent._renderProxy, h, { _self: tree.$vnode.context, node: node, data: data, store: store }) : tree.$scopedSlots.default ? tree.$scopedSlots.default({ node: node, data: data }) : h(\n          'span',\n          { 'class': 'el-tree-node__label' },\n          [node.label]\n        );\n      }\n    }\n  },\n\n  data: function data() {\n    return {\n      tree: null,\n      expanded: false,\n      childNodeRendered: false,\n      oldChecked: null,\n      oldIndeterminate: null\n    };\n  },\n\n\n  watch: {\n    'node.indeterminate': function nodeIndeterminate(val) {\n      this.handleSelectChange(this.node.checked, val);\n    },\n    'node.checked': function nodeChecked(val) {\n      this.handleSelectChange(val, this.node.indeterminate);\n    },\n    'node.expanded': function nodeExpanded(val) {\n      var _this = this;\n\n      this.$nextTick(function () {\n        return _this.expanded = val;\n      });\n      if (val) {\n        this.childNodeRendered = true;\n      }\n    }\n  },\n\n  methods: {\n    getNodeKey: function getNodeKey(node) {\n      return util_getNodeKey(this.tree.nodeKey, node.data);\n    },\n    handleSelectChange: function handleSelectChange(checked, indeterminate) {\n      if (this.oldChecked !== checked && this.oldIndeterminate !== indeterminate) {\n        this.tree.$emit('check-change', this.node.data, checked, indeterminate);\n      }\n      this.oldChecked = checked;\n      this.indeterminate = indeterminate;\n    },\n    handleClick: function handleClick() {\n      var store = this.tree.store;\n      store.setCurrentNode(this.node);\n      this.tree.$emit('current-change', store.currentNode ? store.currentNode.data : null, store.currentNode);\n      this.tree.currentNode = this;\n      if (this.tree.expandOnClickNode) {\n        this.handleExpandIconClick();\n      }\n      if (this.tree.checkOnClickNode && !this.node.disabled) {\n        this.handleCheckChange(null, {\n          target: { checked: !this.node.checked }\n        });\n      }\n      this.tree.$emit('node-click', this.node.data, this.node, this);\n    },\n    handleContextMenu: function handleContextMenu(event) {\n      if (this.tree._events['node-contextmenu'] && this.tree._events['node-contextmenu'].length > 0) {\n        event.stopPropagation();\n        event.preventDefault();\n      }\n      this.tree.$emit('node-contextmenu', event, this.node.data, this.node, this);\n    },\n    handleExpandIconClick: function handleExpandIconClick() {\n      if (this.node.isLeaf) return;\n      if (this.expanded) {\n        this.tree.$emit('node-collapse', this.node.data, this.node, this);\n        this.node.collapse();\n      } else {\n        this.node.expand();\n        this.$emit('node-expand', this.node.data, this.node, this);\n      }\n    },\n    handleCheckChange: function handleCheckChange(value, ev) {\n      var _this2 = this;\n\n      this.node.setChecked(ev.target.checked, !this.tree.checkStrictly);\n      this.$nextTick(function () {\n        var store = _this2.tree.store;\n        _this2.tree.$emit('check', _this2.node.data, {\n          checkedNodes: store.getCheckedNodes(),\n          checkedKeys: store.getCheckedKeys(),\n          halfCheckedNodes: store.getHalfCheckedNodes(),\n          halfCheckedKeys: store.getHalfCheckedKeys()\n        });\n      });\n    },\n    handleChildNodeExpand: function handleChildNodeExpand(nodeData, node, instance) {\n      this.broadcast('ElTreeNode', 'tree-node-expand', node);\n      this.tree.$emit('node-expand', nodeData, node, instance);\n    },\n    handleDragStart: function handleDragStart(event) {\n      if (!this.tree.draggable) return;\n      this.tree.$emit('tree-node-drag-start', event, this);\n    },\n    handleDragOver: function handleDragOver(event) {\n      if (!this.tree.draggable) return;\n      this.tree.$emit('tree-node-drag-over', event, this);\n      event.preventDefault();\n    },\n    handleDrop: function handleDrop(event) {\n      event.preventDefault();\n    },\n    handleDragEnd: function handleDragEnd(event) {\n      if (!this.tree.draggable) return;\n      this.tree.$emit('tree-node-drag-end', event, this);\n    }\n  },\n\n  created: function created() {\n    var _this3 = this;\n\n    var parent = this.$parent;\n\n    if (parent.isTree) {\n      this.tree = parent;\n    } else {\n      this.tree = parent.tree;\n    }\n\n    var tree = this.tree;\n    if (!tree) {\n      console.warn('Can not find node\\'s tree.');\n    }\n\n    var props = tree.props || {};\n    var childrenKey = props['children'] || 'children';\n\n    this.$watch('node.data.' + childrenKey, function () {\n      _this3.node.updateChildren();\n    });\n\n    if (this.node.expanded) {\n      this.expanded = true;\n      this.childNodeRendered = true;\n    }\n\n    if (this.tree.accordion) {\n      this.$on('tree-node-expand', function (node) {\n        if (_this3.node !== node) {\n          _this3.node.collapse();\n        }\n      });\n    }\n  }\n});\n// CONCATENATED MODULE: ./packages/tree/src/tree-node.vue?vue&type=script&lang=js&\n /* harmony default export */ var src_tree_nodevue_type_script_lang_js_ = (tree_nodevue_type_script_lang_js_); \n// CONCATENATED MODULE: ./packages/tree/src/tree-node.vue\n\n\n\n\n\n/* normalize component */\n\nvar tree_node_component = normalizeComponent(\n  src_tree_nodevue_type_script_lang_js_,\n  tree_nodevue_type_template_id_3ba3ef0e_render,\n  tree_nodevue_type_template_id_3ba3ef0e_staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (false) { var tree_node_api; }\ntree_node_component.options.__file = \"packages/tree/src/tree-node.vue\"\n/* harmony default export */ var tree_node = (tree_node_component.exports);\n// CONCATENATED MODULE: ./node_modules/babel-loader/lib!./node_modules/vue-loader/lib??vue-loader-options!./packages/tree/src/tree.vue?vue&type=script&lang=js&\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\n\n\n\n\n\n\n\n/* harmony default export */ var treevue_type_script_lang_js_ = ({\n  name: 'ElTree',\n\n  mixins: [emitter_default.a],\n\n  components: {\n    ElTreeNode: tree_node\n  },\n\n  data: function data() {\n    return {\n      store: null,\n      root: null,\n      currentNode: null,\n      treeItems: null,\n      checkboxItems: [],\n      dragState: {\n        showDropIndicato